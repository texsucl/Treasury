@using FAP.Web.Enum;
@using FAP.Web.Utilitys;
@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;

    var opScope = ViewBag.opScope;
}
<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <form id="OAP0021_Form">
                    <table>
                        <tr>
                            <td width="100px">
                                <label>申請日期 : </label>
                            </td>
                            <td >
                                <input id="OAP0021_APPLY_s" name="OAP0021_APPLY_s" type="text">
                                ~
                                <input id="OAP0021_APPLY_e" name="OAP0021_APPLY_e" type="text">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label>申請單號 : </label>
                            </td>
                            <td>
                                <input type="text" id="OAP0021_apply_no"/>
                            </td>
                            @*<td>
                                <label>申請人員 : </label>
                            </td>
                            <td>
                                <input type="text" id="OAP0021_apply_id" />
                            </td>*@
                        </tr>
                        <tr>
                            <td>
                                <label>申請人員 : </label>
                            </td>
                            <td>
                                <input type="text" id="OAP0021_apply_id" />
                            </td>
                        </tr>
                    </table>
                </form>
                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="button" class="btn btn-primary" id="OAP0021_Search" value="查詢" />
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="row" style="padding-left:10px">
        <div id="OAP0021jqgridDiv" class="jqd" style="padding-bottom:5px;">
        </div>
    </div>
    <div id="OAP0021OpenSearchDialog" style="display:none;" role="dialog" class="myDialog">
        <div id="OAP0021OpenSearchDetail"></div>
    </div>
</div>



<script type="text/javascript">
    $(function () {

        var OAP0021url = {};
        OAP0021url.getData = '@Url.Action("GetCacheData", "OAP0021")';
        OAP0021url.deleteCheckNo = '@Url.Action("deleteCheckNo", "OAP0021")';
        OAP0021url.addCheckNo = '@Url.Action("addCheckNo", "OAP0021")';
        OAP0021url.Detail = '@Url.Action("Detail", "OAP0021")';
        OAP0021url.qryOAP0021 = '@Url.Action("qryOAP0021", "OAP0021")';


        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');
        }


        $('#OAP0021_APPLY_s').datepicker({
            //dateFormat: 'yyyy-mm'
        });

        $('#OAP0021_APPLY_e').datepicker({
            //dateFormat: 'yyyy-mm'
        });

        //#region 註冊事件
        $('input:button').each(function () {
            var id = $(this).attr('id');
            switch (id) {
                case 'OAP0021_Search':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { OAP0021_SearchFun(); });
                    break;
            }
        });

        function OAP0021_SearchFun() {
            jqgridCustom.clearJqgrid('OAP0021jqgridDiv');
            $('#validationSummary').children().remove();
            var validationSummary = $('#validationSummary ul.validation-summary-errors');
            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            $.blockUI(); //畫面鎖起來
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    searchModel : OAP0021SearchModel(
                        $('#OAP0021_APPLY_s').val(),
                        $('#OAP0021_APPLY_e').val(),
                        $('#OAP0021_apply_no').val(),
                        $('#OAP0021_apply_id').val()
                        )
                }),
                dataType: "json",
                url: OAP0021url.qryOAP0021,
                contentType: 'application/json',
            }).done(function (result) {
                if (result.RETURN_FLAG) {
                    OAP0021Data();
                }
                else {
                    validationSummary.append('<li>' + result.DESCRIPTION + '</li>');
                }
                $.unblockUI(); //畫面打開
            });
        }

        function formatterOAP0021apply_no(cellvalue, options, rdata) {
            return "<a href='#' class='openDialog DialogAPPLYNO' style='text-decoration:underline; color:blue;' return:false; id='" + options.gid + "APPLYNO" + options.rowId + "'  name='" + cellvalue + "' title='" + cellvalue + "' >" + cellvalue + "</a>";
        }

        function UnformatterOAP0021apply_no(cellvalue, options, rdata) {
            return cellvalue;
        }

        function OAP0021Data() {
            var colNameArray = ['申請單號', '申請日', '申請人員', '申請部門'];
            var colModelArray = [];
            colModelArray.push({ name: "apply_no", index: "apply_no", width: 200, sortable: false, formatter: formatterOAP0021apply_no, unformat: UnformatterOAP0021apply_no });
            colModelArray.push({ name: "apply_date", index: "apply_date", width: 100, sortable: false });
            colModelArray.push({ name: "apply_id_D", index: "apply_id_D", width: 100, sortable: false });
            colModelArray.push({ name: "apply_dep_D", index: "apply_dep_D", width: 300, sortable: false });
            jqgridCustom.createJqgridByCache(
                'OAP0021jqgridDiv',
                'OAP0021TempList',
                'OAP0021TempPeger',
                OAP0021url.getData,
                {
                    type: "OAP0021ViewData"
                },
                colNameArray,
                colModelArray,
                '應付票據變更接收作業',
                jqgridCustom.getPage('OAP0021jqgridDiv'),
                jqgridCustom.getRowNum('OAP0021jqgridDiv'),
                OAP0021TempCompleteFun,
                true
                );
        }

        function OAP0021TempCompleteFun(listId)
        {
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                //申請單號
                $(this).find('td').find('a.DialogAPPLYNO').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        OAP0021OpenAPPLYNOFun(listId, i + 1);
                    });
                });
            });
        }

        function openOAP0021DetailDialog(title, width, dialogId) {
            title = title || '';
            width = width || 'auto';
            title += '明細';
            $('#' + dialogId).dialog({
                position: { my: "top", at: "center top", of: window },
                title: title,
                width: width,
                autoOpen: false,
                resizable: false,
                maxHeight: 800,
                closeText: '取消',
                close: function () {
                    OAP0021Data();
                }
            });
            $('#' + dialogId).dialog('open');
        }

        function OAP0021OpenAPPLYNOFun(listId, rowid)
        {
            var data = $("#" + listId).getRowData(rowid);
            $.blockUI(); //畫面鎖起來
            $.ajax({
                type: 'POST',
                data: JSON.stringify({
                    apply_no: data.apply_no,
                    action: '@Ref.ActionType.Edit.ToString()'
                }),
                dataType: 'html',
                url: OAP0021url.Detail,
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    $('#OAP0021OpenSearchDetail').html(data);
                    $.unblockUI(); //畫面打開
                    openOAP0021DetailDialog('應付票據變更接收', '1020px', 'OAP0021OpenSearchDialog');
                }
            })
        }

        function OAP0021SearchModel(
        apply_date_s,
        apply_date_e,
        apply_no,
        apply_id
        ) {
            var obj = {};
            obj['apply_date_s'] = apply_date_s;
            obj['apply_date_e'] = apply_date_e;
            obj['apply_no'] = apply_no;
            obj['apply_id'] = apply_id;
            return obj;
        }
    });
</script>


