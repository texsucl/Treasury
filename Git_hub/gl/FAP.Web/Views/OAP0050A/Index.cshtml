@model FAP.Web.ViewModels.OAP0050Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;
    var opScope = ViewBag.opScope;

}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {


                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="button" id="btnSave" name="btnSave" value="確認" class="btn btn-primary" />
                    </div>
                </div>
                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }



        </div>
    </div>

</div>


<div class="modal fade" id="modal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-left:10px">
        <div class="modal-content" style="width:850px;position:relative;left:10px">
            <!-- Modal Header -->
            <!-- Modal Body -->
            <div class="modal-body">
                <form class="form-horizontal" role="form" onsubmit="return false">

                    <table>
                        <tr>
                            <td>覆核單號：<input type="text" id="iKey" style="width:200px" disabled /></td>

                        </tr>


                    </table>
                    <div id="qryResultCheck" >
                        <table id="gridCheck"></table>
                        <div id="pagerCheck"></div>
                    </div>

                    <button type="button" id="btnCheckSave" class="btn btn-primary">確定</button>

                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">




    var $grid = $("#grid"), recList = [], ckRec = function (rowId) {

        var valueRec = $('#grid').jqGrid('getCell', rowId, 'rec');
        var valueRtn = $('#grid').jqGrid('getCell', rowId, 'rtn');
        var index = $.inArray(rowId, recList);

        if (valueRec == "True" && valueRtn == "True") {
            $("#grid").jqGrid("setCell", rowId, "rec", "False");
            alert("不可同時勾選 核可 與 駁回!!");
        } else {

            if (valueRec == "True")
                recList.push(rowId);
            else if (index >= 0)
                recList.splice(index, 1);

        }
    };


    var $grid = $("#grid"), rtnList = [], ckRtn = function (rowId) {

        var valueRec = $('#grid').jqGrid('getCell', rowId, 'rec');
        var valueRtn = $('#grid').jqGrid('getCell', rowId, 'rtn');
        var index = $.inArray(rowId, rtnList);


        if (valueRec == "True" && valueRtn == "True") {
            $("#grid").jqGrid("setCell", rowId, "rtn", "False");
            alert("不可同時勾選 核可 與 駁回!!");
        } else {
            if (valueRtn == "True")
                rtnList.push(rowId);
            else if (index >= 0)
                rtnList.splice(index, 1);

        }
    }


    //支票明細-取消
    $("#btnCheckSave").on("click", function () {
        $('#modal').modal('hide');

    });

        //開啟支票明細的畫面
        function qryCheckFunction(rowid) {


            var rowData = jQuery("#grid").jqGrid("getRowData", rowid);
            var aply_no = rowData.aply_no
            $('#iKey').val(rowData.aply_no);
           // jQuery("#grid").setSelection(rowid, true);



            $.ajax({
                type: "POST",
                url: '@Url.Action("qryCheck", "OAP0050A")',
                async: false,
                cache: false,
                dataType: "json",
                data: {
                    'aply_no': aply_no
                },
                success: function (json) {

                    if (json.success) {
                        //更新畫面GRID
                        jQuery("#gridCheck").jqGrid('clearGridData')
                            .jqGrid('setGridParam', { data: json.rows })
                            .trigger("reloadGrid");
                        $('#modal').modal('show');
                    }
                }
            });
        }

    //*--------------查詢待覆核資料  begin-----------------*//
    function createGrid(bClearMsg) {

        recList = [];
        rtnList = [];
        $('#qryResult').children().remove();

        $('#qryResult').append('<table id="' + "grid" + '"></table>');
        $('#qryResult').append('<div id="' + "pager" + '"></div>');


        $.blockUI(); //畫面鎖起來


        $("#grid").jqGrid({
            url: '/OAP0050A/LoadData/',
            //postData: para,
            datatype: 'json',
            jsonReader: {
                repeatitems: false, id: 'aply_no'
            },
            mtype: 'POST',
            colNames: ['核可', '駁回', '申請單號', '匯入筆數', '申請人', '申請人姓名', '申請日期', '明細'],
            colModel: [
                {
                    name: 'rec', index: 'rec', align: 'center', width: '60', editable: true, edittype: 'checkbox', formatter: "checkbox", formatoptions: { disabled: false },
                    cellattr: function (rowId, tv, rawObject, cm, rdata) {
                        return ' onClick="ckRec(' + '\'' + rowId + '\'' + ')"';
                    }, editoptions: { value: "True:False" }
                },
                {
                    name: 'rtn', index: 'rtn', align: 'center', width: '60', editable: true, edittype: 'checkbox', formatter: "checkbox", formatoptions: { disabled: false },
                    cellattr: function (rowId, tv, rawObject, cm, rdata) {
                        return ' onClick="ckRtn(' + '\'' + rowId + '\'' + ')"';
                    }, editoptions: { value: "True:False" }
                },
                { name: 'aply_no', align: 'center' },
                { name: 'cnt', align: 'center' },

                { name: 'update_id', align: 'center', width: '80' },
                { name: 'update_name', align: 'center', width: '120' },
                { name: 'update_datetime', align: 'center', width: '160' },
                {
                  name: 'Action', index: 'Action', search: false, align: 'center', width: 120//, cellattr: arrtRowspan
                }
            ],
            autowidth: true,
            shrinkToFit: false,
            forceFit: true,
            pager: '#pager',
            width: 'auto',
            height: 'auto',
            rowNum: 25,
            rowList: [10, 25, 50],
            //sortname: 'aply_no',
            //sortorder: "acs",
            viewrecords: true,
            loadonce: true,
            loadComplete: function (data) {
                var cnt = $('#grid').getGridParam('records')

                if (bClearMsg)
                    $('#validationSummary').children().remove();

                var validationSummary = $('#validationSummary ul.validation-summary-errors');

                if (validationSummary.length == 0) {
                    $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                    validationSummary = $('#validationSummary ul.validation-summary-errors');
                }

                if (data.success) {
                    if (bClearMsg & cnt == 0)
                        validationSummary.append('<li>' + '無符合條件的資料!!' + '</li>');

                } else if (!data.success && cnt == 0)
                    validationSummary.append('<li>' + '其它錯誤，請洽系統管理員!!' + '</li>');




                //還原畫面有勾選的資料
                ids = $(this).jqGrid('getDataIDs');

                for (j = 0; j <= ids.length - 1; j++) {
                    rowData = $("#grid").jqGrid('getRowData', ids[j]);

                    for (i = 0, count = recList.length; i < count; i++) {
                        if (rowData.aply_no == recList[i])
                            $("#grid").jqGrid("setCell", rowData.aply_no, "rec", "True");
                    }

                    for (i = 0, count = rtnList.length; i < count; i++) {
                        if (rowData.aply_no == rtnList[i])
                            $("#grid").jqGrid("setCell", rowData.aply_no, "rtn", "True");
                    }
                }



                var ids = jQuery("#grid").jqGrid('getDataIDs');

                for (var i = 0; i < ids.length; i++) {
                    var rowId = ids[i];

                    rowData = $("#grid").jqGrid('getRowData', rowId);
                    be = "<input class=\"edit\" style='height:28x;width:50px; ' type='button' id='btn_edit_" + rowId + "' value='明細' onclick=\"qryCheckFunction('" + rowId + "');\"  />";
                    jQuery("#grid").jqGrid('setRowData', ids[i], { Action: be });
                }
            }

        });

        $.unblockUI(); //畫面打開
    }

    //*--------------查詢待覆核資料  end-----------------*//





    //*-------------------支票 GRID begin--------------------*//
    $("#gridCheck").jqGrid({
        editurl: 'clientArray',
        datatype: "local",
        //caption: '明細資料',
        localReader: { id: "check_no" },
        colModel: [
            {
                label: '大系統別',
                name: 'system', align: 'center', editable: false, width: 80
            },
            {
                label: '支票號碼',
                name: 'check_no', align: 'center', editable: false, width: 100
            },
            {
                label: '支票簡稱',
                name: 'check_acct_short', align: 'center', editable: false, width: 80
            },
            {
                label: '保單號碼',
                name: 'policy_no', align: 'center', editable: false, width: 100
            },
            {
                label: '保單序號',
                name: 'policy_seq', align: 'center', editable: false, width: 80
            },
            {
                label: '重覆碼',
                name: 'id_dup', align: 'center', editable: false, width: 80
            },
            {
                label: '案號人員別',
                name: 'member_id', align: 'center', editable: false, width: 100
            },
            {
                label: '案號',
                name: 'change_id', align: 'center', editable: false, width: 100
            },
            {
                label: '給付對象 ID',
                name: 'paid_id', align: 'center', editable: false, width: 100
            },
            {
                label: '給付對象姓名',
                name: 'paid_name', align: 'center', editable: false, width: 100
            },
            {
                label: '回存金額',
                name: 'main_amt', align: 'right', width: '140', editable: false,
                formatter: 'currency', formatoptions: { decimalSeparator: ".", thousandsSeparator: ",", decimalPlaces: 0 }
            },
            {
                label: '支票金額',
                name: 'check_amt', align: 'right', width: '140', editable: false,
                formatter: 'currency', formatoptions: { decimalSeparator: ".", thousandsSeparator: ",", decimalPlaces: 0 }
            },
            {
                label: '支票到期日',
                name: 'check_date', align: 'center', width: '120', editable: false
            },
            {
                label: '原給付性質',
                name: 'o_paid_cd', align: 'center', width: '120', editable: false
            },
            {
                label: '給付帳務日期',
                name: 're_paid_date', align: 'center', width: '120', editable: false
            },
            {
                label: '再給付日期',
                name: 're_paid_date_n', align: 'center', width: '120', editable: false
            },
            {
                label: '再給付方式',
                name: 're_paid_type', align: 'center', width: '120', editable: false
            },
            {
                label: '保局範圍',
                name: 'fsc_range', align: 'center', width: '120', editable: false
            },
            {
                label: '匯入說明',
                name: 'imp_desc', align: 'center', width: '200', editable: false
            }

        ],
        autowidth: true,
        height: 'auto',
        //width: '300px',
        shrinkToFit: false,
        forceFit: true,
        loadonce: true,
        rownumbers: true,
        viewrecords: true,
        rowNum: 25,
        rowList: [10, 25, 50],
        pager: "#pagerCheck",

        loadComplete: function () {


        }
    });

            //*-------------------支票 GRID end--------------------*//



    $(function () {

        $(window).bind('resize', function () {
            var newWidth = $("#grid").closest(".ui-jqgrid").parent().width();
            jQuery("#grid").setGridWidth(newWidth, false);
        }).trigger('resize');

        $(window).bind('resize', function () {
            var newWidth = $("#gridCheck").closest(".ui-jqgrid").parent().width();
            jQuery("#gridCheck").setGridWidth("800", false);
        }).trigger('resize');

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {

            createGrid();
        }






        //*--------------覆核確認  begin-----------------*//
        $("#btnSave").click().on('click', function () {

            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (recList.length == 0 && rtnList.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
                validationSummary.append('<li>' + '請選擇要核可或駁回的資料！' + '</li>');

            } else {

                ids = $("#grid").jqGrid('getDataIDs');
                var recData = [];
                var rtnData = [];

                var gridData = $("#grid").jqGrid('getGridParam', 'data');
                for (j = 0; j <= gridData.length - 1; j++) {
                    rowData = gridData[j];

                    if (recList.length > 0) {
                        for (i = 0, count = recList.length; i < count; i++) {
                            if (rowData.aply_no == recList[i]) {
                                recData.push({
                                    'aply_no': rowData.aply_no,
                                    'update_id': rowData.update_id
                                });
                                //recData.push(rowData);
                            }
                        }
                    } else {
                        recData = null;
                    }

                    if (rtnList.length > 0) {
                        for (i = 0, count = rtnList.length; i < count; i++) {
                            if (rowData.aply_no == rtnList[i]) {

                                rtnData.push({
                                    'aply_no': rowData.aply_no,
                                    'update_id': rowData.update_id
                                });

                                //rtnData.push(rowData);
                            }
                        }
                    } else {
                        rtnData = null;
                    }
                }



                $.blockUI();

                $.ajax({
                    url: "@Url.Action("execSave", "OAP0050A")",
                    data: JSON.stringify({'recData': recData, 'rtnData': rtnData }
                    ),
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    if (data.success) {
                        $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                        validationSummary = $('#validationSummary ul.validation-summary-errors');

                        recList = [];
                        rtnList = [];

                        validationSummary.append('<li>作業成功！</li>');

                        createGrid(false);

                    } else {
                        $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                        validationSummary = $('#validationSummary ul.validation-summary-errors');
                        validationSummary.append('<li>' + data.err + '</li>');
                    }
                    $.unblockUI();

                },
                error: function () {
                    $.unblockUI();
                }
            });


        }
        });

        //*--------------覆核確認  end-----------------*//
    });
</script>


