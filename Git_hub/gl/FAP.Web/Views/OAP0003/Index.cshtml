@model FAP.Web.ViewModels.OAP0003Model

@{
    //Layout = null;
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;
    //Layout = "~/Views/Shared/_Layout.cshtml";

    var rStatusList = ViewBag.rStatusList as SelectList;
    var opScope = ViewBag.opScope;
}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @Html.Hidden("hidAplyNo", "")
            @Html.Hidden("hidOPaidCd", "")

            @if (opScope != "" && opScope != "0")
            {
                <table>
                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.report_no)：@Html.TextBoxFor(model => model.report_no, new { @size = "24", @maxlength = "20" })
                        </td>
                    </tr>

                    </table>

                    <div class="row">
                        <div class="col-sm-24" style="text-align:center;">
                            <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
                            <input type="button" id="btnDelete" name="btnDelete" value="刪除" class="btn btn-primary" />
                            <input type="submit" id="btnClear" name="btnClear" value="清空" class="btn btn-primary" />
                        </div>
                    </div>


                    <table>
                        <tr>
                            <td>
                                @Html.DisplayNameFor(model => model.paid_id)：@Html.TextBoxFor(model => model.paid_id, new { @size = "10", @maxlength = "10", @disabled = true })
                            </td>
                            <td>
                                @Html.DisplayNameFor(model => model.paid_name)：@Html.TextBoxFor(model => model.paid_name, new { @size = "25", @maxlength = "25", @disabled = true })
                            </td>
                        </tr>
                        <tr>
                            <td>
                                @Html.DisplayNameFor(model => model.r_status)：@Html.DropDownList("r_status", rStatusList, "", new { @disabled = true })
                            </td>
                        </tr>

                </table>

                <br>

                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }

        </div>
    </div>

</div>



<script type="text/javascript">
    //取得"給付方式"下拉選單
    function getOPaidCd() {
        return $('#hidOPaidCd').val();
    }


    //*---------------產生GRID begin ----------------*//
    function genGrid() {
        $('#qryResult').children().remove();

        $('#qryResult').append('<table id="' + "grid" + '"></table>');
        $('#qryResult').append('<div id="' + "pager" + '"></div>');


        $("#grid").jqGrid({
            editurl: 'clientArray',
            datatype: "local",
            //caption: '保單明細',
            jsonReader: {
                repeatitems: false, id: 'tempId'
            },
            colModel: [
                 {
                     label: '支票號碼',
                     name: 'check_no', align: 'center', 
                     editable: false,
                 },
                {
                    label: '保單號碼',
                    name: 'policy_no', align: 'center',
                    editable: false
                },
                {
                    label: '保單序號',
                    name: 'policy_seq', align: 'center',
                    editable: false
                },
                {
                    label: '重覆碼',
                    name: 'id_dup', align: 'center',
                    editable: false
                },
                {
                    label: '案號',
                    name: 'change_id', align: 'center',
                    editable: false
                },
                {
                    label: '給付項目',
                    name: 'o_paid_cd', align: 'center',
                    editable: true,
                    edittype: "select",
                    formatter: 'select',
                    editoptions: {
                        value: getOPaidCd()
                    }
                },
                {
                    label: '回存金額',
                    name: 'main_amt', align: 'center',
                    editable: false,
                    formatter: 'currency', formatoptions: { decimalSeparator: ".", thousandsSeparator: ",", decimalPlaces: 2 }
                }
            ],
            autowidth: true,
            height: 'auto',
            width: 'auto',
            shrinkToFit: true,
            forceFit: true,
            loadonce: true,
            rownumbers: true,
            viewrecords: true,
            pager: "#pager",
            loadComplete: function () {


            }
        });

    }
    //*---------------產生GRID end ----------------*//

    //*---------------申請覆核/刪除 begin ----------------*//
    function execAply(execAction) {
        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }

        $.blockUI(); //畫面鎖起來


        $.ajax({
            type: "POST",
            data: JSON.stringify({
                'report_no':  $("#report_no").val()
            }),
            dataType: "json",
            url: '@Url.Action("execAply", "OAP0003")',
            contentType: 'application/json',
            success: function (data) {
                if (data.success) {
                    $("#btnDelete").attr('disabled', true);
                    $("#btnClear").attr('disabled', false);

                    validationSummary.append('<li>' + '儲存資料成功，覆核單號:' + data.aplyNo + '</li>');
                } else {
                    validationSummary.append('<li>' + data.err + '</li>');
                }


                $.unblockUI(); //畫面打開

            }
        });
    }
    //*---------------申請覆核/刪除 end ----------------*//

    $(function () {
        $(window).bind('resize', function () {
            var newWidth = $("#grid").closest(".ui-jqgrid").parent().width();
            jQuery("#grid").setGridWidth(newWidth, false);
        }).trigger('resize');

        $.unblockUI();
        var opScope = '@Html.Raw(ViewBag.opScope)';

        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }
        if (opScope == "" || opScope == "0") {

            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {
            $("#btnDelete").attr('disabled', true);
            $('#hidOPaidCd').val('@Html.Raw(ViewBag.oPaidCdjqList)');

            genGrid();


            if('@Html.Raw(ViewBag.dataStatus)' == "2"){
                validationSummary.append('<li>' + '資料覆核中，不可異動!!' + '</li>');
                $("#btnDelete").attr('disabled', true);
                $("#btnClear").attr('disabled', true);
            } else {
                $("#btnDelete").attr('disabled', false);
            }

        }

        //*---------------清除 begin ----------------*//
        $("#btnClear").click().on('click', function () {

            $('#validationSummary').children().remove();
            $('#isQryTmp').prop('checked', false);

            jQuery("#grid").jqGrid('clearGridData').trigger("reloadGrid");


            $('#report_no').val("");

            $('#paid_id').val("");
            $('#paid_name').val("");
            $('#r_status').val("");

            $("#report_no").attr('disabled', false);

        });
        //*---------------清除 end ----------------*//




        //*---------------查詢 begin ----------------*//
        $("#btnQry").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            var errMsg = "";

            if ($("#report_no").val().length == 0) {
                errMsg += "「信函編號」　";
            }



            if (errMsg != "") {
                validationSummary.append('<li>請輸入' + errMsg + '</li>');

                return
            }

            $.blockUI(); //畫面鎖起來

            $("#report_no").attr('disabled', true);

            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: {
                        'report_no': $('#report_no').val()
                    }
                }),
                dataType: "json",
                url: '@Url.Action("qryPPAD", "OAP0003")',
                contentType: 'application/json',
                success: function (data) {

                    if (data.success) {

                        //沒有查到資料
                        if (data.cnt == 0) {
                            validationSummary.append('<li>資料不存在!!</li>');
                        } else {    //有查到資料

                            if (data.hisApprStat == ""){
                                $("#btnDelete").attr('disabled', false);

                                //add by daiyu 20191122
                                if (data.amlCnt > 0) {
                                    $("#btnDelete").attr('disabled', true);
                                    validationSummary.append('<li>此筆為制裁凍結案件，不可刪除!!</li>');
                                }
                            }
                            else {
                                $("#btnDelete").attr('disabled', true);
                                validationSummary.append('<li>此信函編碼已在覆核中，不可異動!!</li>');
                            }


                            $('#paid_id').val(data.dataSum.paid_id);
                            $('#paid_name').val(data.dataSum.paid_name);
                            $('#r_status').val(data.dataSum.r_status);


                            //更新畫面GRID
                            jQuery("#grid").jqGrid('clearGridData')
                                .jqGrid('setGridParam', { data: data.policyList })
                                .trigger("reloadGrid");

                        }


                        $.unblockUI(); //畫面打開

                    } else {
                        validationSummary.append('<li>' + data.err + '</li>');

                        $.unblockUI(); //畫面打開
                    }

                }
            });

        });

        //*---------------查詢 end ----------------*//

        //*---------------刪除 begin ----------------*//
        $("#btnDelete").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }


            if (window.confirm('是否刪除資料？') == true) {
                execAply("D");
            }

        });
        //*---------------刪除 end ----------------*//



    });
</script>


