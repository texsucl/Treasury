@model FAP.Web.ViewModels.OAP0010Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;

    var opScope = ViewBag.opScope;

    var clrStatusList = ViewBag.clrStatusList as SelectList;

}


<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                @Html.Hidden("hidStatus", "")

                @Html.Hidden("hidFscRange", "")
                @Html.Hidden("hidRePaidType", "")
                @Html.Hidden("hidPractice", "")
                @Html.Hidden("hidCertDoc", "")
                @Html.Hidden("hidStatus", "")
                @Html.Hidden("hidLevel1", "")
                @Html.Hidden("hidLevel2", "")
                <table>
                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.paid_id)：@Html.TextBoxFor(model => model.paid_id, new { @size = "12", @maxlength = "10", @onkeyup = "this.value = this.value.toUpperCase();" } )
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.paid_name)：@Html.TextBoxFor(model => model.paid_name, new { @size = "30", @maxlength = "30" })
                        </td>
                    </tr>

                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.policy_no)：@Html.TextBoxFor(model => model.policy_no, new { @size = "12", @maxlength = "10", @onkeyup = "this.value = this.value.toUpperCase();" })
                            -
                            @Html.TextBoxFor(model => model.policy_seq, new { @size = "3", @maxlength = "2" })
                            -
                            @Html.TextBoxFor(model => model.id_dup, new { @size = "2", @maxlength = "1" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.check_no)：@Html.TextBoxFor(model => model.check_no, new { @size = "12", @maxlength = "10", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.status)：@Html.DropDownList("status", clrStatusList, "請選擇")
                        </td>
                    </tr>
                </table>

                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
                        <input type="submit" id="btnClear" name="btnClear" value="清空" class="btn btn-primary" />
                        <input type="submit" id="btnPrint" name="btnPrint" value="結案報表" class="btn btn-primary" />
                    </div>
                </div>
                <br>

                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }



        </div>
    </div>

</div>



<script type="text/javascript">

    //取得"清理狀態"下拉選單
    function getStatus() {
        return $('#hidStatus').val();
    }

    //取得"保局範圍"下拉選單
    function getFscRange() {
        return $('#hidFscRange').val();
    }

    //取得"再給付方式"下拉選單
    function getRePaidType() {
        return $('#hidRePaidType').val();
    }

    //取得"踐行程序"下拉選單
    function getPractice() {
        return $('#hidPractice').val();
    }

    //取得"証明文件"下拉選單
    function getCertDoc() {
        return $('#hidCertDoc').val();
    }

    //取得"清理大類"下拉選單
    function getLevel1() {
        return $('#hidLevel1').val();
    }

    //取得"清理小類"下拉選單
    function getLevel2() {
        return $('#hidLevel2').val();
    }


    $(function () {


        $(window).bind('resize', function () {
            var newWidth = $("#grid").closest(".ui-jqgrid").parent().width();
            jQuery("#grid").setGridWidth(newWidth, false);
        }).trigger('resize');

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {
            $('#hidFscRange').val('@Html.Raw(ViewBag.fscRangejqList)');
            $('#hidRePaidType').val('@Html.Raw(ViewBag.rPaidTpjqList)');
            $('#hidPractice').val('@Html.Raw(ViewBag.practicejqList)');
            $('#hidCertDoc').val('@Html.Raw(ViewBag.certDocjqList)');
            $('#hidStatus').val('@Html.Raw(ViewBag.clrStatusjqList)');
            $('#hidLevel1').val('@Html.Raw(ViewBag.level1jqList)');
            $('#hidLevel2').val('@Html.Raw(ViewBag.level2jqList)');
        }


        //*---------------清除 begin ----------------*//
        $("#btnClear").click().on('click', function () {
            $('#validationSummary').children().remove();

            $('#btnQry').attr('disabled', false);


            $('#paid_id').attr('disabled', false);
            $('#paid_name').attr('disabled', false);
            $('#policy_no').attr('disabled', false);
            $('#policy_seq').attr('disabled', false);
            $('#id_dup').attr('disabled', false);
            $('#check_no').attr('disabled', false);
            $('#status').attr('disabled', false);

            $('#paid_id').val("");
            $('#paid_name').val("");
            $('#policy_no').val("");
            $('#policy_seq').val("");
            $('#id_dup').val("");
            $('#check_no').val("");
            $('#status').val("");

            jQuery("#grid").jqGrid('clearGridData').trigger("reloadGrid");

        });
        //*---------------清除 end ----------------*//



        //*---------------查詢 begin ----------------*//
        $("#btnQry").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            if (!($('#paid_id').val().length > 0
                || ($('#paid_name').val().length > 0 && $('#policy_no').val().length > 0 && $('#policy_seq').val().length > 0 )
                || $('#check_no').val().length > 0
                )) {
                validationSummary.append('<li>' + '請輸入「給付對象ID」或「給付對象姓名 + 保單號碼」或「支票號碼」!!"' + '</li>');
                return
            } else {
                $('#paid_id').attr('disabled', true);
                $('#paid_name').attr('disabled', true);
                $('#policy_no').attr('disabled', true);
                $('#policy_seq').attr('disabled', true);
                $('#id_dup').attr('disabled', true);
                $('#check_no').attr('disabled', true);
                $('#status').attr('disabled', true);
            }




            $('#btnQry').attr('disabled', true);

            var jsonData = JSON.stringify({
                'paid_id': $("#paid_id").val(),
                'paid_name': $("#paid_name").val(),
                'policy_no': $("#policy_no").val(),
                'policy_seq': $("#policy_seq").val(),
                'id_dup': $("#id_dup").val(),
                'check_no': $("#check_no").val(),
                'status': $("#status").val()
            });

            $.blockUI(); //畫面鎖起來

            $.ajax({
                type: "POST",
                data: jsonData,
                dataType: "json",
                url: '@Url.Action("qryProc", "OAP0010")',
                contentType: 'application/json',
                success: function (data) {

                    if (data.success) {
                        //更新畫面GRID
                        jQuery("#grid").jqGrid('clearGridData')
                            .jqGrid('setGridParam', { data: data.dataList })
                            .trigger("reloadGrid");


                        if (data.dataList.length == 0)
                            validationSummary.append('<li>' + '資料不存在!!"' + '</li>');
                        else {
                            $("#paid_id").val(data.paid_id);
                            $("#paid_name").val(data.paid_name);
                        }


                    } else
                        validationSummary.append('<li>' + data.err + '</li>');

                    $.unblockUI(); //畫面打開
                }
            });
        });
        //*---------------查詢 end ----------------*//



        //*-------------------GRID begin--------------------*//
        $("#grid").jqGrid({
            editurl: 'clientArray',
            datatype: "local",
            //caption: '明細資料',
            localReader: { id: "temp_id" },
            colModel: [
                 {
                     label: 'temp_id',
                     name: 'temp_id', align: 'center', hidden: true,
                     editable: false,
                 }
                 ,
                 {
                     label: '給付對象ID',
                     name: 'paid_id', align: 'center', width: '100', editable: false, hidden: true,
                 },
                  {
                      label: '給付對象姓名',
                      name: 'paid_name', align: 'center', width: '100', editable: false
                  },
                 {
                     label: '保局範圍',
                     name: 'fsc_range', align: 'center', width: '140',
                     editable: false,
                     edittype: "select",
                     formatter: 'select',
                     editoptions: {
                         value: getFscRange()
                     }
                 },
                  {
                      label: '支票號碼',
                      name: 'check_no', align: 'center', width: '140', editable: false, width: '100'
                  },
                  {
                      label: '支票帳號簡稱',
                      name: 'check_acct_short', align: 'center', width: '120', editable: false
                  },
                  {
                      label: '支票到期日',
                      name: 'check_date', align: 'center', width: '120', editable: false
                  },
                  {
                      label: '支票金額',
                      name: 'check_amt', align: 'right', width: '160', editable: false,
                      formatter: 'currency', formatoptions: { decimalSeparator: ".", thousandsSeparator: ",", decimalPlaces: 0 }
                  },
                  {
                      label: '清理狀態',
                      name: 'status', align: 'center', width: '160', editable: false,
                      edittype: "select",
                      formatter: 'select',
                      editoptions: {
                          value: getStatus()
                      }
                  },
                   {
                       label: '清理大類',
                       name: 'level_1', align: 'center', width: '160', editable: false,
                       edittype: "select",
                       formatter: 'select',
                       editoptions: {
                           value: getLevel1()
                       }
                   },
                    {
                        label: '清理小類',
                        name: 'level_2', align: 'center', width: '160', editable: false,
                        edittype: "select",
                        formatter: 'select',
                        editoptions: {
                            value: getLevel2()
                        }
                    },
                  {
                      label: '帳務日期',
                      name: 're_paid_date', align: 'center', width: '120', editable: false
                  },
                  {
                      label: '再給付方式',
                      name: 're_paid_type', align: 'center', width: '120', editable: false,
                      edittype: "select",
                      formatter: 'select',
                      editoptions: {
                          value: getRePaidType()
                      }
                  },
                  {
                      label: '結案編號',
                      name: 'closed_no', align: 'center', width: '140', editable: false
                  },
                    { label: '異動人員', name: 'update_id', align: 'center', width: '120' },
                    { label: '異動日期', name: 'update_datetime', align: 'center', width: '100' }

            ],
            autowidth: true,
            height: 'auto',
            width: 'auto',
            shrinkToFit: false,
            forceFit: false,
            loadonce: true,
            sortname: "temp_id",
            rownumbers: true,
            viewrecords: true,
            rowNum: 25,
            rowList: [10, 25, 50],
            pager: "#pager",

            loadComplete: function () {

            },
            subGrid: true,
            subGridOptions: {
                "plusicon": "ui-icon-triangle-1-e",
                "minusicon": "ui-icon-triangle-1-s",
                "openicon": "ui-icon-arrowreturn-1-e",
                // load the subgrid data only once
                // and the just show/hide
                "reloadOnExpand": false,
                // select the row when the expand column is clicked
                "selectOnExpand": true
            },
            subGridRowExpanded: function (subgrid_id, row_id) {
                var subgrid_table_id, pager_id;

                var para = {
                    temp_id: row_id
                };

                subgrid_table_id = subgrid_id + "_t";
                pager_id = "p_" + subgrid_table_id;
                $("#" + subgrid_id).html("<table id='" + subgrid_table_id + "' class='scroll'></table><div id='" + pager_id + "' class='scroll'></div>");
                jQuery("#" + subgrid_table_id).jqGrid({
                    url: '/OAP0010/qryTraceProc/',
                    postData: para,
                    datatype: 'json',
                    jsonReader: {
                        repeatitems: false, id: 'temp_id'
                    },
                    mtype: 'POST',

                    colModel: [
     {
         label: 'temp_id',
         name: 'temp_id', align: 'center', hidden: true,
         editable: false,
     },
    {
        label: '踐行程序',
        name: 'practice', align: 'left',
        editable: false,
        edittype: "select",
        formatter: 'select',
        editoptions: {
            value: getPractice()
        }
    },
     {
         label: '証明文件',
         name: 'cert_doc', align: 'left',
         editable: false,
         edittype: "select",
         formatter: 'select',
         editoptions: {
             value: getCertDoc()
         }
     },
     {
         label: '執行日期',
         name: 'exec_date', align: 'center', width: '100',
         editable: false
     },
     {
         label: '過程說明',
         name: 'proc_desc', align: 'left', width: '200',
         editable: false,
         cellattr: function (rowId, tv, rawObject, cm, rdata) { return 'style="white-space: pre-wrap"' }
     },
                    { label: '異動人員', name: 'update_id', align: 'center', width: '120' },
                    { label: '異動日期', name: 'update_datetime', align: 'center', width: '160' }
                    ],
                    rowNum: 20,
                    pager: pager_id,
                    //sortname: 'exec_date',
                    //sortorder: "asc",
                    height: '100%'
                });
                jQuery("#" + subgrid_table_id).jqGrid('navGrid', "#" + pager_id, { edit: false, add: false, del: false })
            }
        });

        //*-------------------GRID end--------------------*//


        

        //*---------------報表列印 begin ----------------*//
        $("#btnPrint").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            var selRowId = $("#grid").jqGrid('getGridParam', 'selrow');
            var curRowData = jQuery("#grid").getRowData(selRowId);
            if ($("#grid").jqGrid('getCell', selRowId, 'closed_no') == "") {
                alert("無結案資料!!");
                return;
            }
                


            var jsonData = JSON.stringify({
                'paid_id': $("#grid").jqGrid('getCell', selRowId, 'paid_id'),
                'paid_name': $("#grid").jqGrid('getCell', selRowId, 'paid_name'),
                'level_1': $("#grid").jqGrid('getCell', selRowId, 'level_1'),
                'level_2': $("#grid").jqGrid('getCell', selRowId, 'level_2'),
                'closed_no': $("#grid").jqGrid('getCell', selRowId, 'closed_no')
            });
            $.blockUI();

            $.ajax({
                url: "@Url.Action("Print", "OAP0010")",
                data: jsonData,
            type: "POST",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {


                var link = '';
                if (data.success) {
                    var url = '/OAP0011/downloadRpt?id=' + data.guid;

                    window.location = url;

                    @*link = '@Url.HttpRouteUrl("Report", new { aspx = "OAP0011PViewer",  id = "-1"})';
                    link = link.replace("-1", data.guid);
                    window.open(link);*@



                    } else {
                    //$('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                    //validationSummary = $('#validationSummary ul.validation-summary-errors');

                    if (data.err.length > 0) {
                        validationSummary.append('<li>' + data.err + '</li>');
                    }
                }

                $.unblockUI();
            },
            error: function () {
                $.unblockUI();
            }
        });


    });

    //*---------------報表列印 end ----------------*//
        
        


    });
</script>


