@model FRT.Web.ViewModels.ORTB013Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;
    var opScope = ViewBag.opScope;

    var frtCodeList = ViewBag.frtCodeList as SelectList;
    var statusjqList = ViewBag.statusjqList as SelectList;
}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                @Html.Hidden("hidStatus", "")
                <table>
                    <tr>
                        <td colspan="2">
                            <span style="color:red;">＊@Html.DisplayNameFor(model => model.groupId)：</span>@Html.DropDownList("groupId", frtCodeList, "請選擇")
                        </td>
                    </tr>
                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.srceFrom)：@Html.TextBoxFor(model => model.srceFrom, new { @size = "3", @maxlength = "3", @disabled = true})
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.textLen)：@Html.TextBoxFor(model => model.textLen, new { @size = "3", @maxlength = "3", @disabled = true })
                        </td>
                    </tr>

                </table>

                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
                        <input type="button" id="btnSave" name="btnSave" value="確認" class="btn btn-primary" />
                    </div>
                </div>


                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }



        </div>
    </div>

</div>



<script type="text/javascript">

    //切換組別碼
    $("#groupId").on("change", function () {
        $("#srceFrom").val("");
        $("#textLen").val("");

        jQuery("#grid").jqGrid('clearGridData').trigger("reloadGrid");

        recList = [];
        rtnList = [];

        if ("" == $("#groupId").val())
            return


        setGridLabel();



        $.blockUI();

        $.ajax({
            type: "POST",
            url: '@Url.Action("qryGroupId", "ORTB013")',
            async: false,
            cache: false,
            dataType: "json",
            data: {
                'groupId': $("#groupId").val()
            },
            success: function (json) {

                if (json.success) {
                    $("#srceFrom").val(json.srceFrom);
                    $("#textLen").val(json.textLen);
                } else {
                    alert(json.err);
                }

                $.unblockUI();
            }
        });

    });


    function setGridLabel() {

        if ($("#groupId").val() == "BKAC_CDRN") {
            jQuery("#grid").jqGrid('setLabel', 'refNoN', '退匯原因');
            jQuery("#grid").jqGrid('setLabel', 'text', '說明');
        } else if ($("#groupId").val() == "BKMSG_CKX" || $("#groupId").val() == "BKMSG_CKQ") {
            jQuery("#grid").jqGrid('setLabel', 'refNoN', '訊息代碼');
            jQuery("#grid").jqGrid('setLabel', 'text', '代碼說明');
        }
        else if ($("#groupId").val() == "BKMSG_AR" || $("#groupId").val() == "BKMSG_FOG" || $("#groupId").val() == "BKMSG_NTD") {
            jQuery("#grid").jqGrid('setLabel', 'refNoN', '銀行代碼');
            jQuery("#grid").jqGrid('setLabel', 'text', '銀行名稱');
        } else if ($("#groupId").val() == "BKMSG_OTH") {
            jQuery("#grid").jqGrid('setLabel', 'refNoN', '銀行代碼');
            jQuery("#grid").jqGrid('setLabel', 'text', '提醒訊息內容');
        }


        if ($("#groupId").val() == "BKMSG_OTH") {
            jQuery("#grid").jqGrid('setLabel', 'othText', '銀行名稱');
            jQuery("#grid").jqGrid('showCol', ["othText"]);

        } else {
            jQuery("#grid").jqGrid('setLabel', 'othText', '其它說明');
            jQuery("#grid").jqGrid('hideCol', ["othText"]);
        }

    }

    //取得"資料狀態"下拉選單
    function getStatus() {
        return $('#hidStatus').val();
    }

    var $grid = $("#grid"), recList = [], ckRec = function (rowId) {

        var valueRec = $('#grid').jqGrid('getCell', rowId, 'rec');
        var valueRtn = $('#grid').jqGrid('getCell', rowId, 'rtn');
        var index = $.inArray(rowId, recList);

        if (valueRec == "True" && valueRtn == "True") {
            $("#grid").jqGrid("setCell", rowId, "rec", "False");
            alert("不可同時勾選 核可 與 駁回!!");
        } else {
            if (valueRec == "True")
                recList.push(rowId);
            else if (index >= 0)
                recList.splice(index, 1);
        }

    };


    var $grid = $("#grid"), rtnList = [], ckRtn = function (rowId) {

        var valueRec = $('#grid').jqGrid('getCell', rowId, 'rec');
        var valueRtn = $('#grid').jqGrid('getCell', rowId, 'rtn');
        var index = $.inArray(rowId, rtnList);


        if (valueRec == "True" && valueRtn == "True") {
            $("#grid").jqGrid("setCell", rowId, "rtn", "False");
            alert("不可同時勾選 核可 與 駁回!!");
        } else {
            if (valueRtn == "True")
                rtnList.push(rowId);
            else if (index >= 0)
                rtnList.splice(index, 1);
        }
    }



    $(function () {
        $(window).bind('resize', function () {
            var newWidth = $("#grid").closest(".ui-jqgrid").parent().width();
            jQuery("#grid").setGridWidth(newWidth, false);
        }).trigger('resize');

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();



            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {
            $('#hidStatus').val('@Html.Raw(ViewBag.statusjqList)');
        }

        //*---------------查詢 begin ----------------*//
        $("#btnQry").click().on('click', function () {
            createGrid(true);
        });

        //*--------------查詢待覆核資料  begin-----------------*//
        function createGrid(bClearMsg) {

            if (bClearMsg)
                $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            recList = [];
            rtnList = [];

            $('#qryResult').children().remove();

            $('#qryResult').append('<table id="' + "grid" + '"></table>');
            $('#qryResult').append('<div id="' + "pager" + '"></div>');

            if ($('#groupId').val().length == 0) {
                validationSummary.append('<li>' + '「組別碼」必需輸入!!' + '</li>');
                return;
            }

            var para = {
                groupId: $("#groupId").val(),
                srceFrom: $("#srceFrom").val()
            };

            $.blockUI(); //畫面鎖起來

            $("#grid").jqGrid({
                url: '/ORTB013A/LoadData/',
                postData: para,
                datatype: 'json',
                jsonReader: {
                    repeatitems: false, id: 'refNoN'
                },
                mtype: 'POST',
                colModel: [
                    {
                        label: '核可',
                        name: 'rec', index: 'rec', align: 'center', width:'50', editable: true, edittype: 'checkbox', formatter: "checkbox", formatoptions: { disabled: false },
                        cellattr: function (rowId, tv, rawObject, cm, rdata) {
                            return ' onClick="ckRec(' + '\'' + rowId + '\'' + ')"';
                        }, editoptions: { value: "True:False" }
                    },
                    {
                        label: '駁回',
                        name: 'rtn', index: 'rtn', align: 'center', width:'50', editable: true, edittype: 'checkbox', formatter: "checkbox", formatoptions: { disabled: false },
                        cellattr: function (rowId, tv, rawObject, cm, rdata) {
                            return ' onClick="ckRtn(' + '\'' + rowId + '\'' + ')"';
                        }, editoptions: { value: "True:False" }
                    },

                    { label: '申請單號', name: 'aplyNo', align: 'center', hidden: true },
                    {
                        label: '資料狀態',
                        name: 'status', align: 'center', width: '100',
                        editable: false,
                        edittype: "select",
                        formatter: 'select',
                        editoptions: {
                            value: getStatus()
                        }
                    },
                {
                    label: '參考號碼',
                    name: 'refNo', align: 'center', width: '120', hidden: true,
                    editable: false

                },
                {
                    label: '參考號碼',
                    name: 'refNoN', align: 'center', width: '120',
                    editable: false
                },
                 {
                     label: '其它說明',
                     name: 'othText', align: 'center', hidden: true, width: '100',
                     editable: false,
                 },
                {
                    label: '說明', width: '400',
                    name: 'text', align: 'left',
                    editable: false,
                    cellattr: function (rowId, tv, rawObject, cm, rdata) { return 'style="white-space: pre;"' }
                },
                { label: '申請人', name: 'updId', align: 'center', width: '80' },
                    { label: '申請日期時間', name: 'updDateTime', align: 'center', width: '160' }
                ],
                autowidth: true,
                shrinkToFit: false,
                forceFit: false,
                pager: '#pager',
                width: 'auto',
                height: 'auto',
                rowNum: 10,
                rowList: [10, 25, 50],
                //sortname: 'fastNo',
                sortorder: "acs",
                viewrecords: true,
                loadonce: true,
                loadComplete: function (data) {
                    setGridLabel();
                    var cnt = $('#grid').getGridParam('records')

                    if (data.success) {
                        if (bClearMsg & cnt == 0)
                            validationSummary.append('<li>' + '無符合條件的資料!!' + '</li>');


                    } else if (data.success == false && cnt == 0) {
                        validationSummary.append('<li>' + '其它錯誤，請洽系統管理員!!' + '</li>');

                        //還原畫面有勾選的資料
                        ids = $(this).jqGrid('getDataIDs');

                        for (j = 0; j <= ids.length - 1; j++) {
                            rowData = $("#grid").jqGrid('getRowData', ids[j]);

                            for (i = 0, count = recList.length; i < count; i++) {
                                if (rowData.refNoN == recList[i])
                                    $("#grid").jqGrid("setCell", rowData.refNoN, "rec", "True");
                            }

                            for (i = 0, count = rtnList.length; i < count; i++) {
                                if (rowData.refNoN == rtnList[i])
                                    $("#grid").jqGrid("setCell", rowData.refNoN, "rtn", "True");
                            }
                        }
                    }


                }

            });

            $.unblockUI(); //畫面打開
        }

        //*--------------查詢待覆核資料  end-----------------*//




        //*--------------覆核確認  begin-----------------*//
        $("#btnSave").click().on('click', function () {


            $('#validationSummary').children().remove();

            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (recList.length == 0 && rtnList.length == 0) {

                validationSummary.append('<li>' + '請選擇要核可或駁回的資料！' + '</li>');

            } else {

                ids = $("#grid").jqGrid('getDataIDs');
                var recData = [];
                var rtnData = [];

                var gridData = $("#grid").jqGrid('getGridParam', 'data');
                for (j = 0; j <= gridData.length - 1; j++) {
                    rowData = gridData[j];

                    if (recList.length > 0) {
                        for (i = 0, count = recList.length; i < count; i++) {
                            if (rowData.refNoN == recList[i])
                                recData.push(rowData);
                        }
                    } else {
                        recData = null;
                    }

                    if (rtnList.length > 0) {
                        for (i = 0, count = rtnList.length; i < count; i++) {
                            if (rowData.refNoN == rtnList[i])
                                rtnData.push(rowData);
                        }
                    } else {
                        rtnData = null;
                    }

                }
                $.blockUI();

                $.ajax({
                    url: "@Url.Action("execSave", "ORTB013A")",
                    data: JSON.stringify({
                        'groupId': $('#groupId').val(), 'srceFrom': $('#srceFrom').val(), 'textLen': $('#textLen').val(),
                        'recData': recData, 'rtnData': rtnData
                    }
                    ),
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    if (data.success) {
                        validationSummary.append('<li>作業成功！</li>'); 
                    } else {
                        if (data.err.length > 0) {
                            for (var i = 0; i <= data.err.length - 1; i++) {
                                validationSummary.append('<li>' + data.err[i].refNo + ':' + data.err[i].errorMsg + '</li>');
                            }
                        }
                        
                    }

                    recList = [];
                    rtnList = [];

                    createGrid(false);

                    $.unblockUI(); //畫面打開

                },
                error: function () {
                    $.unblockUI(); //畫面打開
                }
            });


        }
        });

        //*--------------覆核確認  end-----------------*//
    });
</script>


