@model FRT.Web.ViewModels.ORT0104Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;

    var opScope = ViewBag.opScope;
    var failCodeList = ViewBag.failCodeList as SelectList;

}


<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                @Html.Hidden("fail_code_o", "")
                @Html.Hidden("seqn_o", "")
                <table>
                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.currency)：@Html.TextBoxFor(model => model.currency, new { @size = "5", @maxlength = "4", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.vhr_no1)：@Html.TextBoxFor(model => model.vhr_no1, new { @size = "11", @maxlength = "10", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                    </tr>

                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.pro_no)：@Html.TextBoxFor(model => model.pro_no, new { @size = "13", @maxlength = "12", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.paid_id)：@Html.TextBoxFor(model => model.paid_id, new { @size = "11", @maxlength = "10", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                    </tr>
                </table>


                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
                        <input type="submit" id="btnModify" name="btnModify" value="申請覆核" class="btn btn-primary" />
                        <input type="submit" id="btnClear" name="btnClear" value="清空" class="btn btn-primary" />
                    </div>
                </div>
                <br>

                <table>
                    <tr>
                        <td colspan="2">
                            @Html.DisplayNameFor(model => model.payment)：@Html.TextBoxFor(model => model.payment, new { @size = "50", @disabled = true })
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2">
                            @Html.DisplayNameFor(model => model.remit_amt)：@Html.TextBoxFor(model => model.remit_amt, new { @disabled = true })
                        </td>
                    </tr>

                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.bank_no)：@Html.TextBoxFor(model => model.bank_no, new { @size = "11", @disabled = true })@Html.TextBoxFor(model => model.bank_name, new { @size = "24", @disabled = true })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.bank_act)：@Html.TextBoxFor(model => model.bank_act, new { @disabled = true })
                        </td>
                    </tr>

                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.fee_seqn)：@Html.TextBoxFor(model => model.fee_seqn, new { @disabled = true })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.fail_code)：@Html.DropDownList("fail_code", failCodeList, "", new { })
                        </td>
                    </tr>

                    <tr>
                        <td>
                            @Html.DisplayNameFor(model => model.fbo_no)：@Html.TextBoxFor(model => model.fbo_no, new { @disabled = true })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.seqn)：@Html.TextBoxFor(model => model.seqn, new { @size = "13", @maxlength = "12", @onkeyup = "this.value = this.value.toUpperCase();" })
                        </td>
                    </tr>
                </table>
            }
        </div>
    </div>

</div>



<script type="text/javascript">


    $(function () {

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {
            $('#btnModify').attr('disabled', true);
            $('#btnNew').attr('disabled', true);
        }




        //*---------------清除 begin ----------------*//
        $("#btnClear").click().on('click', function () {
            $('#validationSummary').children().remove();

            $('#currency').attr('disabled', false);
            $('#vhr_no1').attr('disabled', false);
            $('#pro_no').attr('disabled', false);
            $('#paid_id').attr('disabled', false);

            $('#currency').val("");
            $('#vhr_no1').val("");
            $('#pro_no').val("");
            $('#paid_id').val("");

            $('#payment').val("");
            $('#remit_amt').val("");
            $('#bank_no').val("");
            $('#bank_act').val("");
            $('#fee_seqn').val("");
            $('#fail_code').val("");
            $('#fbo_no').val("");
            $('#seqn').val("");

            $('#fail_code_o').val("");
            $('#seqn_o').val("");

            $('#btnModify').attr('disabled', true);

        });
        //*---------------清除 end ----------------*//



        //*---------------查詢 begin ----------------*//
        $("#btnQry").on("click", function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

        var bPass = true;

        if ($('#currency').val() == "" || $('#pro_no').val() == "") {
            validationSummary.append('<li>' + '「幣別」、「處理序號」為必要輸入!!"' + '</li>');
            bPass = false;
        }


            if (!bPass) {
                return;
            } else {
                $('#payment').val("");
                $('#remit_amt').val("");
                $('#bank_no').val("");
                $('#bank_act').val("");
                $('#fee_seqn').val("");
                $('#fail_code').val("");
                $('#fbo_no').val("");
                $('#seqn').val("");

                $('#fail_code_o').val("");
                $('#seqn_o').val("");
            }

            if (bPass) {
                $.blockUI();

                $('#currency').attr('disabled', true);
                $('#vhr_no1').attr('disabled', true);
                $('#pro_no').attr('disabled', true);
                $('#paid_id').attr('disabled', true);


                $.blockUI(); //畫面鎖起來

                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: {
                            'currency': $('#currency').val()
                            , 'vhr_no1': $('#vhr_no1').val()
                            , 'pro_no': $('#pro_no').val()
                            , 'paid_id': $('#paid_id').val()
                        }
                    }),
                    dataType: "json",
                    url: '@Url.Action("qryFRTRVMN", "ORT0104")',
                    contentType: 'application/json',
                    success: function (data) {

                        if (data.success) {
                            if (data.model.corp_no == "") {
                                $('#btnModify').attr('disabled', true);

                                $('#fail_code').attr('disabled', false);
                                $('#seqn').attr('disabled', false);

                                validationSummary.append('<li>' + '資料不存在!!"' + '</li>');

                            } else {

                                if (data.aply_no == "")
                                    $('#btnModify').attr('disabled', false);
                                else {
                                    $('#btnModify').attr('disabled', true);
                                    validationSummary.append('<li>' + '資料覆核中!!"' + '</li>');
                                }
                                    

                                $('#payment').val(data.model.payment);
                                $('#remit_amt').val(data.model.remit_amt);
                                $('#bank_no').val(data.model.bank_no);
                                $('#bank_act').val(data.model.bank_act);
                                $('#fee_seqn').val(data.model.fee_seqn);
                                $('#fail_code').val(data.model.fail_code);
                                $('#fbo_no').val(data.model.fbo_no);
                                $('#seqn').val(data.model.seqn);

                                $('#fail_code_o').val(data.model.fail_code);
                                $('#seqn_o').val(data.model.seqn);

                                //add by daiyu 20210312
                                if (data.model.seqn == "")
                                    $('#fail_code').attr('disabled', false);
                                else
                                    $('#fail_code').attr('disabled', true);
                            }

                        } else
                            validationSummary.append('<li>' + data.err + '</li>');

                        $.unblockUI(); //畫面打開
                    }
                });
            }




    });
        //*---------------查詢 end ----------------*//





        //*---------------修改(申請覆核) begin ----------------*//
        $("#btnModify").click().on('click', function () {
            $('#validationSummary').children().remove();

            var bPass = true;

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            if ($('#fail_code_o').val() == $('#fail_code').val() & $('#seqn_o').val() == $('#seqn').val()) {
                validationSummary.append('<li>' + '未修改資料，將不進行覆核申請!!' + '</li>');
                bPass = false;
            }

            //add by daiyu 20210312
            if ($('#fail_code_o').val() != $('#fail_code').val() & $('#seqn_o').val() != $('#seqn').val()) {
                validationSummary.append('<li>' + '退匯原因、新處理序號：不可同時異動!!' + '</li>');
                bPass = false;
            }

            if ($('#seqn_o').val() != "" & $('#seqn').val() == "") {
                validationSummary.append('<li>' + '「新處理序號」不可修改為空值!!' + '</li>');
                bPass = false;
            }

            if ($('#fail_code').val() == "") {
                validationSummary.append('<li>' + '「退匯原因」不可修改為空值!!' + '</li>');
                bPass = false;
            }


            if (!bPass)
                return;


            $.blockUI();


            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: {
                        'currency': $('#currency').val()
                        , 'vhr_no1': $('#vhr_no1').val()
                        , 'pro_no': $('#pro_no').val()
                        , 'paid_id': $('#paid_id').val()
                        , 'fail_code': $('#fail_code').val()
                        , 'seqn': $('#seqn').val()
                    }
                }),
                dataType: "json",
                url: '@Url.Action("execSave", "ORT0104")',
                contentType: 'application/json',
                success: function (data) {

                    if (data.success) {
                        $("#btnModify").attr('disabled', true);

                        validationSummary.append('<li>' + '申請覆核成功!!' + '</li>');
                    } else {
                        validationSummary.append('<li>' + data.err + '</li>');
                    }

                    $.unblockUI();
                }
            });



        });
        //*---------------修改(申請覆核) end ----------------*//


    });
</script>


