@model FGL.Web.ViewModels.OGL00008Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;
    var opScope = ViewBag.opScope;
    var productTypeList = ViewBag.productTypeList as SelectList;
    var ynList = ViewBag.ynList as SelectList;
    var rule56List = ViewBag.rule56List as SelectList;
}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <table>
                    <tr>
                        <td>
                            <span style="color:red;">＊</span>@Html.DisplayNameFor(model => model.rule56)：@Html.DropDownList("rule56", rule56List, "請選擇")
                        </td>

                        <td>
                            @Html.DisplayNameFor(model => model.productType)：@Html.DropDownList("productType", productTypeList, "請選擇")
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span style="color:red;">＊</span>@Html.DisplayNameFor(model => model.fuMk)：@Html.DropDownList("fuMk", ynList, "請選擇")
                        </td>
                        <td>
                            生效日期：
                            <input id="effectDateB" name="effectDateB" type="text">
                            ~
                            <input id="effectDateE" name="effectDateE" type="text">
                        </td>
                    </tr>

                </table>

                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
  
                    </div>
                </div>

                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }



        </div>
    </div>

</div>



<script type="text/javascript">


    $(function () {
        $.unblockUI();
        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        }



        $('#effectDateB').datepicker({
            dateFormat: 'yyyy-mm-dd'
        });

        $('#effectDateE').datepicker({
            dateFormat: 'yyyy-mm-dd'
        });


        //*---------------查詢 begin ----------------*//
        $("#btnQry").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            //if ($("#productType").val().length == 0 && $("#rule56").val().length == 0
            //    && $("#fuMk").val().length == 0) {

            //    validationSummary.append('<li>' + '「險種類別」、「會科編碼類別」、「外幣註記」需輸入!!' + '</li>');
            //    return;
            //}

            if ($("#rule56").val().length == 0
                && $("#fuMk").val().length == 0) {

                validationSummary.append('<li>' + '「會科編碼類別」、「外幣註記」需輸入!!' + '</li>');
                return;
            }
                
            //生效日期檢核
            if (($("#effectDateB").val().length == 0 && $("#effectDateE").val().length > 0) || ($("#effectDateB").val().length > 0 && $("#effectDateE").val().length == 0)) {
                validationSummary.append('<li>' + '「生效日期起訖」均需輸入!!' + '</li>');
                return;
            } else if ($("#effectDateB").val().length > 0 & $("#effectDateE").val().length > 0) {
                if (!checkDate($("#effectDateB").val(), true)) {
                    validationSummary.append('<li>「生效日期起」格式錯誤!!</li>');
                    return;
                }

                if (!checkDate($("#effectDateE").val(), true)) {
                    validationSummary.append('<li>「生效日期訖」格式錯誤!!</li>');
                    return;
                }

                if ($("#effectDateE").val() < $("#effectDateB").val()) {
                    validationSummary.append('<li>「生效訖日期」不可小於「生效起日期」 !!</li>');
                    return;
                }
            }



            $.blockUI(); //畫面鎖起來

            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    productType: $("#productType").val(),
                    rule56: $("#rule56").val(),
                    fuMk: $("#fuMk").val(),
                    effectDateB: $("#effectDateB").val(),
                    effectDateE: $("#effectDateE").val()
                }),
                dataType: "json",
                url: '@Url.Action("LoadData", "OGL00008")',
                contentType: 'application/json',
                success: function (data) {

                    if (data.success) {
                        //更新畫面GRID
                        jQuery("#grid").jqGrid('clearGridData')
                            .jqGrid('setGridParam', { data: data.dataList })
                            .trigger("reloadGrid");


                        if (data.dataList.length == 0)
                            validationSummary.append('<li>' + '資料不存在!!"' + '</li>');


                    } else
                        validationSummary.append('<li>' + data.err + '</li>');

                    $.unblockUI(); //畫面打開
                }
            });
        });
        //*---------------查詢 end ----------------*//



        //*-------------------GRID begin--------------------*//
        $("#grid").jqGrid({
            editurl: 'clientArray',
            datatype: "local",
            jsonReader: {
                repeatitems: false, id: 'tempId'
            },
            colModel: [
                 {
                     label: 'tempId',
                     name: 'tempId', align: 'center', hidden: true,
                     editable: false, frozen: true,
                 },
                 {
                     label: '資料來源', width: 80, frozen: true,
                     name: 'srceFrom', align: 'center',
                     editable: false

                 },
                 {
                     label: '商品名稱', width: 250, frozen: true,
                     name: 'itemName', align: 'left',
                     editable: false

                 },
                {
                   label: '險種代號', width: 80, frozen: true,
                   name: 'item', align: 'center',
                   editable: false

                },

                {
                    label: '險種類別', width: 140, 
                    name: 'productTypeDesc', align: 'left',
                    editable: false

                },
                {
                    label: '外幣註記', width: 80, 
                    name: 'fuMk', align: 'center',
                    editable: false

                },
                {
                    label: '會科編碼類別', width: 120,
                    name: 'rule56Desc', align: 'center',
                    editable: false

                },
                {
                    label: '險種科目', width: 100, 
                    name: 'itemAcct', align: 'center',
                    editable: false

                },
                {
                    label: '分離帳科目', width: 100, 
                    name: 'separatAcct', align: 'center',
                    editable: false

                },
                {
                    label: 'COI科目', width: 100, 
                    name: 'coiAcct', align: 'center',
                    editable: false

                },
                {
                    label: '生效日', width: 100, 
                    name: 'effectDate', align: 'center',
                    editable: false

                },
                 {
                     label: '進件系統別', width: 100,
                     name: 'sysTypeDesc', align: 'center',
                     editable: false

                 },
                 {
                     label: '狀態說明', width: 150,
                     name: 'apprMkDesc', align: 'left',
                     editable: false

                 }

            ],
            autowidth: true,
            height: 'auto',
            width: 'auto',
            shrinkToFit: false,
            forceFit: false,
            pager: '#pager',
            loadonce: true,
            rownumbers: true,
            viewrecords: true,
            rowNum: 10,
            rowList: [10, 25, 50],
            resizeStop: function () {
                resizeColumnHeader.call(this);
                fixPositionsOfFrozenDivs.call(this);
                fixGboxHeight.call(this);
            }, 
            onSelectRow: function (tempId) {



            },
            loadComplete: function () {
                
                fixPositionsOfFrozenDivs.call(this);
            }
        });

        jQuery("#grid").jqGrid('setFrozenColumns');


        //處理凍結grid時...凍結行的高度與原grid行不一致問題
        resizeColumnHeader = function () {
            var rowHight, resizeSpanHeight,
                // get the header row which contains
                headerRow = $(this).closest("div.ui-jqgrid-view")
                    .find("table.ui-jqgrid-htable>thead>tr.ui-jqgrid-labels");

            // reset column height
            headerRow.find("span.ui-jqgrid-resize").each(function () {
                this.style.height = '';
            });

            // increase the height of the resizing span
            resizeSpanHeight = 'height: ' + headerRow.height() + 'px !important; cursor: col-resize;';
            headerRow.find("span.ui-jqgrid-resize").each(function () {
                this.style.cssText = resizeSpanHeight;
            });

            // set position of the dive with the column header text to the middle
            rowHight = headerRow.height();
            headerRow.find("div.ui-jqgrid-sortable").each(function () {
                var ts = $(this);
                ts.css('top', (rowHight - ts.outerHeight()) / 2 + 'px');
            });
        },
               fixPositionsOfFrozenDivs = function () {
                   var $rows;
                   if (typeof this.grid.fbDiv !== "undefined") {
                       $rows = $('>div>table.ui-jqgrid-btable>tbody>tr', this.grid.bDiv);
                       $('>table.ui-jqgrid-btable>tbody>tr', this.grid.fbDiv).each(function (i) {
                           var rowHight = $($rows[i]).height(), rowHightFrozen = $(this).height();
                           if ($(this).hasClass("jqgrow")) {
                               $(this).height(rowHight);
                               rowHightFrozen = $(this).height();
                               if (rowHight !== rowHightFrozen) {
                                   $(this).height(rowHight + (rowHight - rowHightFrozen));
                               }
                           }
                       });
                       $(this.grid.fbDiv).height(this.grid.bDiv.clientHeight);
                       $(this.grid.fbDiv).css($(this.grid.bDiv).position());
                   }
                   if (typeof this.grid.fhDiv !== "undefined") {
                       $rows = $('>div>table.ui-jqgrid-htable>thead>tr', this.grid.hDiv);
                       $('>table.ui-jqgrid-htable>thead>tr', this.grid.fhDiv).each(function (i) {
                           var rowHight = $($rows[i]).height(), rowHightFrozen = $(this).height();
                           $(this).height(rowHight);
                           rowHightFrozen = $(this).height();
                           if (rowHight !== rowHightFrozen) {
                               $(this).height(rowHight + (rowHight - rowHightFrozen));
                           }
                       });
                       $(this.grid.fhDiv).height(this.grid.hDiv.clientHeight);
                       $(this.grid.fhDiv).css($(this.grid.hDiv).position());
                   }
               },
               fixGboxHeight = function () {
                   var gviewHeight = $("#gview_" + $.jgrid.jqID(this.id)).outerHeight(),
                       pagerHeight = $(this.p.pager).outerHeight();

                   $("#gbox_" + $.jgrid.jqID(this.id)).height(gviewHeight + pagerHeight);
                   gviewHeight = $("#gview_" + $.jgrid.jqID(this.id)).outerHeight();
                   pagerHeight = $(this.p.pager).outerHeight();
                   $("#gbox_" + $.jgrid.jqID(this.id)).height(gviewHeight + pagerHeight);
               };

        //*-------------------GRID end--------------------*//




    });
</script>


