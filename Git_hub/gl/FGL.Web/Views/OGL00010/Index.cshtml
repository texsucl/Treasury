@using FGL.Web.Enum;
@using FGL.Web.Utilitys;
@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;

    var opScope = ViewBag.opScope;
}
<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <form id="OGL00010_Form">
                    <table>
                        <tr>
                            <td style="width: 120px;">
                                <label>退費類別 : </label>
                            </td>
                            <td>
                                <input type="text" id="OGL00010_payclass"/>
                            </td>
                        </tr>
                    </table>
                </form>
                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="button" class="btn btn-primary" id="OGL00010_Search" value="查詢" />
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="ShowOrNot">
        <div style="padding-bottom:10px;">
            <input type="button" id="OGL00010_Insert" value="新增" class="btn btn-primary" style="display:none;" />
            <input type="button" id="OGL00010_Print" value="列印" class="btn btn-primary"  style="display:none;" />
            <input type="button" id="OGL00010_UpdatePrint" value="列印異動" class="btn btn-primary"  style="display:none;"/>
        </div>
        <div class="col-sm-24">
            <div id="OGL00010jqgridDiv" class="jqd"></div>
        </div>
    </div>
    <div id="OGL00010OpenSearchDialog" style="display:none;" role="dialog" class="myDialog">
        <div id="OGL00010OpenSearchDetail"></div>
    </div>
    </div>



<script type="text/javascript">
    $(function () {

        var OGL00010url = {};
        OGL00010url.qryOGL00010 = '@Url.Action("qryOGL00010", "OGL00010")';
        OGL00010url.getData = '@Url.Action("GetCacheData", "OGL00010")';
        OGL00010url.Detail = '@Url.Action("Detail", "OGL00010")';
        OGL00010url.getReportParm = '@Url.Action("getReportParm", "OGL00010")';
        OGL00010url.getReportParmByCheck = '@Url.Action("getReportParmByCheck", "OGL00010")';
        OGL00010url.CheckChange = '@Url.Action("CheckChange", "OGL00010")';
        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');
        }

        //#region 註冊事件
        $('input:button').each(function () {
            var id = $(this).attr('id');
            switch (id) {
                case 'OGL00010_Search':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { OGL00010_SearchFun(); });
                    break;
                case 'OGL00010_Insert':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () {
                        OGL00010OpenPkIdFun('OGL00010TempList', -1, '@Ref.ActionType.Add.ToString()', '@Ref.ActionType.Add.GetDescription()');
                    });
                    break;
                case 'OGL00010_Print':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () {
                        $.blockUI(); //畫面鎖起來
                        $.ajax({
                            type: "POST",
                            dataType: "json",
                            url: OGL00010url.getReportParm,
                            contentType: 'application/json'
                        }).done(function (result) {
                            if (result.RETURN_FLAG) {
                                var parms = [];
                                parms.push(customerUtility.reportParm('payclass', result.Datas));
                                customerUtility.report(
                                customerUtility.reportModel('退費類別明細', 'OGL00010'),
                                parms,
                                null);
                            }
                            else {
                                alert(result.DESCRIPTION);
                            }
                            $.unblockUI(); //畫面打開
                        });
                    });
                    break;
                case 'OGL00010_UpdatePrint':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () {
                        var parms = [];
                        customerUtility.report(
                        customerUtility.reportModel('退費類別設定/異動表', 'OGL00010HIS'),
                        parms,
                        null);
                        //$.blockUI(); //畫面鎖起來
                        //$.ajax({
                        //    type: "POST",
                        //    dataType: "json",
                        //    url: OGL00010url.getReportParmByCheck,
                        //    contentType: 'application/json'
                        //}).done(function (result) {
                        //    if (result.RETURN_FLAG) {
                        //        var parms = [];
                        //        parms.push(customerUtility.reportParm('pk_ids', result.Datas));
                        //        customerUtility.report(
                        //        customerUtility.reportModel('退費類別設定/異動表', 'OGL00010HIS'),
                        //        parms,
                        //        null);
                        //    }
                        //    else {
                        //        alert(result.DESCRIPTION);
                        //    }
                        //    $.unblockUI(); //畫面打開
                        //});
                    });
                    break;
            }
        });

        function OGL00010_SearchFun() {
            jqgridCustom.clearJqgrid('OGL00010jqgridDiv');
            $('#OGL00010_Print,#OGL00010_UpdatePrint,#OGL00010_Insert').hide();
            $('#validationSummary').children().remove();
            var validationSummary = $('#validationSummary ul.validation-summary-errors');
            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            $.blockUI(); //畫面鎖起來
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    payclass: $('#OGL00010_payclass').val()
                }),
                dataType: "json",
                url: OGL00010url.qryOGL00010,
                contentType: 'application/json',
            }).done(function (result) {
                $('#OGL00010_Insert').show();
                if (result.RETURN_FLAG) {
                    OGL00010Data();
                    $('#OGL00010_Print,#OGL00010_UpdatePrint').show();
                }
                else {
                    validationSummary.append('<li>' + result.DESCRIPTION + '</li>');
                }
                $.unblockUI(); //畫面打開
            });
        }

        function formatterCheck(cellvalue, options, rdata) {
            var str = '';
            if (rdata.data_status == "2") {
                str = "<input type='checkbox' class = 'UpdateIschecked' id='" + options.gid + options.colModel.index + options.rowId + "'  title= ' '" + (rdata.Ischecked == true ? 'checked' : ' ') + " />";
            }
            return str;
        }

        function OGL00010Data() {
            var colNameArray = ['動作', '資料狀態', '退費項目類別', '說明', '險種否', '年次否', '保費類別否',
                '費用單位否', '送金單否', '合約別否', '帳本否', '執行功能_h', '資料狀態_h', 'pk_id', '異動列印', '執行功能'];
            var colModelArray = [];
            colModelArray.push({ name: "act", index: "act", width: 90, sortable: false });
            colModelArray.push({ name: "data_status_D", index: "data_status_D", width: 70, sortable: false, align: 'center' });
            colModelArray.push({ name: "pay_class", index: "pay_class", width: 95, sortable: false, align: 'center' });
            colModelArray.push({ name: "memo_n", index: "memo_n", width: 275, sortable: false });
            colModelArray.push({ name: "item_yn_n", index: "item_yn_n", width: 50, sortable: false, align: 'center' });
            colModelArray.push({ name: "year_yn_n", index: "year_yn_n", width: 50, sortable: false, align: 'center' });
            colModelArray.push({ name: "prem_yn_n", index: "prem_yn_n", width: 79, sortable: false, align: 'center' });
            colModelArray.push({ name: "unit_yn_n", index: "unit_yn_n", width: 79, sortable: false, align: 'center' });
            colModelArray.push({ name: "recp_yn_n", index: "recp_yn_n", width: 69, sortable: false, align: 'center' });
            colModelArray.push({ name: "cont_yn_n", index: "cont_yn_n", width: 69, sortable: false, align: 'center' });
            colModelArray.push({ name: "corp_yn_n", index: "corp_yn_n", width: 50, sortable: false, align: 'center' });
            colModelArray.push({ name: "exec_action", index: "exec_action", hidden: true });
            colModelArray.push({ name: "data_status", index: "data_status", hidden: true });
            colModelArray.push({ name: "pk_id", index: "pk_id", hidden: true });
            colModelArray.push({ name: "Ischecked", index: "Ischecked", hidden: true, width: 70, sortable: false, align: 'center', formatter: formatterCheck });
            colModelArray.push({ name: "exec_action_D", index: "exec_action_D", hidden: true, width: 70, sortable: false, align: 'center' });
            jqgridCustom.createJqgridByCache(
                'OGL00010jqgridDiv',
                'OGL00010TempList',
                'OGL00010TempPeger',
                OGL00010url.getData,
                {
                    type: "OGL00010ViewData"
                },
                colNameArray,
                colModelArray,
                '退費類別設定作業',
                jqgridCustom.getPage('OGL00010jqgridDiv'),
                jqgridCustom.getRowNum('OGL00010jqgridDiv'),
                OGL00010TempCompleteFun,
                true
                );
        }

        //region 打勾事件
        function forChecked(rowid, flag) {
            var listId = 'OGL00010TempList';
            var data = $("#" + listId).getRowData(rowid);
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    pk_id: data.pk_id,
                    flag: flag
                }),
                dataType: "json",
                url: OGL0001Aurl.CheckChange,
                contentType: 'application/json',
            }).done(function (result) {
                if (result.RETURN_FLAG) {
                    $("#OGL00010_UpdatePrint").prop('disabled', !result.Datas);
                }
            });
        }
        //#endregion

        function OGL00010TempCompleteFun(listId) {
            jqgridCustom.randerAction(listId, 'OGL00010_Search', OGL00010ActFun);
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                //CheckBox
                $(this).find('td').find('.UpdateIschecked').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        forChecked(i + 1, $(this).prop('checked'));
                    });
                });
                var tr = $(this);
                var status = tr.find($.validator.format('td[aria-describedby$={0}_data_status]', listId)).text();
                if (status == '2') { //資料異動中不能刪除
                    $(this).find('.actionDeleIcon').hide();
                    $(this).find('.actionEditIcon').hide();
                }
            });
        }

        var OGL00010ActFun = {};
        OGL00010ActFun.Edit = function (i) {
            OGL00010OpenPkIdFun('OGL00010TempList', i, '@Ref.ActionType.Edit.ToString()', '@Ref.ActionType.Edit.GetDescription()');
        }
        OGL00010ActFun.Dele = function (i) {
            OGL00010OpenPkIdFun('OGL00010TempList', i, '@Ref.ActionType.Dele.ToString()', '@Ref.ActionType.Dele.GetDescription()');
        }
        OGL00010ActFun.View = function (i) {
            OGL00010OpenPkIdFun('OGL00010TempList', i, '@Ref.ActionType.View.ToString()', '@Ref.ActionType.View.GetDescription()');
        }

        function openOGL00010DetailDialog(title, width, dialogId) {
            title = title || '';
            width = width || 'auto';
            $('#' + dialogId).dialog({
                position: { my: "top", at: "center top", of: window },
                title: title,
                width: width,
                autoOpen: false,
                resizable: false,
                maxHeight: 800,
                closeText: '取消',
                close: function () {
                    OGL00010Data();
                }
            });
            $('#' + dialogId).dialog('open');
        }

        function OGL00010OpenPkIdFun(listId, rowid, action, Description) {
            var _pk_id = '';
            if (rowid != -1) {
                _pk_id = $("#" + listId).getRowData(rowid).pk_id;
            }
            $.blockUI(); //畫面鎖起來
            $.ajax({
                type: 'POST',
                data: JSON.stringify({
                    pk_id: _pk_id,
                    action: action
                }),
                dataType: 'html',
                url: OGL00010url.Detail,
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    $('#OGL00010OpenSearchDetail').html(data);
                    $.unblockUI(); //畫面打開
                    openOGL00010DetailDialog(Description + '退費類別設定', '970px', 'OGL00010OpenSearchDialog');
                }
            })
        }
    });
</script>


