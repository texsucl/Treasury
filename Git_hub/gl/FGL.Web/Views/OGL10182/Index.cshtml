@model FGL.Web.ViewModels.OGL10182Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = ViewBag.funcName;
    //Layout = "~/Views/Shared/_Layout.cshtml";

    var productTypeList = ViewBag.productTypeList as SelectList;
    var acctTypeList = ViewBag.acctTypeList as SelectList;

    var opScope = ViewBag.opScope;
}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                @Html.Hidden("hidProductType", "")
                @Html.Hidden("hidAcctType", "")
                @Html.Hidden("hidExecAction", "")
                @Html.Hidden("hidAplyNo", "")
                <table>
                    <tr>
                        <td colspan="2">
                            @Html.DisplayNameFor(model => model.isQryTmp)：@Html.CheckBox("isQryTmp", false)
                        </td>
                        </tr>
                    <tr>

                        <td>
                            @Html.DisplayNameFor(model => model.smpNum)：@Html.TextBoxFor(model => model.smpNum, new {@size = "5", @maxlength = "4" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.productType)：@Html.DropDownList("productType", productTypeList, "請選擇")
                        </td>
                    </tr>

                    <tr>

                        <td>
                            @Html.DisplayNameFor(model => model.corpNo)：@Html.TextBoxFor(model => model.corpNo, new { @size = "2", @maxlength = "1" })
                        </td>
                        <td>
                            @Html.DisplayNameFor(model => model.acctType)：@Html.DropDownList("acctType", acctTypeList, "請選擇")
                        </td>
                    </tr>
                </table>


                <div class="row">
                    <div class="col-sm-24" style="text-align:center;">
                        <input type="submit" id="btnQry" name="btnQry" value="查詢" class="btn btn-primary" />
                        <input type="submit" id="btnModify" name="btnModify" value="申請覆核" class="btn btn-primary" />
                        <input type="submit" id="btnDelTmp" name="btnDelTmp" value="刪除暫存資料" class="btn btn-primary" />
                        <input type="submit" id="btnQryHis" name="btnQryHis" value="查詢歷史資料" class="btn btn-primary" />
                        <input type="submit" id="btnClear" name="btnClear" value="清空" class="btn btn-primary" />
                    </div>
                </div>
                <br>
                @Html.Hidden("onEdit", "")
                @Html.Hidden("valueErr", "")
                <button id="btnNew" name="btnNew" class="btn btn-primary">新增</button>
                <button id="btnCopy" name="btnCopy" class="btn btn-primary">複製</button>
                <div class="row">
                    <div id="qryResult" class="col-sm-24">
                        <table id="grid"></table>
                        <div id="pager"></div>
                    </div>
                </div>
            }



        </div>
    </div>

</div>



<script type="text/javascript">
    var lastSelectRoot = "";

    //新增
    $("#btnNew").on("click", function () {
        if ($("#onEdit").val() == "Y")
            return;

        $("#grid").jqGrid('addRow', "new", { addParams: { position: "last" } });
        var sel_id = $('#grid').jqGrid('getGridParam', 'selrow');
        $("#grid").jqGrid("setCell", sel_id, "execAction", "A");

        be = "<input class=\"edit\" style='height:28px;width:50px; visibility: hidden;' type='button' id='btn_edit_" + sel_id + "' value='修改' onclick=\" TheOnEditFunction ('" + sel_id + "');\"  />";
        de = "<input class=\"del\" style='height:28px;width:50px; visibility: hidden;' type='button' id='btn_del_" + sel_id + "' value='刪除' onclick=\" TheOnDelFunction ('" + sel_id + "');\"  />";

        se = "<input class=\"save\" style='height:28px;width:50px; ' type='button' id='btn_save_" + sel_id + "' value='儲存' onclick=\"TheOnSaveFunction('" + sel_id + "');\"  />";
        ce = "<input class=\"cancel\" style='height:28px;width:50px; ' type='button' id='btn_cancel_" + sel_id + "'  value='取消' onclick=\"TheOnCancelFunction('" + sel_id + "');\"  />";
        jQuery("#grid").jqGrid('setRowData', sel_id, { Action: be + de + se + ce });
        $("#btn_edit_" + sel_id).hide();
        $("#btn_del_" + sel_id).hide();
        $("#onEdit").val("Y");

        lastSelectRoot = sel_id;

    });


    //複製
    $("#btnCopy").on("click", function () {
        if ($("#onEdit").val() == "Y")
            return;

        var sel_idF = $('#grid').jqGrid('getGridParam', 'selrow');
        //alert(sel_idF);
        if (sel_idF == null) {
            alert("請點選要複製的來源資料!!");
            return;
        } else {
            rowData = $("#grid").jqGrid('getRowData', sel_idF);
        }

        var smpNum = rowData.smpNum;
        var productType = rowData.productType;
        var corpNo = rowData.corpNo;
        var acctType = rowData.acctType;
        var sqlActNum = rowData.sqlActNum;
        var sqlActNm = rowData.sqlActNm;

        $("#grid").jqGrid('addRow', "new", { addParams: { position: "last" } });
        var sel_id = $('#grid').jqGrid('getGridParam', 'selrow');
        jQuery("#grid").editRow(sel_id);

        $("#grid").jqGrid("setCell", sel_id, "execAction", "A");
        $('#' + sel_id + '_smpNum').val(smpNum);
        $('#' + sel_id + '_productType').val(productType);
        $('#' + sel_id + '_corpNo').val(corpNo);
        $('#' + sel_id + '_acctType').val(acctType);
        $('#' + sel_id + '_sqlActNum').val(sqlActNum);
        $('#' + sel_id + '_sqlActNm').val(sqlActNm);


        be = "<input class=\"edit\" style='height:28px;width:50px; visibility: hidden;' type='button' id='btn_edit_" + sel_id + "' value='修改' onclick=\" TheOnEditFunction ('" + sel_id + "');\"  />";
        de = "<input class=\"del\" style='height:28px;width:50px; visibility: hidden;' type='button' id='btn_del_" + sel_id + "' value='刪除' onclick=\" TheOnDelFunction ('" + sel_id + "');\"  />";

        se = "<input class=\"save\" style='height:28px;width:50px; ' type='button' id='btn_save_" + sel_id + "' value='儲存' onclick=\"TheOnSaveFunction('" + sel_id + "');\"  />";
        ce = "<input class=\"cancel\" style='height:28px;width:50px; ' type='button' id='btn_cancel_" + sel_id + "'  value='取消' onclick=\"TheOnCancelFunction('" + sel_id + "');\"  />";
        jQuery("#grid").jqGrid('setRowData', sel_id, { Action: be + de + se + ce });
        $("#btn_edit_" + sel_id).hide();
        $("#btn_del_" + sel_id).hide();
        $("#onEdit").val("Y");

        lastSelectRoot = sel_id;

    });



    //jqgrid中的刪除
    function TheOnDelFunction(rowid) {
        if ($("#onEdit").val() == "Y") {
            alert("畫面仍有資料在編輯中，不可修改!!");
            return;
        } else {
            if (window.confirm('您確定要刪除嗎？') == true) {
                chkData(rowid, "Delete");
                //$("#grid").jqGrid('delRowData', rowid);
                //jQuery("#grid").trigger("reloadGrid");
            }

        }
    }


    //jqgrid中的修改
    function TheOnEditFunction(rowid) {
        if ($("#onEdit").val() == "Y") {
            alert("畫面仍有資料在編輯中，不可修改!!");
            return;
        } else {
            var rowData = jQuery("#grid").jqGrid("getRowData", rowid);

            jQuery("#grid").setSelection(rowid, true);
            jQuery("#grid").editRow(rowid);


            //alert("rowid is " + rowid);
            $("#btn_save_" + rowid).css("visibility", "visible");
            $("#btn_cancel_" + rowid).css("visibility", "visible");

            $("#btn_edit_" + rowid).css("visibility", "hidden");
            $("#btn_del_" + rowid).css("visibility", "hidden");
            $("#btn_edit_" + rowid).hide();
            $("#btn_del_" + rowid).hide();
            $("#btn_save_" + rowid).show();
            $("#btn_cancel_" + rowid).show();

            $("#onEdit").val("Y");
            lastSelectRoot = rowid;
        }

    }



    //檢查該筆資料是否合法
    function chkData(rowid, execBtn) {
        var execAction = "";

        var smpNum = "";
        var corpNo = "";
        var productType = "";
        var acctType = "";
        var sqlActNum = "";
        var sqlActNm = "";

        var errMsg = "";
        rowData = $("#grid").jqGrid('getRowData', rowid);
        status = rowData.status;
        execAction = rowData.execAction;

        if (execBtn == "Edit") {

            //var rowid = $('#grid').jqGrid('getGridParam', 'selrow');

            smpNum = $("#" + rowid + "_smpNum").val();
            corpNo = $("#" + rowid + "_corpNo").val();
            productType = $("#" + rowid + "_productType").val();
            acctType = $("#" + rowid + "_acctType").val();
            sqlActNum = $("#" + rowid + "_sqlActNum").val();
            sqlActNm = $("#" + rowid + "_sqlActNm").val();

            //欄位檢核-科目代號
            if (!checkNum(smpNum) || smpNum.length != 4)
                errMsg += "　'科目代號'錯誤，請輸入4碼數字！";

            //欄位檢核-帳本
            if ("1" == corpNo || "3" == corpNo || "7" == corpNo || "9" == corpNo) {

            } else {
                errMsg += "　'帳本'錯誤，僅能輸入1、3、7或9！";
            }

            //欄位檢核-SQL會計科目
            if (!checkNum(sqlActNum))
                errMsg += "　'SQL會計科目'錯誤，請輸入數字！";


            //欄位檢核-SQL會計科目名稱
            if (sqlActNm == "")
                errMsg += "　請輸入'SQL會計科目名稱'！";


            var gridData = $("#grid").jqGrid('getGridParam', 'data');

            for (i = 0, count = gridData.length; i < count; i += 1) {

                if (rowData.tempId != gridData[i].tempId
                    && smpNum == gridData[i].smpNum
                    && productType == gridData[i].productType
                    && acctType == gridData[i].acctType
                    && corpNo == gridData[i].corpNo)
                    errMsg += "　資料重覆請確認";
            }



            if (errMsg != "") {
                $("#valueErr").val("Y");
                alert(errMsg);
                return;
            } else {
                jQuery("#grid").saveRow(rowid, false);

                //if (rowData.tempId.indexOf("jqg") < 0 && rowData.tempId.length > 0) {
                //    $("#grid").jqGrid("setCell", rowid, "execAction", "U");
                //}

                writeScreenToHis(rowid, "U");

                $("#valueErr").val("");
                DisplayEditButton(rowid);
            }


        } else {

            rowData = $("#grid").jqGrid('getRowData', rowid);
            //if (rowData.tempId.indexOf("jqg") < 0 && rowData.tempId.length > 0) {
            //    $("#grid").jqGrid("setCell", rowid, "execAction", "D");
            //} else {
            //    $("#grid").jqGrid('delRowData', rowid);
            //    jQuery("#grid").trigger("reloadGrid");
            //}

            writeScreenToHis(rowid, "D");
        }
    }


    //jqgrid中的儲存
    function TheOnSaveFunction(rowid) {
        chkData(rowid, "Edit")
        //jQuery("#grid").saveRow(rowid, false);
        //if ($("#valueErr").val() == "Y") {
        //} else {

        //    DisplayEditButton(rowid);

        //}
    }


    //jqgrid中的取消
    function TheOnCancelFunction(rowid) {
        jQuery("#grid").restoreRow(rowid);


        $("#btn_save_" + rowid).css("visibility", "hidden");
        $("#btn_cancel_" + rowid).css("visibility", "hidden");

        $("#btn_edit_" + rowid).css("visibility", "visible");
        $("#btn_del_" + rowid).css("visibility", "visible");
        $("#btn_edit_" + rowid).show();
        $("#btn_del_" + rowid).show();
        $("#btn_save_" + rowid).hide();
        $("#btn_cancel_" + rowid).hide();

        $("#valueErr").val("");
        $("#onEdit").val("");
        lastSelectRoot = "";
    }



    function DisplayEditButton(rowid) {
        if ($("#valueErr").val() == "Y") {
        } else {
            jQuery("#grid").trigger("reloadGrid");
            $("#btn_save_" + rowid).css("visibility", "hidden");
            $("#btn_cancel_" + rowid).css("visibility", "hidden");

            $("#btn_edit_" + rowid).css("visibility", "visible");
            $("#btn_del_" + rowid).css("visibility", "visible");
            $("#btn_edit_" + rowid).show();
            $("#btn_del_" + rowid).show();
            $("#btn_save_" + rowid).hide();
            $("#btn_cancel_" + rowid).hide();

            $("#onEdit").val("");
            $("#valueErr").val("");
            lastSelectRoot = "";

        }
    }

    function writeScreenToHis(rowid, execAction) {
        //if ($("#hidAplyNo").val() == "") {
        //    chkProductStatus(rowid, execAction);
        //} else
            procHisDetail(rowid, execAction);
    }


    function chkProductStatus(rowid, execAction) {

        $.blockUI(); //畫面鎖起來
        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }

        $.ajax({
            type: "POST",
            data: JSON.stringify({
                model: {
                    'qryTable': $('#isQryTmp')[0].checked == true ? "1" : "0",
                    'smpNum': $('#smpNum').val()
                }
                //, 'acctList': acctList
            }),
            dataType: "json",
            url: '@Url.Action("chkProductStatus", "OGL10181")',
            contentType: 'application/json',
            success: function (data) {


                if (data.success) {

                    if (data.tmpStatus0Cnt > 0
                        & ($("#hidAplyNo").val() == "")) {
                        if (window.confirm('此商品科目資料已有暫存資料，將不予異動，是否改查暫存資料?') == true) {
                            $("#isQryTmp").prop("checked", true);
                            qryDetail();

                            return;
                        } else {
                            qryDetail();
                            //$.unblockUI(); //畫面打開
                            return;
                        }
                    }


                    procHisDetail(rowid, execAction);


                } else {
                    validationSummary.append('<li>' + data.err + '</li>');

                    $.unblockUI(); //畫面打開
                }
                    
            }
        });


    }



    function procHisDetail(rowid, execAction) {

        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }

        rowData = $("#grid").jqGrid('getRowData', rowid);
        $.blockUI(); //畫面鎖起來
        $.ajax({
            type: "POST",
            data: JSON.stringify({
                model: {
                    
                    'qryTable': $('#isQryTmp')[0].checked == true ? "1" : "0",
                    'tempId': rowData.tempId,
                    'smpNum': rowData.smpNum,
                    'productType': rowData.productType,
                    'corpNo': rowData.corpNo,
                    'acctType': rowData.acctType,
                    'sqlActNum': rowData.sqlActNum,
                    'sqlActNm': rowData.sqlActNm
                }, 'execAction': execAction

            }),
            dataType: "json",
            url: '@Url.Action("procHisDetail", "OGL10182")',
            contentType: 'application/json',
            success: function (data) {
                $.unblockUI(); //畫面打開
                if (data.success) {
                   // $("#hidAplyNo").val(data.aplyNo);
                    //$("#hidApprStat").val("0");
                    $("#isQryTmp").prop("checked", true);
                    $("#btnDelTmp").prop("disabled", false);
                    qryDetail();
                } else {
                    TheOnEditFunction(rowid);
                    validationSummary.append('<li>' + data.err + '</li>');
                }
            }
        });
    }


    //刪除暫存資料
    $("#btnDelTmp").on("click", function () {
        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }

        var bTemp = false;
        var gridData = $("#grid").jqGrid('getGridParam', 'data');
        for (j = 0; j <= gridData.length - 1; j++) {
            rowData = gridData[j];
            if (rowData.execAction != "" & rowData.dataStatus == "1")
                bTemp = true;
        }


        if (bTemp == false) {
            validationSummary.append('<li>該科目申請覆核且資料凍結中，無法進行維護作業。</li>');
            return;
        }


        if (window.confirm('是否刪除畫面上的暫存資料?') == false) {
            return
        }
        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }


        $.blockUI(); //畫面鎖起來
        $.ajax({
            type: "POST",
            data: JSON.stringify({
                'smpNum': $("#smpNum").val(), 'productType': $("#productType").val()
        , 'corpNo': $("#corpNo").val(), 'acctType': $("#acctType").val()
            }),
            dataType: "json",
            url: '@Url.Action("delTmp", "OGL10182")',
            contentType: 'application/json',
            success: function (data) {
                $.unblockUI(); //畫面打開
                if (data.success) {
                    qryDetail();
                } else {
                    validationSummary.append('<li>' + data.err + '</li>');
                }
            }
        });

    });


    //查詢歷史資料
    $("#btnQryHis").on("click", function () {

        var url = '@Html.Raw(Url.Action("aplyHis", "OGL10182"))';
        var params = url;
        window.location.href = params;

    });


    //*---------------查詢 begin ----------------*//
    function qryDetail() {
        $.unblockUI(); //畫面打開
        $('#validationSummary').children().remove();

        var validationSummary = $('#validationSummary ul.validation-summary-errors');

        if (validationSummary.length == 0) {
            $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
            validationSummary = $('#validationSummary ul.validation-summary-errors');
        }


        if ($('#smpNum').val().length == 0 && $('#productType').val() == ""
            && $('#acctType').val() == "" && $('#corpNo').val().length == 0) {
            validationSummary.append('<li>' + '請輸入一個以上的查詢條件!!"' + '</li>');
            return;
        }

        $('#smpNum').attr('disabled', true);
        $('#productType').attr('disabled', true);
        $('#corpNo').attr('disabled', true);
        $('#acctType').attr('disabled', true);

        $('#btnQry').attr('disabled', true);
        $('#btnNew').attr('disabled', false);
        $('#btnCopy').attr('disabled', false);
        $('#btnModify').attr('disabled', false);
        $('#btnDelTmp').attr('disabled', false);

        var jsonData = JSON.stringify({
            'isQryTmp': $('#isQryTmp')[0].checked == true ? "1" : "0",
            'smpNum': $("#smpNum").val(), 'productType': $("#productType").val()
        , 'corpNo': $("#corpNo").val(), 'acctType': $("#acctType").val()
        });

        $.blockUI(); //畫面鎖起來

        $.ajax({
            type: "POST",
            data: jsonData,
            dataType: "json",
            url: '@Url.Action("qryFglsmpa", "OGL10182")',
            contentType: 'application/json',
            success: function (data) {

                if (data.success) {
                    //更新畫面GRID
                    jQuery("#grid").jqGrid('clearGridData')
                        .jqGrid('setGridParam', { data: data.dataList })
                        .trigger("reloadGrid");


                    if (data.dataList.length == 0)
                        validationSummary.append('<li>' + '資料不存在，請進行新增維護!!"' + '</li>');
                    else {
                        if ($('#isQryTmp')[0].checked == true) {
                            $('#btnDelTmp').attr('disabled', false);
                        }
                    }
                } else
                    validationSummary.append('<li>' + data.err + '</li>');

                $.unblockUI(); //畫面打開
            }
        });
    }
    //*---------------查詢 end ----------------*//

    $(document).click(function (e) {
        if ($("#onEdit").val() == "Y" & e.target.id != "btnNew" & e.target.id != "btnClear") {
            if (e.target.id.indexOf(lastSelectRoot) < 0) {
                alert("畫面仍有資料在編輯中，不可執行其它功能!!");
                return
            }

        }

    });

    //取得"險種類別"下拉選單
    function getProductType() {
        return $('#hidProductType').val();
    }

    //取得"帳務類別"下拉選單
    function getAcctType() {
        return $('#hidAcctType').val();
    }


    //取得"執行功能"下拉選單
    function getExecAction() {
        return $('#hidExecAction').val();
    }

    $(function () {
        $(window).bind('resize', function () {
            var newWidth = $("#grid").closest(".ui-jqgrid").parent().width();
            jQuery("#grid").setGridWidth(newWidth, false);
        }).trigger('resize');

        $.unblockUI();
        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {
            $('#btnModify').attr('disabled', true);
            $('#btnNew').attr('disabled', true);
            $('#hidProductType').val('@Html.Raw(ViewBag.productTypejqList)');
            $('#hidAcctType').val('@Html.Raw(ViewBag.acctTypejqList)');
            $('#hidExecAction').val('@Html.Raw(ViewBag.execActionjqList)');
        }


        //*---------------清除 begin ----------------*//
        $("#btnClear").click().on('click', function () {
            $('#validationSummary').children().remove();

            $('#smpNum').attr('disabled', false);
            $('#productType').attr('disabled', false);
            $('#corpNo').attr('disabled', false);
            $('#acctType').attr('disabled', false);

            $('#smpNum').val("");
            $('#productType').val("");
            $('#corpNo').val("");
            $('#acctType').val("");

            $('#btnModify').attr('disabled', true);
            $('#btnNew').attr('disabled', true);
            $('#btnQry').attr('disabled', false);

            $("#isQryTmp").prop("checked", false);

            $("#valueErr").val("");
            $("#onEdit").val("");
            lastSelectRoot = "";


            jQuery("#grid").jqGrid('clearGridData').trigger("reloadGrid");
        });
        //*---------------清除 end ----------------*//



        //*---------------查詢 begin ----------------*//
        $("#btnQry").click().on('click', function () {
            qryDetail();
    });

        //*---------------查詢 end ----------------*//



        //*-------------------科目樣本對應SQL會科資料GRID begin--------------------*//
        $("#grid").jqGrid({
            editurl: 'clientArray',
            datatype: "local",
            //caption: '科目樣本險種類別',
            jsonReader: {
                repeatitems: false, id: 'tempId'
            },
            colModel: [
                {
                    label: "修改/刪除", name: 'Action', index: 'Action', search: false, align: 'center', width: 120
                },
                 {
                     label: 'tempId',
                     name: 'tempId', align: 'center', hidden: true,
                     editable: false,
                 },
                 {
                     label: '執行功能',
                     name: 'execAction', align: 'left', width: 90,
                     editable: false,
                     edittype: "select",
                     formatter: 'select',
                     editoptions: {
                         value: getExecAction()
                     }

                 },
                {
                    label: '科目代號',
                    name: 'smpNum', align: 'center', width: 70,
                    editable: true,
                    //editrules: { custom: true, custom_func: chkSmpNum },
                    editoptions: {
                        size: 4,
                        maxlength: 4
                    }

                },
                {
                    label: '險種類別',
                    name: 'productType', align: 'left', width: 180,
                    editable: true,
                    edittype: "select",
                    formatter: 'select',
                    editoptions: {
                        value: getProductType()
                    }

                },
                {
                    label: '帳本',
                    name: 'corpNo', align: 'center', width: 50,
                    editable: true,
                    //editrules: { custom: true, custom_func: chkCorpNo },
                    editoptions: {
                        size: 1,
                        maxlength: 1
                    }

                },
                {
                    label: '帳務類別',
                    name: 'acctType', align: 'left', width: 180,
                    editable: true,
                    edittype: "select",
                    formatter: 'select',
                    editoptions: {
                        value: getAcctType()
                    }

                },
                {
                    label: 'SQL會計科目',
                    name: 'sqlActNum', align: 'center', width: 100,
                    editable: true,
                    //editrules: { custom: true, custom_func: chkSqlActNum },
                    editoptions: {
                        size: 10,
                        maxlength: 10
                    }

                },
                 {
                     label: 'SQL會計名稱',
                     name: 'sqlActNm', align: 'left', width: 250,
                     editable: true,
                     edittype: 'textarea',
                     //editrules: { custom: true, custom_func: chkSqlActNm },
                     editoptions: {
                         size: 20,
                         maxlength: 20
                     }

                 },
                {
                    label: '資料狀態',
                    name: 'dataStatus', align: 'center', hidden: true,
                    editable: false,
                },
                {
                    label: '資料狀態',
                    name: 'dataStatusDesc', align: 'center', width: 80,
                    editable: false

                },
                {
                    label: '最後異動人員',
                    name: 'updateUName', width: 100,
                    align: 'center',
                    editable: false
                },
                {
                    label: '異動日期',
                    name: 'updateDatetime', width: 150,
                    align: 'center',
                    editable: false
                }
            ],
            autowidth: true,
            height: 'auto',
            width: 'auto',
            shrinkToFit: false,
            forceFit: false,
            loadonce: true,
            rownumbers: true,
            rowNum: 10,
            rowList: [10, 25, 50],
            viewrecords: true,
            pager: "#pager",
            onSelectRow: function (tempId) {



            },
            loadComplete: function () {
                if ($("#valueErr").val() == "Y") {
                } else {
                    var ids = jQuery("#grid").jqGrid('getDataIDs');
                    for (var i = 0; i < ids.length; i++) {
                        var rowId = ids[i];
                        be = "<input class=\"edit\" style='height:28px;width:50px; ' type='button' id='btn_edit_" + rowId + "' value='修改' onclick=\"TheOnEditFunction('" + rowId + "');\"  />";

                        de = "<input class=\"del\" style='height:28px;width:50px;' type='button' id='btn_del_" + rowId + "' value='刪除' onclick=\" TheOnDelFunction ('" + rowId + "');\"  />";

                        se = "<input class=\"save\" style='height:28px;width:50px; ' type='button' id='btn_save_" + rowId + "' value='儲存' onclick=\"TheOnSaveFunction('" + rowId + "');\"  />";
                        ce = "<input class=\"cancel\" style='height:28px;width:50px; visibility: hidden;' type='button' id='btn_cancel_" + rowId + "'  value='取消' onclick=\"TheOnCancelFunction('" + rowId + "');\"  />";
                        jQuery("#grid").jqGrid('setRowData', ids[i], { Action: be + de + se + ce });

                        $("#btn_save_" + rowId).hide();
                        $("#btn_cancel_" + rowId).hide();


                        rowData = $("#grid").jqGrid('getRowData', rowId);
                        if (rowData.dataStatus == "2") {
                            $("#btn_edit_" + rowId).hide();
                            $("#btn_del_" + rowId).hide();
                        }

                    }
                }

            }
        });

        //*-------------------科目樣本險種類別GRID end--------------------*//

        //欄位檢核-科目代號
        function chkSmpNum(value, colname) {
            if (!checkNum(value) || value.length != 4) {
                $("#valueErr").val("Y");
                return [false, "'科目代號'錯誤，請輸入4碼數字！"];
            }
            else {
                $("#valueErr").val("");
                return [true, ""];
            }
        }


        //欄位檢核-帳本
        function chkCorpNo(value, colname) {
            if ("1" == value || "3" == value || "7" == value || "9" == value) {
                $("#valueErr").val("");
                return [true, ""];
            } else {
                $("#valueErr").val("Y");
                return [false, "'帳本'錯誤，僅能輸入1、3、7或9！"];
            }
        }

        //欄位檢核-SQL會計科目
        function chkSqlActNum(value, colname) {
            if (!checkNum(value)) {
                $("#valueErr").val("Y");
                return [false, "'SQL會計科目'錯誤，請輸入數字！"];
            }
            else {
                $("#valueErr").val("");
                return [true, ""];
            }

        }

        //欄位檢核-SQL會計科目名稱
        function chkSqlActNm(value, colname) {
            if (value == "") {
                $("#valueErr").val("Y");
                return [false, "請輸入'SQL會計科目名稱'！"];
            }
            else {
                $("#valueErr").val("");
                return [true, ""];
            }

        }


        //*---------------修改(申請覆核) begin ----------------*//
        $("#btnModify").click().on('click', function () {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }


            var bPass = true;

            if ($('#onEdit').val() == "Y") {
                bPass = false;
                validationSummary.append('<li>' + '畫面尚有資料未存檔!!' + '</li>');
            }




            if (bPass == false)
                return;


            //var smpaData = $("#grid").jqGrid('getRowData');
            //var smpaData = $("#grid").jqGrid('getGridParam', 'data');

            var smpaData = [];
            var gridData = $("#grid").jqGrid('getGridParam', 'data');
            for (j = 0; j <= gridData.length - 1; j++) {
                rowData = gridData[j];
                if (rowData.execAction != "" & rowData.dataStatus == "1") {
                    smpaData.push({
                        "tempId": rowData.tempId,
                        "execAction": rowData.execAction,
                        "smpNum": rowData.smpNum,
                        "productType": rowData.productType,
                        "corpNo": rowData.corpNo,
                        "acctType": rowData.acctType,
                        "sqlActNum": rowData.sqlActNum,
                        "sqlActNm": rowData.sqlActNm
                    });
                }
            }

            if (smpaData.length == 0) {
                validationSummary.append('<li>未異動畫面資料，將不進行修改覆核作業!!</li>');
                return;
            }



            $.blockUI();


            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    'smpNum': $("#smpNum").val(),
                    'productType': $("#productType").val(),
                    'corpNo': $("#corpNo").val(),
                    'acctType': $("#acctType").val(),
                    'smpaData': smpaData
                }),
                dataType: "json",
                url: '@Url.Action("execSave", "OGL10182")',
                contentType: 'application/json',
                success: function (data) {


                    if (data.success) {
                        $('#btnNew').attr('disabled', true);
                        $('#btnCopy').attr('disabled', true);
                        $("#btnModify").attr('disabled', true);
                        $("#btnDelTmp").attr('disabled', true);
                        validationSummary.append('<li>' + '儲存資料成功，覆核單號:' + data.aplyNo + '</li>');



                        var ids = jQuery("#grid").jqGrid('getDataIDs');
                        for (var i = 0; i < ids.length; i++) {
                            var rowId = ids[i];

                            $("#btn_edit_" + rowId).hide();
                            $("#btn_del_" + rowId).hide();
                            $("#btn_save_" + rowId).hide();
                            $("#btn_cancel_" + rowId).hide();

                        }
                    } else {
                        validationSummary.append('<li>' + data.err + '</li>');
                    }
                }
            });

            $.unblockUI();

        });
        //*---------------修改(申請覆核) end ----------------*//

    });
</script>


