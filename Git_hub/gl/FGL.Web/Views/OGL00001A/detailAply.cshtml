@model FGL.Web.ViewModels.OGL00001Model

@{
    Layout = "~/Views/Shared/_LayoutFrame.cshtml";
    ViewBag.Title = "OGL00001A商品科目設定覆核作業(險種類別)-明細";

    var productTypeList = ViewBag.productTypeList as SelectList;
    var ynList = ViewBag.ynList as SelectList;
    var itemConList = ViewBag.itemConList as SelectList;
    var isIfrs4List = ViewBag.isIfrs4List as SelectList;
    var lodprmTypeList = ViewBag.lodprmTypeList as SelectList;
}




<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>

            @Html.Hidden("hidYNFlag", "")
            @Html.Hidden("hidAcctType", "")
            <table>
                <tr>
                    <td>
                        @Html.DisplayNameFor(model => model.aplyNo)：

                        @Html.DisplayTextFor(model => model.aplyNo)
                    </td>

                    <td>
                        @Html.DisplayNameFor(model => model.lastUpdateUid)：

                        @Html.DisplayTextFor(model => model.lastUpdateUid)
                    </td>

                    <td>
                        @Html.DisplayNameFor(model => model.lastUpdateDT)：

                        @Html.DisplayTextFor(model => model.lastUpdateDT)
                    </td>
                </tr>
                <tr>
                    <td>
                        @Html.DisplayNameFor(model => model.productType)：@Html.DropDownList("productType", productTypeList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.fuMk)：@Html.DropDownList("fuMk", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                </tr>

                <tr>
                    <td>
                        @Html.DisplayNameFor(model => model.itemCon)：@Html.DropDownList("itemCon", itemConList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.discPartFeat)：@Html.DropDownList("discPartFeat", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.isIfrs4)：@Html.DropDownList("isIfrs4", isIfrs4List, "請選擇", new { @disabled = "disabled" })
                    </td>
                </tr>


                <tr>
                    <td colspan="3" style="border-bottom:dashed 1px"></td>
                </tr>
                <tr>
                    <td>
                        @Html.DisplayNameFor(model => model.investTypeMk)：@Html.DropDownList("investTypeMk", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.investTradMk)：@Html.DropDownList("investTradMk", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.coiType)：@Html.DropDownList("coiType", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                </tr>
                <tr>
                    <td>
                        @Html.DisplayNameFor(model => model.lodprmMk)：@Html.DropDownList("lodprmMk", ynList, "請選擇", new { @disabled = "disabled" })
                    </td>
                    <td>
                        @Html.DisplayNameFor(model => model.pakindDmopMk)：@Html.DropDownList("pakindDmopMk", ynList, "請選擇", new { @disabled = "disabled" })
                        @*@Html.DisplayNameFor(model => model.extSchedulMk)：@Html.DropDownList("extSchedulMk", ynList, "請選擇", new { @disabled = "disabled" })*@
                    </td>
                </tr>



            </table>


            <div class="row">
                <div class="col-sm-24" style="text-align:center;">
                    <input type="button" id="btnConfirm" name="btnConfirm" value="核可" class="btn btn-primary" />
                    <input type="button" id="btnReturn" name="btnReturn" value="駁回" class="btn btn-primary" />
                    <input type="button" id="btnPrepage" name="btnPrepage" value="回上一頁" class="btn btn-primary" />

                </div>
            </div>
            <br>


            <div class="row">
                <div id="qryResult" class="col-sm-24">
                    <table id="grid"></table>
                    <div id="pager"></div>
                </div>
            </div>
            <br>

            <div class="row">
                <div id="qryResultFormal" class="col-sm-24">
                    <table id="gridFormal"></table>
                    <div id="pagerFormal"></div>
                </div>
            </div>

            <br>

        </div>
    </div>

</div>





<script type="text/javascript">
    //取得"YN"下拉選單
    function getYNFlag() {
        return $('#hidYNFlag').val();
    }

    //取得"帳務類別"下拉選單
    function getAcctType() {
        return $('#hidAcctType').val();
    }


    $(function () {
        var bHaveData = '@Html.Raw(ViewBag.bHaveData)';

        if (bHaveData) {
            $('#hidYNFlag').val('@Html.Raw(ViewBag.ynjqList)');
            $('#hidAcctType').val('@Html.Raw(ViewBag.acctTypejqList)');

            $('#productType').val('@Html.Raw(ViewBag.productType)');
            $('#fuMk').val('@Html.Raw(ViewBag.fuMk)');
            $('#itemCon').val('@Html.Raw(ViewBag.itemCon)');
            $('#discPartFeat').val('@Html.Raw(ViewBag.discPartFeat)');
            $('#isIfrs4').val('@Html.Raw(ViewBag.isIfrs4)');


            createGrid();

        } else {
            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }

            validationSummary.append('<li>' + '無此覆核資料' + '</li>');
        }


        /*------------------正式檔的科目代號 begin---------------------*/
        function createGridFormal() {

            $('#qryResultFormal').children().remove();

            $('#qryResultFormal').append('<table id="' + "gridFormal" + '"></table>');
            $('#qryResultFormal').append('<div id="' + "pagerFormal" + '"></div>');

            var para = {
                productType: $('#productType').val(),
                fuMk: $('#fuMk').val(),
                itemCon: $('#itemCon').val(),
                discPartFeat: $('#discPartFeat').val(),
                isIfrs4: $('#isIfrs4').val()
            };

            $.blockUI(); //畫面鎖起來

            $("#gridFormal").jqGrid({
                url: '/OGL00001A/qryFormal/',
                postData: para,
                datatype: 'json',
                jsonReader: {
                    repeatitems: false//, id: 'cFunctionID'
                },
                mtype: 'POST',
                caption: '正式檔清單',
                colModel: [
                    {
                        label: '帳務類別',
                        name: 'acctType', align: 'left',
                        editable: true,
                        edittype: "select",
                        formatter: 'select',
                        editoptions: {
                            value: getAcctType()
                        }
                    },
                        {
                            label: '科目代號',
                            name: 'acctItem', align: 'center',
                            editable: true,
                            editoptions: {
                                size: 4,
                                maxlength: 4
                            }
                        },
                        {
                            label: '帳本',
                            name: 'corpNo', align: 'center',
                            editable: true,
                            editoptions: {
                                size: 1,
                                maxlength: 1
                            }

                        },

                        {
                            label: '限躉繳註記',
                            name: 'dmopMk', align: 'center',
                            editable: true,
                            edittype: "select",
                            formatter: 'select',
                            editoptions: {
                                value: getYNFlag()
                            }

                        }
                ],
                autowidth: true,
                shrinkToFit: false,
                forceFit: true,
                pager: '#pagerFormal',
                width: 'auto',
                height: 'auto',
                rowNum: 10,
                rowList: [10, 20],
                sortname: 'productType',
                sortorder: "acs",
                viewrecords: true,
                loadonce: true,
                loadComplete: function () {
                    $("#gridFormal").closest("div.ui-jqgrid-view").children("div.ui-jqgrid-titlebar").css("text-align", "center").children("span.ui-jqgrid-title").css("float", "none");
                    $("#gridFormal").closest("div.ui-jqgrid-view").children("div.ui-jqgrid-titlebar").children("span.ui-jqgrid-title").css("font-size", "16px");

                    var cnt = $('#gridFormal').getGridParam('records')

                    ids = $(this).jqGrid('getDataIDs');
                    for (i = 0; i <= ids.length - 1; i++) {
                        rowData = $("#gridFormal").jqGrid('getRowData', ids[i]);


                        idsHis = $("#grid").jqGrid('getDataIDs');

                        var updateMk = "Y";

                        var gridDataHis = $("#grid").jqGrid('getGridParam', 'data');

                        for (j = 0; j <= gridDataHis.length - 1; j++) {
                            rowDataHis = gridDataHis[j];
                            if (rowData.acctType == rowDataHis.acctType && rowData.acctItem == rowDataHis.acctItem
                                && rowData.corpNo == rowDataHis.corpNo && rowData.dmopMk == rowDataHis.dmopMk) {
                                updateMk = "N";
                                break;
                            }
                        }

                        if (updateMk == "Y") {
                            $("#gridFormal").jqGrid('setCell', ids[i], "acctType", "", { color: 'red' });
                            $("#gridFormal").jqGrid('setCell', ids[i], "acctItem", "", { color: 'red' });
                            $("#gridFormal").jqGrid('setCell', ids[i], "corpNo", "", { color: 'red' });
                            $("#gridFormal").jqGrid('setCell', ids[i], "dmopMk", "", { color: 'red' });
                        }

                    }

                    $.unblockUI(); //畫面打開
                }

            });


        }
        /*------------------正式檔的科目代號 end---------------------*/


        /*------------------異動的科目代號---------------------*/
        function createGrid() {
            $('#validationSummary').children().remove();
            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }


            var aplyNo = '@Html.Raw(ViewBag.aplyNo)';

            $('#qryResult').children().remove();

            $('#qryResult').append('<table id="' + "grid" + '"></table>');
            $('#qryResult').append('<div id="' + "pager" + '"></div>');

            var para = {
                aplyNo: aplyNo
            };

            $.blockUI(); //畫面鎖起來


            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    'aplyNo': aplyNo
                }),
                dataType: "json",
                url: '@Url.Action("qryHis", "OGL00001A")',
                contentType: 'application/json',
                success: function (data) {

                    if (data.rows.length > 0) {
                        $('#productType').val(data.rows[0].productType);
                        $('#fuMk').val(data.rows[0].fuMk);
                        $('#itemCon').val(data.rows[0].itemCon);
                        $('#discPartFeat').val(data.rows[0].discPartFeat);
                        $('#isIfrs4').val(data.rows[0].isIfrs4);

                        $('#investTypeMk').val(data.rows[0].investTypeMk);
                        $('#investTradMk').val(data.rows[0].investTradMk);
                        $('#lodprmMk').val(data.rows[0].lodprmMk);
                        //$('#extSchedulMk').val(data.rows[0].extSchedulMk);
                        $('#pakindDmopMk').val(data.rows[0].pakindDmopMk);
                        $('#coiType').val(data.rows[0].coiType);
                    } else {

                        validationSummary.append('<li>' + '本次申請的異動為『刪除』符合畫面『險種類別+外幣註記+合約分類+裁量參與特性+是否適用IFRS4』的所有科目資料!!' + '</li>');

                    }
                    createGridFormal();

                    $("#grid").jqGrid({
                        datatype: "local",
                        data: data.rows,
                        jsonReader: {
                            repeatitems: false//, id: 'cFunctionID'
                        },
                        mtype: 'POST',
                        caption: '異動清單',
                        colModel: [
                    {
                        label: '帳務類別',
                        name: 'acctType', align: 'left',
                        editable: true,
                        edittype: "select",
                        formatter: 'select',
                        editoptions: {
                            value: getAcctType()
                        }
                    },
                        {
                            label: '科目代號',
                            name: 'acctItem', align: 'center',
                            editable: true,
                            editoptions: {
                                size: 4,
                                maxlength: 4
                            }
                        },
                        {
                            label: '帳本',
                            name: 'corpNo', align: 'center',
                            editable: true,
                            editoptions: {
                                size: 1,
                                maxlength: 1
                            }
                        },
                        {
                            label: '限躉繳註記',
                            name: 'dmopMk', align: 'center',
                            editable: true,
                            edittype: "select",
                            formatter: 'select',
                            editoptions: {
                                value: getYNFlag()
                            }

                        },
                        {
                        label: '異動註記',
                        name: 'updateMk', align: 'center', hidden: true
                }
                        ],
                        autowidth: true,
                        shrinkToFit: false,
                        forceFit: true,
                        pager: '#pager',
                        width: 'auto',
                        height: 'auto',
                        rowNum: 10,
                        rowList: [10, 20],
                        sortorder: "acs",
                        viewrecords: true,
                        loadonce: true,
                        loadComplete: function () {
                            $("#grid").closest("div.ui-jqgrid-view").children("div.ui-jqgrid-titlebar").css("text-align", "center").children("span.ui-jqgrid-title").css("float", "none");
                            $("#grid").closest("div.ui-jqgrid-view").children("div.ui-jqgrid-titlebar").children("span.ui-jqgrid-title").css("font-size", "16px");

                            var cnt = $('#grid').getGridParam('records')

                            ids = $(this).jqGrid('getDataIDs');
                            for (i = 0; i <= ids.length - 1; i++) {
                                rowData = $("#grid").jqGrid('getRowData', ids[i]);
                                if (rowData.updateMk == "Y") {
                                    $("#grid").jqGrid('setCell', ids[i], "acctType", "", { color: 'red' });
                                    $("#grid").jqGrid('setCell', ids[i], "acctItem", "", { color: 'red' });
                                    $("#grid").jqGrid('setCell', ids[i], "corpNo", "", { color: 'red' });
                                    $("#grid").jqGrid('setCell', ids[i], "dmopMk", "", { color: 'red' });
                                }

                            }

                            $.unblockUI(); //畫面打開
                        }

                    });

                }
            });

        }


        //關閉
        $("#btnClose").click().on('click', function () {
            window.close();
        })

        //回上一頁
        $("#btnPrepage").click().on('click', function () {
            //$("#iframe").load("/GL/FGL10181A/index");
            history.go(-1)
        })

        //*------------------退回---------------------*//
        $("#btnReturn").click().on('click', function () {
            $('#validationSummary').children().remove();
            $.blockUI();

            var aplyNo = '@Html.Raw(ViewBag.aplyNo)';

            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: {
                        'aplyNo': '@Html.Raw(ViewBag.aplyNo)',

                        'productType': $('#productType').val(),
                        'fuMk': $('#fuMk').val(),
                        'itemCon': $('#itemCon').val(),
                        'discPartFeat': $('#discPartFeat').val(),
                        'isIfrs4': $('#isIfrs4').val()
                    }, 'apprStat': "3"
                }),
                dataType: "json",
                url: '@Url.Action("execSave", "OGL00001A")',
                contentType: 'application/json',
                success: function (data) {
                    var validationSummary = $('#validationSummary ul.validation-summary-errors');

                    if (validationSummary.length == 0) {
                        $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                        validationSummary = $('#validationSummary ul.validation-summary-errors');
                    }

                    if (data.success) {
                        $("#btnConfirm").attr('disabled', true);
                        $("#btnReturn").attr('disabled', true);
                        validationSummary.append('<li>' + '退回作業成功!!' + '</li>');
                    } else {
                        validationSummary.append('<li>' + data.errors + '</li>');
                    }

                    $.unblockUI();
                }
            });





        });



        //*------------------------核可--------------------------*//
        $("#btnConfirm").click().on('click', function () {
            $('#validationSummary').children().remove();
            $.blockUI();

            var aplyNo = '@Html.Raw(ViewBag.aplyNo)';

            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: {
                        'aplyNo': '@Html.Raw(ViewBag.aplyNo)',

                        'productType': $('#productType').val(),
                        'fuMk': $('#fuMk').val(),
                        'itemCon': $('#itemCon').val(),
                        'discPartFeat': $('#discPartFeat').val(),
                        'isIfrs4': $('#isIfrs4').val()
                    }, 'apprStat': "2"
                }),
                dataType: "json",
                url: '@Url.Action("execSave", "OGL00001A")',
                contentType: 'application/json',
                success: function (data) {


                    var validationSummary = $('#validationSummary ul.validation-summary-errors');

                    if (validationSummary.length == 0) {
                        $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                        validationSummary = $('#validationSummary ul.validation-summary-errors');
                    }

                    if (data.success) {
                        $("#btnConfirm").attr('disabled', true);
                        $("#btnReturn").attr('disabled', true);
                        validationSummary.append('<li>' + '核可作業成功!!' + '</li>');
                    } else {
                        validationSummary.append('<li>' + data.errors + '</li>');
                    }

                    $.unblockUI();
                }
            });


        });



    });
</script>


