@using Treasury.Web.Enum;
@using Treasury.WebUtility;
<div class="row">
    <div style="display:none;" class="aplyNoDetail">
        <table style="width:95%">
            <tr>
                <td style="width:150px">
                    <label>申請單號 : </label>
                </td>
                <td style="width:250px">
                    <label id="TAVMvAplyNo"></label>
                </td>
                <td style="width:150px">
                    <label>存取申請項目 : </label>
                </td>
                <td style="width:250px">
                    <label id="TAVMvItem"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>申請單位 : </label>
                </td>
                <td>
                    <label id="TAVMvAplyUnit"></label>
                </td>
                <td>
                    <label>申請人 : </label>
                </td>
                <td>
                    <label id="TAVMvAplyUid"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>權責部門 : </label>
                </td>
                <td>
                    <label id="TAVMvChargeUnit"></label>
                </td>
                <td>
                    <label>申請作業 : </label>
                </td>
                <td>
                    <label id="TAVMvAccessType"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>預計存取日期 : </label>
                </td>
                <td>
                    <label id="TAVMvExpectedAccessDate"></label>
                </td>
                <td>
                    <label>填表日期 : </label>
                </td>
                <td>
                    <label id="TAVMvCreateDt"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>填表單位 : </label>
                </td>
                <td>
                    <label id="TAVMvCreateUnit"></label>
                </td>
                <td>
                    <label>填表人 : </label>
                </td>
                <td>
                    <label id="TAVMvCreateUid"></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>申請原因 : </label>
                </td>
                <td colspan="3">
                    <textarea id="TAVMvAccessReason" style="width:100%" disabled></textarea>
                </td>
            </tr>
        </table>
    </div>
    <div class="col-sm-24">
        <form id="StockMainForm">
            <table>
                <tr>
                    <td>
                        <label>存入資料:</label>
                    </td>
                    <td colspan="5">
                        @Html.RadioButton("rStockFeaturesType", "StockInsert", new { @checked = true }) 新增股票
                        @Html.RadioButton("rStockFeaturesType", "StockFromDB") 從資料庫選取股票
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>編號:</label>
                    </td>
                    <td>
                        @Html.TextBox("tStock_No", (int)ViewBag.tStock_No)
                    </td>
                    <td>
                        <label>股票名稱:</label>
                    </td>
                    <td>
                        <input type="text" id="tStock_Name" name="tStock_Name" style="width:200px" />
                        @Html.DropDownList("dStock_Name", (SelectList)ViewBag.dStock_Name, new { @style = "display:none;width:200px;" })
                    </td>
                    <td>
                        <label>區域:</label>
                    </td>
                    <td>
                        @Html.DropDownList("dStock_Area_Type", (SelectList)ViewBag.dStock_Area_Type)
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>備註:</label>
                    </td>
                    <td colspan="5">
                        <input type="text" id="tStock_Memo" name="tStock_Memo" style="width:500px" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>入庫批號:</label>
                    </td>
                    <td>
                        <label id="lStock_Trea_Batch_No"></label>
                    </td>
                    <td>
                        <label>總股數:</label>
                    </td>
                    <td>
                        <label id="lNumber_Of_Shares_Total"></label>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div style="padding-bottom:5px;">
        <input type="button" id="StockInsert" value="新增存入明細" class="btn btn-primary" />
    </div>
    <div id="STOCKjqgridDiv1" class="col-sm-24" style="padding-bottom:5px;">

    </div>
    <div id="STOCKjqgridDiv2" class="col-sm-24">

    </div>
    <div style="text-align:center;padding-top:5px;display:none;" class="StockAct">
        <input type="button" id="StockApply" value="申請覆核" class="btn btn-primary" />
        <input type="button" id="StockCancel" value="取消申請" class="btn btn-primary" />
        <input type="button" id="StockBack" value="回到功能選擇" class="btn btn-primary" />
    </div>
    <div id="StockInsertDialog" style="display:none;">
        <form id="StockForm">
            <table>
                <tr>
                    <td>
                        <label>類型 : </label>
                    </td>
                    <td>
                        @Html.DropDownList("dStock_Type", (SelectList)ViewBag.dStock_Type, new { @class = "StockInsertType" })
                    </td>
                    <td>
                        <label>序號前置碼 : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tStock_No_Preamble" name="tStock_No_Preamble" />
                    </td>
                    <td>
                        <label>序號(起) : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tStock_No_B" name="tStock_No_B" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>序號(迄) : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tStock_No_E" name="tStock_No_E" />
                    </td>
                    <td>
                        <label>張數 : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tStock_Total" name="tStock_Total" />
                    </td>
                    <td>
                        <label>單張面額 : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tDenomination" name="tDenomination" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>面額小計 : </label>
                    </td>
                    <td>
                        <label id="lDenomination_Total"></label>
                    </td>
                    <td>
                        <label>股數 : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tNumber_Of_Shares" name="tNumber_Of_Shares" />
                    </td>
                    <td>
                        <label>備註說明 : </label>
                    </td>
                    <td>
                        <input type="text" class="StockInsertType" id="tMemo" name="tMemo" />
                    </td>
                </tr>
                <tr>
                    <td colspan="6">
                        <input type="hidden" id="tAplyNo" />
                        <input type="hidden" id="tDataSeq" />
                        <input type="hidden" id="tItemId" />
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <input type="button" id="StockInsertTemp" value="新增" class="btn btn-primary" style="display:none" />
                        <input type="button" id="StockUpdateTemp" value="修改" class="btn btn-primary" style="display:none" />
                        <input type="button" id="StockDeleteTemp" value="刪除" class="btn btn-primary" style="display:none" />
                    </td>
                    <td colspan="3" style="text-align:right;">
                        <input type="button" id="StockCancelTemp" value="取消" class="btn btn-primary" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        //#region 參數設定
        var StockMainFormId = 'StockMainForm'; //formId
        var StockFormId = 'StockForm'; //formId
        var StockAplyNoId = 'tAplyNo'; //申請單號Id
        var StockDataSeqId = 'tDataSeq'; //明細流水號Id
        var StockItemId = 'tItemId'; //物品編號Id

        var Stock_Name = 'tStock_Name'; //股票名稱Id
        var Stock_Memo = 'tStock_Memo'; //備註Id

        var Stock_Type = 'dStock_Type'; //類型Id
        var Stock_No_Preamble = 'tStock_No_Preamble'; //序號前置碼Id
        var Stock_No_B = 'tStock_No_B'; //序號(起)Id
        var Stock_No_E = 'tStock_No_E'; //序號(迄)Id
        var Stock_Total = 'tStock_Total'; //張數Id
        var Denomination = 'tDenomination'; //單張面額Id
        var Denomination_Total = 'lDenomination_Total'; //面額小計Id
        var Number_Of_Shares = 'tNumber_Of_Shares'; //股數Id
        var Memo = 'tMemo'; //備註說明Id

        var Stock_Act_Type = 'True' == '@ViewBag.dActType'; //覆核狀態
        var type = $('input[name=cProjectType]:checked').val();
        if (!Stock_Act_Type) { //不是覆核狀態 (為使用單號查詢資料)
            $('.StockAct').hide();
            type = '@ViewBag.dAccess';
            $('.aplyNoDetail').show();
            var TARdata = @Html.Raw(Json.Encode(ViewBag.TAR));
            $('#TAVMvAplyNo').text(TARdata.vAplyNo);
            $('#TAVMvItem').text(TARdata.vItem)
            $('#TAVMvAplyUnit').text(TARdata.vAplyUnit);
            $('#TAVMvAplyUid').text(TARdata.vAplyUid);
            $('#TAVMvChargeUnit').text(TARdata.vAplyUnit);
            $('#TAVMvAccessType').text(TARdata.vAccessType);
            $('#TAVMvExpectedAccessDate').text(TARdata.vExpectedAccessDate);
            $('#TAVMvCreateDt').text(TARdata.vCreateDt);
            $('#TAVMvCreateUnit').text(TARdata.vCreateUnit);
            $('#TAVMvCreateUid').text(TARdata.vCreateUid);
            $('#TAVMvAccessReason').val(TARdata.vAccessReason);
        }
        else { //是覆核狀態 (為存入 or 取出 動作)
            $('.StockAct').show();
        }

        var typeFlag = (type == '@Ref.AccessProjectTradeType.P.ToString()'); //存入為 True 取出 為 False
        if (typeFlag && Stock_Act_Type) {
            $('#StockInsert').show();
        }
        else {
            $('#StockInsert').hide();
        }
        //#endregion

        //#region url設定
        var StockUrl = {};
        StockUrl.GetStockDate = '@Url.Action("GetStockDate", "Stock")';
        StockUrl.getData = '@Url.Action("GetCacheData", "Stock")';
        StockUrl.InsertTempData = '@Url.Action("InsertTempData", "Stock")';
        StockUrl.UpdateTempData = '@Url.Action("UpdateTempData", "Stock")';
        StockUrl.DeleteTempData = '@Url.Action("DeleteTempData", "Stock")';
        StockUrl.ApplyTempData = '@Url.Action("ApplyTempData", "Stock")';
        StockUrl.ResetTempData = '@Url.Action("ResetTempData", "Stock")';

        //#endregion

        //#region 初始動作
        StockTempGrid();
        setStockVerified();
        //#endregion

        //#region 註冊verified
        function setStockVerified() {
            verified.maxlength(StockMainFormId, Stock_Name, 10); //股票名稱最大長度(10)
            verified.maxlength(StockMainFormId, Stock_Memo, 30); //備註最大長度(30)

            verified.maxlength(StockFormId, Stock_No_Preamble, 7); //序號前置碼最大長度(7)
            verified.positiveInt(StockFormId, Stock_No_B); //序號(起) 僅能輸入數字(正)
            verified.maxlength(StockFormId, Stock_No_B, 8); //序號(起)最大長度(8)
            verified.positiveInt(StockFormId, Stock_No_E); //序號(迄) 僅能輸入數字(正)
            verified.maxlength(StockFormId, Stock_No_E, 8); //序號(迄)最大長度(8)
            verified.positiveInt(StockFormId, Stock_Total); //張數 僅能輸入數字(正)
            verified.positiveInt(StockFormId, Denomination); //單張面額 僅能輸入數字(正)
            verified.maxlength(StockFormId, Denomination, 13); //單張面額最大長度(13)
            verified.positiveInt(StockFormId, Number_Of_Shares); //股數 僅能輸入數字(正)
            verified.maxlength(StockFormId, Number_Of_Shares, 13); //股數最大長度(13)
            verified.maxlength(StockFormId, Memo, 30); //備註說明最大長度(30)

        }

        //#endregion

        //#region 註冊事件
        //存入資料選取
        $('input[name=rStockFeaturesType]').on('change', function () {
            var type = $('input[name=rStockFeaturesType]:checked').val();

            switch (type) {
                case 'StockInsert'://新增股票
                    SetInsert();
                    break;
                case 'StockFromDB'://從資料庫選取股票
                    SetFromDB();
                    break;
            }
        });

        //按鈕
        $('input:button').each(function () {
            var id = $(this).attr('id');
            switch (id) {
                case 'StockInsert':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockInsertFun(); });
                    break;
                case 'StockApply':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockApplyFun(); });
                    break;
                case 'StockCancel':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockCancelFun(); });
                    break;
                case 'StockBack':
                case 'StockCancelTemp':
                case 'StockTakeOutCancelTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { customerUtility.closeDialog(this); });
                    break;
                case 'StockInsertTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockInsertTempFun(); });
                    break;
                case 'StockUpdateTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockUpdateTempFun(); });
                    break;
                case 'StockDeleteTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockDeleteTempFun(); });
                    break;
                case 'StockTakeOutTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { StockTakeOutTempFun(); });
                    break;
            }
        });

        //類型選取
        $("#dStock_Type").on('change', function () {
            //判斷區域
            switch ($("#dStock_Type").val()) {
                case "S":
                    Type_S();
                    break;
                case "C":
                    Type_C();
                    break;
            }
        });

        //序號(起)或序號(迄)輸入完畢
        $('#' + Stock_No_B + ',#' + Stock_No_E).off('blur', function () { });
        $('#' + Stock_No_B + ',#' + Stock_No_E).on('blur', function () {
            setStock_Total();
        });

        //單張面額輸入完畢
        $('#' + Denomination).off('blur', function () { });
        $('#' + Denomination).on('blur', function () {
            setDenomination_Total();
        });

        //#endregion

        //#region 初始設定
        if ('@ViewBag.CustodianFlag' == "True") {
            $("#tStock_Memo").attr("Disabled", false);
        }
        else {
            $("#tStock_Memo").attr("Disabled", true);
            $("#tStock_Memo").val(" ");
        }

        $("#lStock_Trea_Batch_No").html("1");
        //#endregion

        //新增股票設定
        function SetInsert() {
            $("#tStock_Name").val("");
            $("#tStock_Name").show();
            $("#dStock_Name").hide();
            $("#dStock_Area_Type").attr("Disabled", false);
            $("#tStock_No").val('@ViewBag.tStock_No');
            $("#tStock_Memo").val("");
            $("#lStock_Trea_Batch_No").html("1");
        }

        //從資料庫選取股票設定
        function SetFromDB() {
            $("#tStock_Name").hide();
            $("#dStock_Name").show();
            $("#dStock_Area_Type").attr("Disabled", true);

            GetStockDate();
        }

        //取得股票資料
        function GetStockDate() {
            $.ajax({
                url: StockUrl.GetStockDate,
                type: "POST",
                data: {
                    GroupNo: $("#dStock_Name").val()
                },
                success: function (result) {
                    if (result !== "undefined") {
                        $("#tStock_No").val(result[0].GroupNo);
                        $("#dStock_Area_Type").val(result[0].Area);
                        $("#tStock_Memo").val(result[0].Memo);
                        $("#lStock_Trea_Batch_No").html(result[0].Next_Batch_No);
                    }
                }
            });
        }

        //股票類型
        function Type_S() {
            $("#tStock_No_Preamble").attr("Disabled", false);
            $("#tStock_No_B").attr("Disabled", false);
            $("#tStock_No_E").attr("Disabled", false);

            switch ($("#dStock_Area_Type").val()) {
                case "D"://國內
                    $("#tStock_Total").attr("Disabled", true);
                    $("#tDenomination").attr("Disabled", false);
                    break;
                case "F"://國外
                    $("#tStock_Total").attr("Disabled", false);
                    $("#tDenomination").attr("Disabled", true);
                    break;
            }
        }

        //其他類型
        function Type_C() {
            $("#tStock_No_Preamble").val('');
            $("#tStock_No_Preamble").attr("Disabled", true);
            $("#tStock_No_B").val('');
            $("#tStock_No_B").attr("Disabled", true);
            $("#tStock_No_E").val('');
            $("#tStock_No_E").attr("Disabled", true);
            $("#tStock_Total").val('');
            $("#tStock_Total").attr("Disabled", true);
            $("#tDenomination").val('');
            $("#tDenomination").attr("Disabled", true);
            $('#lDenomination_Total').html('');
        }

        //計算張數
        function setStock_Total() {
            if ($('#' + Stock_No_B).val().length <= 8 && $('#' + Stock_No_E).val().length <= 8) {
                var _Check_No_B = parseInt($('#' + Stock_No_B).val());
                var _Check_No_E = parseInt($('#' + Stock_No_E).val());
                if (!isNaN(_Check_No_B) && !isNaN(_Check_No_E) && _Check_No_E >= _Check_No_B) {
                    $('#' + Stock_Total).val(_Check_No_E - _Check_No_B + 1);
                }
                else {
                    $('#' + Stock_Total).val('');
                }
                if (!isNaN(_Check_No_B))
                    $('#' + Stock_No_B).val(created.padLeft(_Check_No_B, 8, '0'));
                if (!isNaN(_Check_No_E))
                    $('#' + Stock_No_E).val(created.padLeft(_Check_No_E, 8, '0'));
            }
            else {
                $('#' + Stock_Total).val('');
            }
        }

        //計算面額小計及股數
        function setDenomination_Total() {
            if ($('#' + Denomination).val().length <= 13) {
                var _Stock_Total = parseInt($('#' + Stock_Total).val());
                var _Denomination = parseInt($('#' + Denomination).val());
                if (!isNaN(_Stock_Total) && !isNaN(_Denomination)) {
                    $('#' + Denomination_Total).html(_Stock_Total * _Denomination);
                    $('#' + Number_Of_Shares).val((_Stock_Total * _Denomination) / 10);
                }
                else {
                    $('#' + Denomination_Total).html('');
                    $('#' + Number_Of_Shares).val('');
                }
            }
            else {
                $('#' + Denomination_Total).html('');
                $('#' + Number_Of_Shares).val('');
            }
        }

        function StockApplyFun()
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: StockUrl.ApplyTempData,
                contentType: 'application/json',
            }).done(function (result) {
                customerUtility.alertAuto(result);
                if (result.RETURN_FLAG) {
                    customerUtility.closeDialog($('#StockApply'));
                }
            })
        }

        function StockCancelFun() {
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    AccessType: type
                }),
                dataType: "json",
                url: StockUrl.ResetTempData,
                contentType: 'application/json',
            }).done(function (result) {
                ResetInsertDialog();
                StockTempGrid();
            })
        }

        function formatterTakeOut(cellvalue, options, rdata) {
            let str = '';
            str += '<div class="btn-group">';
            str += '<a title="取出" class="btn actionTakeout" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="BILL' + options.gid + 'TakeOut' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-pencil-square-o fa-lg"></i></a>';
            str += '<a title="重設" class="btn actionRepeat" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="BILL' + options.gid + 'Repeat' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-repeat fa-lg"></i></a>';
            str += '</div>';
            return str;
        }

        function STOCKformatterCheckType(cellvalue, options, rdata)
        {
            var value = '';
            switch (cellvalue)
            {
                case 'S':
                    value = 'S-股票';
                    break;
                case 'C':
                    value = 'C-其他';
                    break;
                case null:
                    value = '';
                    break;
                default:
                    value = cellvalue;
                    break;
            }
            return value;
        }

        function STOCKunformatterCheckType(cellvalue, options, rdata) {
            return cellvalue;
        }

        function StockTempGrid()
        {
            if (typeFlag) {
                var colNameArray = ['項次', '動作', '類型', '序號前置碼', '序號(起)', '序號(迄)',
                        '張數', '單張面額', '面額小計', '股數', '備註說明',
                        '物品單號', '申請單號', '明細流水號'];
                var colModelArray = [
                     { name: "vRowNum", index: "vRowNum", width: 40, sortable: false, align: 'right' }
                ];
                if (Stock_Act_Type) {
                    colModelArray.push({ name: "act", index: "act", width: 90, sortable: false });
                }
                else {
                    colModelArray.push({ name: "act", index: "act", width: 0, sortable: false, hidden: true });
                }
                colModelArray.push({ name: "vStockType", index: "vStock_Type", width: 60, sortable: false, formatter: STOCKformatterCheckType, unformat: STOCKunformatterCheckType });
                colModelArray.push({ name: "vStockNoPreamble", index: "vStockNoPreamble", width: 100, sortable: false });
                colModelArray.push({ name: "vStockNoB", index: "vStockNoB", width: 100, sortable: false, align: 'center' });
                colModelArray.push({ name: "vStockNoE", index: "vStockNoE", width: 100, sortable: false, align: 'center' });
                colModelArray.push({ name: "vStockTotal", index: "vStockTotal", width: 60, sortable: false, align: 'center' });
                colModelArray.push({ name: "vDenomination", index: "vDenomination", width: 80, sortable: false, align: 'center' });
                colModelArray.push({ name: "vDenomination_Total", index: "vDenomination_Total", width: 100, sortable: false, align: 'center' });
                colModelArray.push({ name: "vNumber_Of_Shares", index: "vNumber_Of_Shares", width: 100, sortable: false, align: 'center' });
                colModelArray.push({ name: "vMemo", index: "vMemo", width: 80, sortable: false });
                colModelArray.push({ name: "vItemId", index: "vItemId", hidden: true });
                colModelArray.push({ name: "vAplyNo", index: "vAplyNo", hidden: true });
                colModelArray.push({ name: "vDataSeq", index: "vDataSeq", hidden: true });
                jqgridCustom.createJqgridByCache(
                    'STOCKjqgridDiv1',
                    'StockTempList',
                    'StockTempPeger',
                    StockUrl.getData,
                    {
                        type: 'Temp'
                    },
                    colNameArray,
                    colModelArray,
                    '存入明細資料',
                    jqgridCustom.getPage('STOCKjqgridDiv1'),
                    StockTempCompleteFun
                    );
            }
            else {

            }
        }

        function StockTempCompleteFun(listId){
            jqgridCustom.randerAction(listId, 'StockTemp', tempActFun);
        }

        var tempActFun = {};
        tempActFun.Edit = function (i) {
            dialogOpen('@Ref.ActionType.Edit.ToString()', i);
        }
        tempActFun.Dele = function (i) {
            dialogOpen('@Ref.ActionType.Dele.ToString()', i);
        }
        tempActFun.View = function (i) {
            dialogOpen('@Ref.ActionType.View.ToString()', i);
        }

        //#region function
        function StockInsertFun() {
            if ($('#' + StockMainFormId).valid()) {
                var type = $('input[name=rStockFeaturesType]:checked').val();

                switch (type) {
                    case 'StockInsert'://新增股票
                        if ($("#tStock_Name").val().trim() != "") {
                            dialogOpen('@Ref.ActionType.Add.ToString()', null);
                        }
                        else {
                            alert("股票名稱必填");
                        }
                        break;
                    case 'StockFromDB'://從資料庫選取股票
                        dialogOpen('@Ref.ActionType.Add.ToString()', null);
                        break;
                }
                Type_S();
            }
        }

        function dialogOpen(type, rowid) {
            $('#' + StockFormId).validate().resetForm();
            var dialogId = 'StockInsertDialog';
            var listId = 'StockTempList';
            var StockInsertClass = 'StockInsertType';
            var title = '';
            $('#' + dialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: title + '股票',
                width: 'auto',
                autoOpen: false,
                resizable: false,
                closeText: '取消',
            });
            $('#StockInsertTemp,#StockUpdateTemp,#StockDeleteTemp').hide();
            if (type == '@Ref.ActionType.Add.ToString()') {
                ResetInsertDialog();
                $('#StockInsertTemp').show();
                title = '@Ref.ActionType.Add.GetDescription()';
                $('.' + StockInsertClass).prop('disabled', false);
            }
            else if (type == '@Ref.ActionType.Dele.ToString()') {
                dialogSetData(listId, rowid);
                $('#StockDeleteTemp').show();
                title = '@Ref.ActionType.Dele.GetDescription()';
                $('.' + StockInsertClass).prop('disabled', true);
            }
            else if (type == '@Ref.ActionType.Edit.ToString()') {
                dialogSetData(listId, rowid);
                $('#StockUpdateTemp').show();
                title = '@Ref.ActionType.Edit.GetDescription()';
                $('.' + StockInsertClass).prop('disabled', false);
            }
            else if (type == '@Ref.ActionType.View.ToString()') {
                dialogSetData(listId, rowid);
                title = '@Ref.ActionType.View.GetDescription()';
                $('.' + StockInsertClass).prop('disabled', true);
            }
            $('#' + dialogId).dialog('open');
        }

        function ResetInsertDialog() {
            if ($('#' + Stock_Type + ' option').length > 0) {
                $('#' + Stock_Type).val($($('#' + Stock_Type + ' option')[0]).val())
            }
            $('#' + StockAplyNoId).val('');
            $('#' + StockDataSeqId).val('');
            $('#' + StockItemId).val('');
            $('#' + Stock_No_Preamble).val('');
            $('#' + Stock_No_B).val('');
            $('#' + Stock_No_E).val('');
            $('#' + Stock_Total).val('');
            $('#' + Denomination).val('');
            $('#' + Denomination_Total).html('');
            $('#' + Number_Of_Shares).val('');
            $('#' + Memo).val('');
        }

        function dialogSetData(listId, rowid) {
            listId = listId || '';
            rowid = rowid || 0;
            ResetInsertDialog();
            if (rowid > 0) {
                var data = $("#" + listId).getRowData(rowid);
                //set value
                $('#' + StockItemId).val(data.vItemId);
                $('#' + Stock_Type).val(data.vStockType.split('-')[0]);
                if(data.vStockType.split('-')[0] == "S")//股票
                {
                    $('#' + Stock_No_Preamble).val(data.vStockNoPreamble);
                    $('#' + Stock_No_B).val(data.vStockNoB);
                    $('#' + Stock_No_E).val(data.vStockNoE);
                    $('#' + Stock_Total).val(data.vStockTotal);

                    if($("#dStock_Area_Type").val()=="D")//國內
                    {
                        $('#' + Denomination).val(data.vDenomination);
                        $('#' + Denomination_Total).html(data.vDenomination_Total);
                    }
                }
                $('#' + Number_Of_Shares).val(data.vNumber_Of_Shares);
                $('#' + Memo).val(data.vMemo);
            }
        }

        //新增暫存股票明細
        function StockInsertTempFun() {
            if ($('#' + StockFormId).valid()) {
                if($("#dStock_Type").val()=="S")//股票
                {
                    switch ($("#dStock_Area_Type").val())
                    {
                        case "D"://國內
                            if (Check_D()==false)
                            {
                                return
                            }
                            break;
                        case "F"://國外
                            if(Check_F()==false)
                            {
                                return
                            }
                            break;
                    }
                }

                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: StockViewModel(
                            created.uuid(),
                            $('#' + Stock_Type).val(),
                            $('#' + Stock_No_Preamble).val(),
                            $('#' + Stock_No_B).val(),
                            $('#' + Stock_No_E).val(),
                            $('#' + Stock_Total).val(),
                            $('#' + Denomination).val(),
                            $('#' + Denomination_Total).html(),
                            $('#' + Number_Of_Shares).val(),
                            $('#' + Memo).val(),
                            $('input[name=rStockFeaturesType]:checked').val(),
                            $('#tStock_No').val(),
                            $('#tStock_Name').val(),
                            $('#dStock_Area_Type').val(),
                            $('#tStock_Memo').val(),
                            $('#lStock_Trea_Batch_No').html()
                            )
                    }),
                    dataType: "json",
                    url: StockUrl.InsertTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG)
                    {
                        customerUtility.closeDialog($('#StockInsertTemp'));
                        StockTempGrid();
                    }
                })
            }
        }

        //修改暫存股票資料
        function StockUpdateTempFun()
        {
            if ($('#' + StockFormId).valid()) {
                if($("#dStock_Type").val()=="S")//股票
                {
                    switch ($("#dStock_Area_Type").val())
                    {
                        case "D"://國內
                            if (Check_D()==false)
                            {
                                return
                            }
                            break;
                        case "F"://國外
                            if(Check_F()==false)
                            {
                                return
                            }
                            break;
                    }
                }

                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: StockViewModel(
                            $('#' + StockItemId).val(),
                            $('#' + Stock_Type).val(),
                            $('#' + Stock_No_Preamble).val(),
                            $('#' + Stock_No_B).val(),
                            $('#' + Stock_No_E).val(),
                            $('#' + Stock_Total).val(),
                            $('#' + Denomination).val(),
                            $('#' + Denomination_Total).html(),
                            $('#' + Number_Of_Shares).val(),
                            $('#' + Memo).val(),
                            $('input[name=rStockFeaturesType]:checked').val(),
                            $('#tStock_No').val(),
                            $('#tStock_Name').val(),
                            $('#dStock_Area_Type').val(),
                            $('#tStock_Memo').val(),
                            $('#lStock_Trea_Batch_No').html())
                    }),
                dataType: "json",
                url: StockUrl.UpdateTempData,
                contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG)
                    {
                        customerUtility.closeDialog($('#StockUpdateTemp'));
                        StockTempGrid();
                    }
                })
            }
        }

        //刪除暫存股票資料
        function StockDeleteTempFun()
        {
            if ($('#' + StockFormId).valid()) {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: StockViewModel(
                            $('#' + StockItemId).val())
                    }),
                    dataType: "json",
                    url: StockUrl.DeleteTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG)
                    {
                        customerUtility.closeDialog($('#StockDeleteTemp'));
                        StockTempGrid();
                    }
                })
            }
        }

        //國內股票必填檢查
        function Check_D() {
            if ($("#tStock_No_Preamble").val().trim() == "")
            {
                alert("序號前置碼必填");
                return false;
            }

            if ($("#tStock_No_B").val().trim() == "")
            {
                alert("序號(起)必填");
                return false;
            }

            if ($("#tStock_No_E").val().trim() == "")
            {
                alert("序號(迄)必填");
                return false;
            }

            if ($("#tStock_Total").val().trim() == "") {
                alert("張數不可為空白");
                return false;
            }

            if ($("#tDenomination").val().trim() == "") {
                alert("單張面額必填");
                return false;
            }

            return true;
        }

        //國外股票必填檢查
        function Check_F()
        {
            if ($("#tStock_Total").val().trim() == "") {
                alert("張數必填");
                return false;
            }

            return true;
        }

        function StockViewModel(
            vItemId,
            vStockType,
            vStockNoPreamble,
            vStockNoB,
            vStockNoE,
            vStockTotal,
            vDenomination,
            vDenomination_Total,
            vNumber_Of_Shares,
            vMemo,
            vStockFeaturesType,
            vStockNo,
            vStockName,
            vStockAreaType,
            vStockMemo,
            vStockTreaBatchNo
    ) {
            var obj = {};
            obj['vItemId'] = vItemId;
            obj['vStockType'] = vStockType;
            obj['vStockNoPreamble'] = vStockNoPreamble;
            obj['vStockNoB'] = vStockNoB;
            obj['vStockNoE'] = vStockNoE;
            obj['vStockTotal'] = vStockTotal;
            obj['vDenomination'] = vDenomination;
            obj['vDenomination_Total'] = vDenomination_Total;
            obj['vNumber_Of_Shares'] = vNumber_Of_Shares;
            obj['vMemo'] = vMemo;
            obj['vStockDate'] = ItemBookStock(
                vStockFeaturesType,
                vStockNo,
                vStockName,
                vStockAreaType,
                vStockMemo,
                vStockTreaBatchNo
                );
            return obj;
        }

        function ItemBookStock(
            vStockFeaturesType,
            vStockNo,
            vStockName,
            vStockAreaType,
            vStockMemo,
            vStockTreaBatchNo
            )
        {
            var obj = {};
            obj['StockFeaturesType'] = vStockFeaturesType;
            obj['GroupNo'] = vStockNo;
            obj['Name'] = vStockName;
            obj['Area'] = vStockAreaType;
            obj['Memo'] = vStockMemo;
            obj['Next_Batch_No'] = vStockTreaBatchNo;
            return obj;
        }
    });
</script>
