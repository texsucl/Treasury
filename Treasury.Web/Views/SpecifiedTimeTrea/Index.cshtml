
@{
    ViewBag.Title = "金庫進出管理作業-指定時間開庫作業";
    var opScope = ViewBag.opScope;
}
<style>
    .marginTop {
        margin-top: 10px;
    }

    .marginLeft{
        margin-left: 5px;
    }
    .marginRight{
        margin-right: 10px;
    }

    .center {
        text-align: center;
    }
    .backplum {
        background-color: #FFF0F5;
    }
    .verifiedTXT{
        color: red;
    }
    
</style>

<div class="container-fluid" id="main">
    <div id="panel" class="panel panel-primary solid">
        <div class="panel-heading">
            @ViewBag.Title
        </div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <form id="specidiedSubmitForm">
                    <div class="row">
                        <div class="col-lg-2"></div>
                        <div class="col-lg-10">
                            <span class="red">＊</span>
                            <label class="red">申請日期 : </label>
                            <input type="text" id="APLY_DT_From" name="APLY_DT_From" />
                            <label> ~&ensp;</label>
                            <input type="text" id="APLY_DT_To" name="APLY_DT_To" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-2"></div>
                        <div class="col-lg-10">
                            <label>金庫登記簿單號 : </label>
                            <input type="text" id="TREA_REGISTER_ID" name="TREA_REGISTER_ID" size="17" maxlength="10" />
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-lg-5"></div>
                        <div class="col-lg-7">
                            <input type="button" id="STT_Search" value="查詢" class="btn btn-primary marginRight" />
                            <input type="button" id="STT_Insert" value="新增" class="btn btn-primary marginLeft" />
                        </div>
                    </div>
                </form>
             }      
        </div>
        
    </div>
    @*查詢區塊*@
    <div class="row">
        <div id="SearchJqgridDiv" class="col-lg-12">
        </div>
        <div id="StatusJqgridDiv" class="col-lg-12">
        </div>
    </div>
    
    @*新增Dialog*@
    <div id="SSTADDDialog" style="display:none" role="dialog" class="myDialog">
        @*<div>
            <form>
                <div class="row">
                    <div class="col-lg-3">
                        <label>金庫登記簿單號 : </label>
                    </div>
                    <div class="col-lg-3 solid">
                        <input type="text" id="INSERT_REGISTER_ID" size="15" disabled="disabled" />
                    </div>
                    <div class="col-lg-3">
                        <span class="red">＊</span>
                        <label class="red">入庫日期 : </label>
                    </div>
                    <div class="col-lg-3 solid">
                        <input type="text" id="INTRADATE_ID" size="15" disabled="disabled" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-3">
                        <span class="red">＊</span>
                        <label class="red">系統區間(起迄) : </label>
                    </div>
                    <div class="col-lg-3 solid">
                        <input type="text" id="SYSTIMESTART_ID" class="timepicker" size="4" />
                        <label> ~</label>
                        <input type="text" id="SYSTIMEEND_ID" class="timepicker" size="4" />
                    </div>
                    <div class="col-lg-3">
                        <span class="red">＊</span>
                        <label class="red">開庫時間 : </label>
                    </div>
                    <div class="col-lg-3 solid">
                        <input type="text" id="INTRATIME_ID" class="timepicker" size="15" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-3">
                        <span class="red">＊</span>
                        <label class="red">內文編號 : </label>
                    </div>
                    <div class="col-lg-3 solid">
                        <input type="text" id="CASENO_ID" size="15" />
                    </div>
                </div>
                <div cla1ss="row">
                    <div class="col-lg-3">
                        <span class="red">＊</span>
                        <label class="red">備註 : </label>
                    </div>
                    <div class="col-lg-9 solid">
                        <input type="text" id="MEMO_ID" size="58" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4"></div>
                    <div class="col-lg-4 center">
                        <input type="button" id="Apply_ID" value="申請覆核" class="btn btn-primary" autofocus />
                        <input type="button" id="Close_ID" value="回上一頁" class="btn btn-primary" />
                    </div>
                    <div class="col-lg-4"></div>
                </div>
                <div class="row">
                    <div class="col-lg-3">
                        <div class="solid backplum">
                            <label>作業類型1</label>
                        </div>
                        <div class="solid">
                            @Html.Raw(ViewBag.workType1)
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="solid backplum">
                            <label>作業類型2</label>
                        </div>
                        <div class="solid">
                            @Html.Raw(ViewBag.workType2)
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="solid backplum">
                            <label>作業類型3</label>
                        </div>
                        <div class="solid">
                            @Html.Raw(ViewBag.workType3)
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="solid backplum">
                            <label>作業類型4</label>
                        </div>
                        <div class="solid">
                            @Html.Raw(ViewBag.workType4)
                        </div>
                    </div>
                </div>
            </form>
        </div>*@
        <div id="SSTInsertDetail"></div>
    </div>
</div>
@section scripts{
    <script type="text/javascript">
        $(function () {
            //region 目前登入者
            currentUserId = '@Html.Raw(ViewBag.cUserId)';
            //#endregion
            //region set url
            var UrlFor = {};
            UrlFor.search = '@Url.Action("Search", "SpecifiedTimeTrea")';
            UrlFor.getData = '@Url.Action("GetCacheData", "SpecifiedTimeTrea")';
            UrlFor.InsertApply = '@Url.Action("InsertApply", "SpecifiedTimeTrea")';
            UrlFor.CancelApply = '@Url.Action("CancelApply", "SpecifiedTimeTrea")';
            UrlFor.UpdateApply = '@Url.Action("UpdateApply", "SpecifiedTimeTrea")';
            UrlFor.CheckRegisterId = '@Url.Action("CheckRegisterId", "SpecifiedTimeTrea")';
            //#endregion
            // region 變數設定 name
            var SearchFormId = 'specidiedSubmitForm';
            var APLY_DT_FromId = 'APLY_DT_From';
            var APLY_DT_ToId = 'APLY_DT_To';
            var TREA_REGISTER_ID = 'TREA_REGISTER_ID';
            var WorkType1 = 'WorkType1';
            //#endregion

            var opScope = '@Html.Raw(ViewBag.opScope)';

            if (opScope == "" || opScope == "0") {
                $('#validationSummary').children().remove();

                var validationSummary = $('#validationSummary ul.validation-summary-errors');

                if (validationSummary.length == 0) {
                    $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                    validationSummary = $('#validationSummary ul.validation-summary-errors');
                }
                validationSummary.append('<li>' + '無使用權限' + '</li>');
            }
            else {
                //timepicker
                var now = new Date();
                Date.prototype.addMinutes = function (minutes) {
                    this.setMinutes(this.getMinutes() + minutes);
                    return this;
                };
                setTimepicker();
                //region datepicker
                //西元
                var today = $.datepicker.formatDate('yy/mm/dd', new Date());
                created.createDatepicker(APLY_DT_FromId, today);
                created.createDatepicker(APLY_DT_ToId, today);
                created.createDatepickerRange(APLY_DT_FromId, APLY_DT_ToId);
                verified.datepicker(SearchFormId, APLY_DT_FromId, $('#' + APLY_DT_FromId).val());
                verified.datepicker(SearchFormId, APLY_DT_ToId, $('#' + APLY_DT_ToId).val());
                verified.required(SearchFormId, APLY_DT_FromId, message.required('申請日期(起)'));
                verified.required(SearchFormId, APLY_DT_ToId, message.required('申請日期(迄)'));
                //#endregion
                //region 驗證金庫需求單號
                $('#' + TREA_REGISTER_ID).blur(function () {
                    var reg = /^[W]\d{9}$/;
                    var str = $(this).val();
                    reg.test(str);
                    if ($(this).val() != "") {
                        if (!reg.test(str)) {
                            $(this).next('span').empty();
                            var wLabel = $('<label></label>').text("單號為大寫W + 9碼數字").attr('class', 'verifiedTXT');
                            var wSpan = $('<span></span>').append(wLabel);
                            $(this).after(wSpan);
                        }
                        else {
                            $(this).next('span').empty();
                        }
                    }
                    else {
                        $(this).next('span').empty();
                    }
                });
                //#endregion
                ////region 產生button事件
                $('input:button').each(function () {
                    var id = $(this).attr('id');
                    switch (id) {
                        case 'STT_Search':
                            $('#' + id).click(function () { formSearch(); });
                            break;
                        case 'STT_Insert':
                            $('#' + id).click(function () {
                                //查詢是否有未完成的單號
                                $.ajax({
                                    type: 'POST',
                                    data: null,
                                    url: UrlFor.CheckRegisterId,
                                    contentType: 'application/json',
                                }).done(function (result) {
                                    if (!result.RETURN_FLAG) {
                                        customerUtility.alert(result.DESCRIPTION, 'w');
                                        $('#STT_Insert').prop('disabled', true);
                                        return false;
                                    } else {
                                        $('#STT_Insert').prop('disabled', false);
                                        formInsert("ADD");
                                    }
                                });                       
                            });
                    }
                });
                //#endregion 
                //region 設定Timepicker
                function setTimepicker() {
                    $('.timepicker').timepicker({
                        timeFormat: 'H:i',
                        step: 1,
                        minTime: '8:00',
                        maxTime: '23:50',
                        //defaultTime: '8:00',
                        scrollDefault: 'now',
                        //scrollDefault: now,
                        startTime: '08:00',
                        dynamic: false,
                        dropdown: true,
                        scrollbar: true
                    });
                }
                //#endregion
            }     
            //region轉民國年
            function ROCTime(date) {
                if (date.indexOf("/") > -1) {
                    //var getday = $.datepicker.formatDate('yy/mm/dd', date);
                    var getday = date;
                    var year = getday.split('/')[0] - 1911;
                    var month = getday.split('/')[1];
                    var day = getday.split('/')[2];
                    return year + '/' + month + '/' + day;
                }
                else {
                    if (date.length < 8) {
                        var year = date.substring(0, 3);
                        var month = date.substring(3, 5);
                        var day = date.substring(5);
                        return year + '/' + month + '/' + day;
                    }
                }
            }
            //#endregion
            //region 轉西元年
            function CETime(date) {
                var year = date.split('/')[0];
                var month = date.split('/')[1];
                var day = date.split('/')[2];
                year = (parseInt(year) + 1911).toString();
                return year + '/' + month + '/' + day;
            }
            //#endregion
            //region set 作業類型
            function workIsChecked(data) {   
                var dataArray = data.split(';');
                $('#SSTADDDialog input:checkbox').each(function () {
                $(this).prop("checked", ($.inArray($(this).val(), dataArray) != -1));
                });
            }
             //#endregion
            //region get 作業類型
            function getworkIsChecked(){
                var _typeChecked = [];       
                $('#SSTInsertDetail').find('input[type="checkbox"]:checked').each(function () {
                    _typeChecked.push($(this).val());      
                    return _typeChecked;
                });
            }
            //#endregion
            //region 產生 Dialog 元素
            function getDialogElement(whitchMethod, data) {
                var whitchDialog = whitchMethod
                $('#SSTInsertDetail').html(SetDialogItem(whitchDialog));
                switch (whitchMethod) {
                    case "ADD":
                        $('#' + whitchDialog + '_REGISTER_ID').prop('disabled', true);
                        $('#' + whitchDialog + '_INTRADATE_ID').val(today).prop('disabled', true);
                        $('#' + whitchDialog + '_CASENO_ID').val('@ViewBag.emailId').prop('disabled', true);
                        $('#' + whitchDialog + '_Apply_ID').click(function () { ApplyReview(whitchDialog); });
                        //$('#' + whitchDialog + '_Close_ID').click(function () { $('#SSTADDDialog').dialog("close"); });
                        break;
                    case "Update":             
                        //產生取消申請btn
                        var btnCancel = $('<input/>').attr({ type: 'button', id: whitchDialog + '_Cancel_ID', value: '取消申請', class: 'btn btn-primary marginRight marginLeft' });
                        $('#inputList input:first').after(btnCancel);
                        var itemId = data.vINDEX;  //第幾列
                        var applyStatus = data.vAPLY_STATUS_ID //覆核狀態
                        $('#' + whitchDialog + '_REGISTER_ID').val(data.vTREA_REGISTER_ID);
                        $('#' + whitchDialog + '_INTRADATE_ID').val(data.vOPEN_TREA_DATE);
                        $('#' + whitchDialog + '_SYSTIMESTART_ID').val(data.vEXEC_TIME_B);
                        $('#' + whitchDialog + '_SYSTIMEEND_ID').val(data.vEXEC_TIME_E);
                        $('#' + whitchDialog + '_INTRATIME_ID').val(data.vOPEN_TREA_TIME);
                        $('#' + whitchDialog + '_CASENO_ID').val('@ViewBag.emailId');
                        $('#' + whitchDialog + '_MEMO_ID').val(data.vMEMO);
                        workIsChecked(data.vOPEN_TREA_REASON_ID);
                        if (applyStatus == "1" || applyStatus == "3") {
                            $('#' + whitchDialog + '_REGISTER_ID').prop('disabled', true);
                            $('#' + whitchDialog + '_INTRADATE_ID').prop('disabled', true);
                            $('#' + whitchDialog + '_CASENO_ID').prop('disabled', true);
                            if (applyStatus == "1") {
                                $('#' + whitchDialog + '_Cancel_ID').val('刪除/作廢');
                            }
                            if (currentUserId == data.vCREATE_UID) {
                                $('#' + whitchDialog + '_Apply_ID').click(function () { UpdateReview(whitchDialog, data); });
                                $('#' + whitchDialog + '_Cancel_ID').click(function () { CancelReview(whitchDialog, data); });    
                            }   
                            //$('#' + whitchDialog + '_Close_ID').click(function () { $('#SSTADDDialog').dialog("close"); });
                        }
                        else {
                            $('#SSTADDDialog input:text').prop('disabled', true);
                            $('#' + whitchDialog + '_Apply_ID').prop('disabled', true);
                            $('#' + whitchDialog + '_Cancel_ID').prop('disabled', true);
                            //$('#' + whitchDialog + '_Close_ID').click(function () { $('#SSTADDDialog').dialog("close"); });
                        }
                }
                var _typeChecked_B = [];
                $('#SSTInsertDetail').find('input[type="checkbox"]:checked').each(function () {
                    _typeChecked_B.push($(this).val());
                });

                $('#' + whitchDialog + '_Close_ID').click(function () {
                    var _typeChecked_A = [];
                    $('#SSTInsertDetail').find('input[type="checkbox"]:checked').each(function () {
                        _typeChecked_A.push($(this).val());
                    });
                    if (JSON.stringify(_typeChecked_B) !== JSON.stringify(_typeChecked_A)) {
                        if (confirm("暫存資料尚未申請覆核，是否繼續動作")) {
                            $('#SSTADDDialog').dialog("close");
                        }
                    }
                    else {
                        $('#SSTADDDialog').dialog("close");
                    }
                    
                });
                SetChecked(WorkType1);
            }
            //#endregion
            //region 金庫大門、柵門、密碼打勾
            function SetChecked(checkBoxName) {
                $('input:checkbox[name=' + checkBoxName + ']').each(function () {
                    var tempVal = $(this).val();
                    if (tempVal == 'D1001' || tempVal == 'D1002' || tempVal == 'D1003') {
                        $(this).prop("checked", true);
                        $(this).prop("disabled", true);
                    }
                });
            }
            //#endregion
            //region 驗證日期
            function compareDate(){
                var dateFrom = $('#APLY_DT_From').val();
                var dateTo = $('#APLY_DT_To').val();
                if (Date.parse(dateTo) >= Date.parse(dateFrom)) {
                    return true;
                }
                else {
                    return false;
                }
            }
            //#endregion
            //region 驗證時間
            function compareTime(startTime, endTime, intraTime, checkedNum) {
                var d = new Date();
                var h = ("0" + d.getHours()).slice(-2);
                var m = ("0" + d.getMinutes()).slice(-2);
                var time = h + ':' + m;
              
                if (Date.parse("1-1-2000 " + startTime) >= Date.parse("1-1-2000 " + time)) {
                    if (Date.parse("1-1-2000 " + endTime) >= Date.parse("1-1-2000 " + startTime)) {
                        if (Date.parse("1-1-2000 " + intraTime) >= Date.parse("1-1-2000 " + endTime)) {
                            if (checkedNum == 0) {
                                customerUtility.alert("請至少選擇一項工作項目", 'w');
                                return false;
                            }
                            return true;
                        }
                        else {
                            customerUtility.alert("開庫時間需大於等於系統時間(迄)", 'w');
                            return false;
                        }
                    }
                    else {
                        customerUtility.alert("系統時間(迄)需大於等於系統時間(起)", 'w');
                        return false;
                    }
                }
                else {
                    customerUtility.alert("系統時間(起)需大於等於系統時間", 'w');
                    return false;
                }     
                return false;
            }
            //#endregion
            //region 查詢事件
            function formSearch() {
                if ($('#specidiedSubmitForm').valid())
                {
                    var IsOk = compareDate();
                    if (IsOk) {
                        $("APLY_DT_To").rules('add', { timeValidator: "#APLY_DT_From" });
                        $.ajax({
                            type: 'POST',
                            data: JSON.stringify({
                                searchModel: SpecifiedTimeTreasurySearchViewModel(
                                    $('#APLY_DT_From').val(),
                                    $('#APLY_DT_To').val(),
                                    $('#TREA_REGISTER_ID').val()
                                )
                            }),
                            url: UrlFor.search,
                            contentType: 'application/json',
                        }).done(function (result) {
                            if (result.RETURN_FLAG) {
                                SpecifiedGrid();
                                StatusGride();
                            }
                            else {
                                customerUtility.alert(result.DESCRIPTION, 'w');
                            }
                        });
                    } 
                } 
            }
            //#endregion
            //region 傳送事件
            function formInsert(whitchMethod, data) {
                //開啟Dialog
                openSSTDialog("指定時間開庫-新增作業", 800, 'SSTADDDialog', false, false);
                getDialogElement(whitchMethod, data);
                setTimepicker(); 
            };
            //#endregion
            //region 申請覆核
            function ApplyReview(whitchDialog) {
                var startTime = $('#' + whitchDialog + '_SYSTIMESTART_ID').val();
                var endTime = $('#' + whitchDialog + '_SYSTIMEEND_ID').val();
                var intraTime = $('#' + whitchDialog + '_INTRATIME_ID').val();
                var checkedNum = $('#SSTInsertDetail').find('input[type="checkbox"]:checked').length;
                var isTimeOk = compareTime(startTime, endTime, intraTime, checkedNum);
                var date = $('#' + whitchDialog + '_INTRADATE_ID').val();
                //var _typeChecked = getworkIsChecked();
                var _typeChecked = [];
                $('#SSTInsertDetail').find('input[type="checkbox"]:checked').each(function () {
                        _typeChecked.push($(this).val());
                });               
                if (isTimeOk && checkedNum) {
                    $.ajax({
                        type: 'POST',
                        data: JSON.stringify({
                            applyModel: SpecifiedTimeTreasuryApplyViewModel(
                                date,
                                $('#' + whitchDialog + '_SYSTIMESTART_ID').val(),
                                $('#' + whitchDialog + '_SYSTIMEEND_ID').val(),
                                $('#' + whitchDialog + '_INTRATIME_ID').val(),
                                $('#' + whitchDialog + '_MEMO_ID').val(),
                                _typeChecked
                            )
                        }),
                        url: UrlFor.InsertApply,
                        contentType: 'application/json',
                    }).done(function (result) {
                        if (result.RETURN_FLAG) {
                            $('#SSTADDDialog').dialog('close');
                            customerUtility.alert(result.DESCRIPTION, 's');
                            SpecifiedGrid();
                            StatusGride();
                        }
                        else {
                            customerUtility.alert(result.DESCRIPTION, 'w');
                        }
                    });
                }
            }
            //#endregion
            //region 修改覆核
            function UpdateReview(whitchDialog, data) {
                //var _typeChecked = getworkIsChecked();
                var _typeChecked = [];
                $('#SSTInsertDetail').find('input[type="checkbox"]:checked').each(function () {
                    _typeChecked.push($(this).val());
                });
                var startTime = $('#' + whitchDialog + '_SYSTIMESTART_ID').val();
                var endTime = $('#' + whitchDialog + '_SYSTIMEEND_ID').val();
                var intraTime = $('#' + whitchDialog + '_INTRATIME_ID').val();
                var checkedNum = $('#SSTInsertDetail').find('input[type="checkbox"]:checked').length;
                var isTimeOk = compareTime(startTime, endTime, intraTime, checkedNum);
                if (isTimeOk && checkedNum) {
                    $.ajax({
                        type: 'Post',
                        data: JSON.stringify({
                            UpdateModel: SpecifiedTimeTreasuryUpdateViewModel(
                                data.vTREA_REGISTER_ID,
                                $('#' + whitchDialog + '_SYSTIMESTART_ID').val(),
                                $('#' + whitchDialog + '_SYSTIMEEND_ID').val(),
                                $('#' + whitchDialog + '_INTRATIME_ID').val(),
                                $('#' + whitchDialog + '_MEMO_ID').val(),
                                _typeChecked,
                                data.vCREATE_UID
                            )
                        }),
                        url: UrlFor.UpdateApply,
                        contentType: 'application/json',
                    }).done(function (result) {
                        if (result.RETURN_FLAG) {
                            $('#SSTADDDialog').dialog('close');
                            customerUtility.alert(result.DESCRIPTION, 's');
                            SpecifiedGrid();
                            StatusGride();
                        }
                        else {
                            customerUtility.alert(result.DESCRIPTION, 'w');
                        }
                    });
                }
            };
            //#endregion
            //region 取消申請
            function CancelReview(whitchDialog, data) {
                $.ajax({
                    type: 'POST',
                    data: JSON.stringify({
                        CancelModel: SpecifiedTimeTreasuryCancelViewModel(
                            data.vTREA_REGISTER_ID,
                            data.vCREATE_UID,
                            data.vAPLY_STATUS_ID,
                            data.vAPPR_UID
                        )
                    }), 
                    url: UrlFor.CancelApply,
                    contentType: 'application/json',
                }).done(function (result) {
                    if (result.RETURN_FLAG) {
                        $('#SSTADDDialog').dialog('close');
                        customerUtility.alert(result.DESCRIPTION, 's');
                        SpecifiedGrid();
                        StatusGride();
                    }
                    else {
                        customerUtility.alert(result.DESCRIPTION, 'w');
                    }
                }
            )};
            //#endregion
            //#region jqGrid 單號變連結
            function formatREGISTERID(cellvalue, option, rdata) {
                return "<a href='#' id='" + option.gid + "REGISTERID" + option.rowId + "' class='openDialog DialogREGISTERID' style='text-decoration:underline;' return:false; name='" + cellvalue + "' title='" + cellvalue + "'>" + cellvalue + "</a>";
            }
            //#endregion
            //#region //#region jqGrid 單號顯示原本樣式
            function unformatREGISTERID(cellvalue, option, rdata) {
                return cellvalue;
            }
            //#endregion
            //#region 新增事件(打開Dialog)
            function openSSTDialog(title, width, dialogId, closeFalg, custodianFlag) {
                title = title || '';
                width = width || 'auto';
                var dialogId = dialogId;
                $('#' + dialogId).dialog({
                    position: { my: "top", at: "center top", of: window },
                    title: title,
                    width: width,
                    autoOpen: false,
                    resizable: false,
                    maxHeight: 600,
                    closeText: '取消',
                    close: function () {

                    }
                });
                $('#' + dialogId).dialog('open');
            }
            //#endregion
            //#region 申請代辦區
            function SpecifiedGrid() {
                var colNameArray = ['項次', '申請日期', '金庫登記簿單號', '表單狀態', '開庫原因', '預計開庫時間', '備註', '開庫日期', '系統區間(起)', '系統區間(迄)', '開庫原因代碼', '新增人員', '表單狀態代碼', '覆核人員'];
                var colModelArry = [
                    { name: "vINDEX", index: "vINDEX", width: 45, sortable: false, align: 'center' },
                    { name: "vCREATE_DT", index: "vCREATE_DT", width: 95, sortable: false, align: 'center' },
                    { name: "vTREA_REGISTER_ID", index: "vTREA_REGISTER_ID", width: 125, sortable: false, align: 'center', formatter: formatREGISTERID, unformat: unformatREGISTERID },
                    { name: "vAPLY_STATUS", index: "vAPLY_STATUS", width: 90, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_REASON", index: "vOPEN_TREA_REASON", width: 195, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_TIME", index: "vOPEN_TREA_TIME", width: 100, sortable: false, align: 'center' },
                    { name: "vMEMO", index: "vMEMO", width: 170, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_DATE", index: "vOPEN_TREA_DATE", hidden: true },
                    { name: "vEXEC_TIME_B", index: "vEXEC_TIME_B", hidden: true },
                    { name: "vEXEC_TIME_E", index: "vEXEC_TIME_E", hidden: true },
                    { name: "vOPEN_TREA_REASON_ID", index: "vOPEN_TREA_REASON_ID", hidden: true },
                    { name: "vCREATE_UID", index: "vCREATE_UID", hidden: true },
                    { name: "vAPLY_STATUS_ID", index: "vAPLY_STATUS_ID", hidden: true },
                    { name: "vAPPR_UID", index: "vAPPR_UID", hidden: true }  
                ];
                jqgridCustom.createJqgridByCache(
                    'SearchJqgridDiv',
                    'SearchList',
                    'SearchPeger',
                    UrlFor.getData,
                    {
                        type: 'Search'
                    },
                    colNameArray,
                    colModelArry,
                    '申請代辦區',
                    jqgridCustom.getPage('SearchJqgridDiv'),
                    SearchGridCompeleteFun,
                    true
                );
            }
            //endregion
            //#region 在途/已結申請單   
            function StatusGride() {
                var colNameArray = ['項次', '申請日期', '金庫登記簿單號', '表單狀態', '開庫原因', '預計開庫時間', '備註', '開庫日期', '系統區間(起)', '系統區間(迄)', '開庫原因代碼', '新增人員', '表單狀態代碼', '覆核人員'];
                var colModelArry = [
                    { name: "vINDEX", index: "vINDEX", width: 45, sortable: false, align: 'center' },
                    { name: "vCREATE_DT", index: "vCREATE_DT", width: 95, sortable: false, align: 'center' },
                    { name: "vTREA_REGISTER_ID", index: "vTREA_REGISTER_ID", width: 125, sortable: false, align: 'center', formatter: formatREGISTERID, unformat: unformatREGISTERID },
                    { name: "vAPLY_STATUS", index: "vAPLY_STATUS", width: 90, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_REASON", index: "vOPEN_TREA_REASON", width: 195, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_TIME", index: "vOPEN_TREA_TIME", width: 100, sortable: false, align: 'center' },
                    { name: "vMEMO", index: "vMEMO", width: 170, sortable: false, align: 'center' },
                    { name: "vOPEN_TREA_DATE", index: "vOPEN_TREA_DATE", hidden: true },
                    { name: "vEXEC_TIME_B", index: "vEXEC_TIME_B", hidden: true },
                    { name: "vEXEC_TIME_E", index: "vEXEC_TIME_E", hidden: true },
                    { name: "vOPEN_TREA_REASON_ID", index: "vOPEN_TREA_REASON_ID", hidden: true },
                    { name: "vCREATE_UID", index: "vCREATE_UID", hidden: true },
                    { name: "vAPLY_STATUS_ID", index: "vAPLY_STATUS_ID", hidden: true },
                    { name: "vAPPR_UID", index: "vAPPR_UID", hidden: true }  
                ];
                jqgridCustom.createJqgridByCache(
                    'StatusJqgridDiv',
                    'StatusList',
                    'StatusPeger',
                    UrlFor.getData,
                    {
                        type: 'Status'
                    },
                    colNameArray,
                    colModelArry,
                    '在途/已結申請單',
                    jqgridCustom.getPage('StatusJqgridDiv'),
                    SearchGridCompeleteFun,
                    true
                );
            }
            //endregion
            //#region 指定時間開庫作業查詢畫面  ViewModel
            function SpecifiedTimeTreasurySearchViewModel(
                vAPLY_DT_S,
                vAPLY_DT_E,
                vAPLY_NO
            ) {
                var obj = {};
                obj['vAPLY_DT_S'] = vAPLY_DT_S;
                obj['vAPLY_DT_E'] = vAPLY_DT_E;
                obj['vTREA_REGISTER_ID'] = vAPLY_NO;
                return obj;
            }
            //#endregion
            //#grion 指定時間開庫作業申請 ViewModel
            function SpecifiedTimeTreasuryApplyViewModel(
                vOPEN_TREA_DATE,
                vEXEC_TIME_B, 
                vEXEC_TIME_E,
                vOPEN_TREA_TIME,
                vMEMO,
                vOPEN_TREA_REASON_ID
            ) {
                var obj = {};
                obj['vOPEN_TREA_DATE'] = vOPEN_TREA_DATE;              //入庫日期
                obj['vEXEC_TIME_B'] = vEXEC_TIME_B;                    //系統區間(起)
                obj['vEXEC_TIME_E'] = vEXEC_TIME_E;                    //系統區間(迄)
                obj['vOPEN_TREA_TIME'] = vOPEN_TREA_TIME;              //開庫時間
                obj['vMEMO'] = vMEMO;                                  //備註
                obj['vOPEN_TREA_REASON_ID'] = vOPEN_TREA_REASON_ID;    //開庫原因
                return obj;
            }
            //#endregion
            //region 使定時間開庫作業修改 ViewModel
            function SpecifiedTimeTreasuryUpdateViewModel(
                vTREA_REGISTER_ID,
                vEXEC_TIME_B,
                vEXEC_TIME_E,
                vOPEN_TREA_TIME,
                vMEMO,
                vOPEN_TREA_REASON_ID,
                vCREATE_UID
            ) {
                var obj = {};
                obj['vTREA_REGISTER_ID'] = vTREA_REGISTER_ID;          //金庫登記簿單號
                obj['vEXEC_TIME_B'] = vEXEC_TIME_B;                    //系統區間(起)
                obj['vEXEC_TIME_E'] = vEXEC_TIME_E;                    //系統區間(迄)
                obj['vOPEN_TREA_TIME'] = vOPEN_TREA_TIME;              //開庫時間
                obj['vMEMO'] = vMEMO;                                  //備註
                obj['vOPEN_TREA_REASON_ID'] = vOPEN_TREA_REASON_ID;    //開庫原因
                obj['vCREATE_UID'] = vCREATE_UID;                      //新增人員
                return obj;
            }
            //#endregion
            //region 使定時間開庫作業取消申請 ViewModel
            function SpecifiedTimeTreasuryCancelViewModel(vTREA_REGISTER_ID, vCREATE_UID, vAPLY_STATUS_ID, vAPPR_UID) {
                var obj = {};
                obj['vTREA_REGISTER_ID'] = vTREA_REGISTER_ID;    //金庫登記簿單號
                obj['vCREATE_UID'] = vCREATE_UID;                //新增人員
                obj['vAPLY_STATUS_ID'] = vAPLY_STATUS_ID         //表單狀態代碼
                obj['vAPPR_UID'] = vAPPR_UID                     //覆核人員
                return obj;
            }
            //#endregion
            //region 開啟金庫登記簿單號 事件
            function SearchGridCompeleteFun(listId) {
                $('#' + listId + ' > tbody > tr:gt(0)').each(function (i, j) {
                    //金庫登記簿單號
                    $(this).find('td').find('a.DialogREGISTERID').each(function () {
                        $(this).off('click');
                        $(this).on('click', function () {
                            SSTOpenREGISTERIDFun(listId, i + 1, false);
                        });
                    });
                });
            }
            //#endregion
            //region 開啟金庫登記簿單號
            function SSTOpenREGISTERIDFun(listId, rowId, closeFlag) {
                var data = $("#" + listId).getRowData(rowId);
                var whitchMethod = "Update";
                formInsert(whitchMethod, data);
            }
            //#endregion
            //region 產生 Dialog
            function SetDialogItem(whitchDialog) {
                var str = '';
                str += ' <div>';
                str += '<form >';
                str += '<div class="row">';
                str += '<div class="col-lg-3">';
                str += '<label>金庫登記簿單號 : </label>';
                str += '</div>';
                str += '<div class="col-lg-3 solid">';
                str += '<input type="text" id="' + whitchDialog + '_REGISTER_ID" size="15"/>';
                str += '</div>';
                str += '<div class="col-lg-3">';
                str += '<span class="red">＊</span>';
                str += '<label class="red">入庫日期 : </label>';
                str += '</div>';
                str += '<div class="col-lg-3 solid">';
                str += '<input type="text" id="' + whitchDialog + '_INTRADATE_ID" size="15"/>';
                str += '</div>';
                str += '</div>';
                str += '<div class="row">';
                str += '<div class="col-lg-3">';
                str += '<span class="red">＊</span>';
                str += '<label class="red">系統區間(起迄) : </label>';
                str += '</div>';
                str += '<div class="col-lg-3 solid">';
                str += '<input type="text" id="' + whitchDialog + '_SYSTIMESTART_ID" class="timepicker" size="4" />';
                str += '<label> ~</label>';
                str += '<input type="text" id="' + whitchDialog + '_SYSTIMEEND_ID" class="timepicker" size="4" />';
                str += '</div>';
                str += '<div class="col-lg-3">';
                str += '<span class="red">＊</span>';
                str += '<label class="red">開庫時間 : </label>';
                str += '</div>';
                str += '<div class="col-lg-3 solid">';
                str += '<input type="text" id="' + whitchDialog + '_INTRATIME_ID" class="timepicker" size="15" />';
                str += '</div>';
                str += '</div>';
                str += '<div class="row">';
                str += '<div class="col-lg-3">';
                str += '<span class="red">＊</span>';
                str += '<label class="red">內文編號 : </label>';
                str += '</div>';
                str += '<div class="col-lg-3 solid">';
                str += '<input type="text" id="' + whitchDialog + '_CASENO_ID" size="15" />';
                str += '</div>';
                str += '</div>';
                str += '<div class="row">';
                str += '<div class="col-lg-3">';
                str += '<label>備註 : </label>';
                str += '</div>';
                str += '<div class="col-lg-9 solid">';
                str += '<input type="text" id="' + whitchDialog + '_MEMO_ID" size="58" />';
                str += '</div>';
                str += '</div>';
                str += '<div class="row">';
                str += '<div class="col-lg-3"></div>';
                str += '<div class="col-lg-6 center" id="inputList">';
                str += '<input type="button" id="' + whitchDialog + '_Apply_ID" value="申請覆核" class="btn btn-primary marginRight" autofocus />';
                str += '<input type="button" id="' + whitchDialog + '_Close_ID" value="回上一頁" class="btn btn-primary marginLeft" />';
                str += '</div>';
                str += '<div class="col-lg-3"></div>';
                str += '</div>';
                str += '<div class="row">';
                str += '<div class="col-lg-3">';
                str += '<div class="solid backplum">';
                str += '<label>作業類型1</label>';
                str += '</div>';
                str += '<div class="solid">';
                str += '@Html.Raw(ViewBag.workType1)';
                str += '</div>';
                str += '</div>';
                str += '<div class="col-lg-3">';
                str += '<div class="solid backplum">';
                str += '<label>作業類型2</label>';
                str += '</div>';
                str += '<div class="solid">';
                str += '@Html.Raw(ViewBag.workType2)';
                str += '</div>';
                str += '</div>';
                str += '<div class="col-lg-3">';
                str += '<div class="solid backplum">';
                str += '<label>作業類型3</label>';
                str += '</div>';
                str += '<div class="solid">';
                str += '@Html.Raw(ViewBag.workType3)';
                str += '</div>';
                str += '</div>';
                str += '<div class="col-lg-3">';
                str += '<div class="solid backplum">';
                str += '<label>作業類型4</label>';
                str += '</div>';
                str += '<div class="solid">';
                str += '@Html.Raw(ViewBag.workType4)';
                str += '</div>';
                str += '</div>';
                str += '</div>';
                str += '</form>';
                str += '</div>';
                return str;
            }
            //#endregion
        });
    </script>
}


