@using Treasury.Web.Enum;
@using Treasury.WebUtility;
@{
    ViewBag.Title = "金庫進出管理作業-金庫物品存取覆核作業";
    //Layout = "~/Views/Shared/_Layout.cshtml";
    var opScope = ViewBag.opScope;

}

<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <form id="TAForm">
                     <table >
                         <tr >
                             <td>
                                 <label>申請日期:</label>
                             </td>
                             <td >                                
                                 <input type="text" id="APLY_DT_From" name="APLY_DT_From" />
                                 <label> ~&ensp;</label>
                                 <input type="text" id="APLY_DT_To" name="APLY_DT_To" />
                             </td>
                             <td>
                                 <label>單號:</label>
                             </td>
                             <td >
                                 <input type="text" id="APLY_NO" />
                             </td>
                         </tr>
                         <tr  style="text-align:center">
                             <td colspan="4">
                                 <input type="button" class="btn btn-primary" id="TAApprI_Search" value="查詢" style="display:none" />
                             </td>
                         </tr>
                     </table>
                    <div id="TAApprSearchDetail">
                    </div>
                </form>

            }
        </div>
    </div>
    <div id="TAApprSearchDetail" style="display:none" role="dialog" class="myDialog">
        <div id="TAApprjqgridDiv" class="col-sm-24 jqd" style="padding-bottom:5px;">
        </div>
        <div class="TAApprClass">
            <input type="button" class="TAPrint btn btn-primary" id="TAApprI_Appr" value="核准" />
            <input type="button" class="TAPrint btn btn-primary" id="TAApprI_Reject" value="駁回" />
        </div>
    </div>
    <div id="TAApprOpenSearchDialog" style="display:none" role="dialog" class="myDialog">
        <table>
            <tr>
                <td>
                    <label>申請單號 : </label>
                </td>
                <td>
                    <label></label>
                </td>
                <td>
                    <label>存取申請項目 : </label>
                </td>
                <td>
                    <label></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>申請單位 : </label>
                </td>
                <td>
                    <label></label>
                </td>
                <td>
                    <label>申請人 : </label>
                </td>
                <td>
                    <label></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>權責部門 : </label>
                </td>
                <td>
                    <label></label>
                </td>
                <td>
                    <label>申請作業 : </label>
                </td>
                <td>
                    <label></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>預計存取日期 : </label>
                </td>
                <td>
                    <label></label>
                </td>
                <td>
                    <label>填表日期 : </label>
                </td>
                <td>
                    <label></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>填表單位 : </label>
                </td>
                <td>
                    <label></label>
                </td>
                <td>
                    <label>填表人 : </label>
                </td>
                <td>
                    <label></label>
                </td>
            </tr>
            <tr>
                <td>
                    <label>申請原因 : </label>
                </td>
                <td colspan="3">
                    <textarea disabled></textarea> 
                </td>
            </tr>
        </table>
        <div id="TAApprOpenSearchDetail"></div>
    </div>
</div>



<script type="text/javascript">


    $(function () {

        //#region url設定
        var TAApprurl = {};
        TAApprurl.openBILL = '@Url.Action("View", "BILL")';
        TAApprurl.search = '@Url.Action("SearchAppr", "TreasuryAccess")';
        TAApprurl.getData = '@Url.Action("GetCacheData", "TreasuryAccess")';
        TAApprurl.Appr = '@Url.Action("", "");
        TAApprurl.Reject = '@Url.Action("", "");

        var openSearchDetailId = 'TAApprOpenSearchDetail';
        var TAFormId = 'TAForm';
        var _BILL = '@Ref.TreaItemType.BILL.GetDescription()';
        //#endregion

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {

            //#region 初始設定

            created.createDatepickerRange('APLY_DT_From', 'APLY_DT_To');

            $('input:button').each(function () {
                var id = $(this).attr('id');
                switch (id) {
                    case 'TAApprI_Search':
                        $('#' + id).on('click', function () { TAApprSearch(); });
                        break;
                }
            });
            //#endregion

        }

        //#region 初始設定
        function reset() {
            resetTAInsertDeatil();
        }
        //#endregion

        //#region 查詢畫面查詢
        function TAApprSearch() {
            var dialogId = 'TAApprOpenSearchDialog';
            $('#' + dialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: '查詢畫面',
                width: 1300,
                autoOpen: false,
                resizable: false,
                closeText: '取消'
            });

            $.ajax({
                type: 'POST',
                data: JSON.stringify({
                    searchModel: TreasuryAccessApprSearchViewModel(
                     $('#APLY_DT_From').val(),
                     $('#APLY_DT_To').val(),
                     $('#APLY_NO').val()
                     )
                }),
                url: TAApprurl.search,
                contentType: 'application/json',
            }).done(function (result) {
                if (result.RETURN_FLAG) {
                    $('#' + dialogId).dialog('open');
                    TAApprGrid();
                }
                else {
                    customerUtility.alert(result.DESCRIPTION, 'w');
                }
            });
        }
        //#endregion

        //#region 重設新增畫面
        function resetTAInsertDeatil() {
            $('#' + openInsertDetailId).children().remove();
            //$('#TAI_Insert').show();
        }
        //#endregion

        //#region formate 樣式

        function formatterCheck(cellvalue, options, rdata) {
            let str = '';
            if (cellvalue == 'Y') {
                str += "<div class='checkbox checkbox-info' title=' ' style='padding-top: 0px; margin-top: 0px; margin-bottom: 0px;'><input type='checkbox' id='" + options.gid + options.colModel.index + options.rowId + "' ' tage='" + options.colModel.index + "' name='" +
                    options.gid + options.colModel.index + options.rowId + "' title =' ' class='cbox TAReortCs customerCheck'></div>";
            }
            return str;
        }

        function formatterAPLYNO(cellvalue, options, rdata) {
            return "<a href='#' class='openDialog DialogAPLYNO' style='text-decoration:underline;' return:false; id='" + options.gid + "APLYNO" + options.rowId + "'  name='" + cellvalue + "' title='" + cellvalue + "' '>" + cellvalue + "</a>";
        }

        function UnformatterAPLYNO(cellvalue, options, rdata) {
            return cellvalue;
        }

        //#endregion

        //#region 查詢表單
        function TAApprGrid() {
            var colNameArray = ['項次', ' ',
                '存取項目', '申請日期', '申請單號',
                '申請單位', '申請人', '入庫原因',
                '表單狀態', '覆核意見/退回意見', '申請人ID', '表單狀態ID', '取出/存入'];
            var colModelArray = [
                { name: "vCancleFlag", index: "vCancleFlag", width: 70, sortable: false, align: 'center', formatter: formatterCancleFlag },
                { name: "vInvalidFlag", index: "vInvalidFlag", width: 40, sortable: false, align: 'center', formatter: formatterInvalidFlag },
                { name: "vItem", index: "vItem", width: 150, sortable: false, align: 'center' },
                { name: "vAPLY_DT", index: "vAPLY_DT", width: 100, sortable: false, align: 'center' },
                { name: "vAPLY_NO", index: "vAPLY_NO", width: 130, sortable: false, align: 'center', formatter: formatterAPLYNO, unformat: UnformatterAPLYNO },
                { name: "vAPLY_UNIT", index: "vAPLY_UNIT", width: 180, sortable: false, align: 'left' },
                { name: "vAPLY_UID_NAME", index: "vAPLY_UID_NAME", width: 70, sortable: false, align: 'center' },
                { name: "vACCESS_REASON", index: "vACCESS_REASON", width: 160, sortable: false, align: 'left' },
                { name: "vAPLY_STATUS_D", index: "vAPLY_STATUS_D", width: 160, sortable: false, align: 'left' },
                { name: "vDESC", index: "vDESC", width: 160, sortable: false, align: 'left' },
                { name: "vAPLY_UID", index: "vAPLY_UID", hidden: true },
                { name: "vAPLY_STATUS", index: "vAPLY_STATUS", hidden: true },
                { name: "vACCESS_TYPE", index: "vACCESS_TYPE", hidden: true },
            ];
            jqgridCustom.createJqgridByCache(
                'TAjqgridDiv1',
                'TAAccessList',
                'TAAccessPeger',
                TAurl.getData,
                {
                    type: 'Access'
                },
                colNameArray,
                colModelArray,
                '申請代辦區',
                jqgridCustom.getPage('TAjqgridDiv1'),
                TACancelAndInvalidateGridCompeleteFun,
                true
                );
        }

        //#endregion



        //#region 註冊 取消申請 & 作廢 & 開啟申請單號 事件
        function TACancelAndInvalidateGridCompeleteFun(listId) {
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                //取消申請
                $(this).find('td').find('a.actionCancle').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        TACancelFun(listId, i + 1);
                    });
                });
                //作廢
                $(this).find('td').find('a.actionInvalid').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        TAInvalidateFun(listId, i + 1);
                    });
                });
                //申請單號
                $(this).find('td').find('a.DialogAPLYNO').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        TAOpenAPLYNOFun(listId, i + 1);
                    });
                });
            });
        }

        function TAPrintGridCompeleteFun(listId) {
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                //申請單號
                $(this).find('td').find('a.DialogAPLYNO').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        TAOpenAPLYNOFun(listId, i + 1);
                    });
                });
            });
        }
        //#endregion




        //#region 開啟申請單號
        function TAOpenAPLYNOFun(listId, rowid) {
            var data = $("#" + listId).getRowData(rowid);
            var itemId = data.vItem;
            $.ajax({
                type: 'POST',
                data: JSON.stringify({
                    AplyNo: data.vAPLY_NO,
                    data: null
                }),
                url: GetOpenUrl(itemId),// TAurl.openBILL,
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    $('#' + openSearchDetailId).html(data);
                    var width = '850px';
                    openTADialog(_BILL, width, 'TAOpenSearchDialog');
                }
            })
        }
        //#endregion



        function TreasuryAccessApprSearchViewModel(
            vAPLY_DT_S,
            vAPLY_DT_E,
            vAPLY_NO
            ) {
            var obj = {};
            obj['vAPLY_DT_S'] = vAPLY_DT_S;
            obj['vAPLY_DT_E'] = vAPLY_DT_E;
            obj['vAPLY_NO'] = vAPLY_NO;
            return obj;
        }
    });
</script>


