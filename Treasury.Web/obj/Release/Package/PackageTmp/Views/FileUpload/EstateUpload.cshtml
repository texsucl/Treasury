@using Treasury.Web.Enum;
@using Treasury.WebUtility;
@{
    ViewBag.Title = "上傳檔案作業-不動產權狀資料";
    //Layout = "~/Views/Shared/_Layout.cshtml";
    var opScope = ViewBag.opScope;

}

<div class="container-fluid" id="main">
    <div class="panel panel-primary">
        <div class="panel-heading">@ViewBag.Title</div>
        <div class="panel-body">
            <div id="validationSummary" style="color:red;">
            </div>
            @if (opScope != "" && opScope != "0")
            {
                <form id="EstateUploadForm">
                <table>
                    <tr>
                        <td>
                            <input type="button" id="SearchUser" class="btn btn-primary" value="查詢UserId" />
                        </td>
                        <td>
                            <label>使用者名字 : </label>
                        </td>
                        <td>
                            <input type="text" id="userName" name="userName"/>
                        </td>
                        <td style="padding-left:30px;width:100px">
                            <label>User資料 : </label>
                        </td>
                        <td style="width:200px">
                            @Html.DropDownList("User_Info", new SelectList(new List<SelectOption>() { }, "Value", "Text"))
                        </td>
                    </tr>
                </table>
                </form>
                <table>
                     <tr>
                         <td style="padding-top:10px" colspan="2">
                             @using (Ajax.BeginForm("Estate_Upload", "FileUpload",
                                new AjaxOptions { HttpMethod = "POST" },
                                new { enctype = "multipart/form-data", @id = "form0" }))
                             {
                                 <input type="file" id="file" name="file" class="filestyle" data-buttonName="btn-primary" data-buttonText="轉檔檔案" />
                             }
                         </td>
                         <td  colspan="2">
                             @Html.RadioButton("ExcelType", "BookNo", new { @checked = true }) 冊號
                             @Html.RadioButton("ExcelType", "Estate") 不動產
                         </td>
                         <td style="padding-top:10px" >
                             <input type="button" class="btn btn-primary" style="margin-right:10px" value="資料上傳" id="fileSubmit" />
                             <input type="button" class="btn btn-primary" value="轉檔" id="btnTransfer" disabled />
                         </td>
                     </tr>
                     <tr>
                         <td colspan="5">
                             <i class="fa fa-exclamation-circle title" style="font-size:24px;"
                                alt="說明：
"></i>
                         </td>
                     </tr>
                 </table>          
            }
        </div>
    </div>
    <div class="viewDetail">
        <div id="jqgridDiv" class="jqd" style="overflow:auto">
        </div>
    </div>
</div>



<script type="text/javascript">


    $(function () {

        //#region url設定
        var url = {};
        url.searchUserId = '@Url.Action("Search", "FileUpload")';
        url.transfer = '@Url.Action("Transfer", "FileUpload")';
        url.bookNo = '@Url.Action("BookNo_Upload", "FileUpload")';
        url.getExcelData = '@Url.Action("GetCacheData", "FileUpload")';


        var FormId = 'EstateUploadForm';
        var FileType = 'Estate';
        //#endregion

        var opScope = '@Html.Raw(ViewBag.opScope)';

        if (opScope == "" || opScope == "0") {
            $('#validationSummary').children().remove();

            var validationSummary = $('#validationSummary ul.validation-summary-errors');

            if (validationSummary.length == 0) {
                $('#validationSummary').append('<ul class="validation-summary-errors"></ul>');
                validationSummary = $('#validationSummary ul.validation-summary-errors');
            }
            validationSummary.append('<li>' + '無使用權限' + '</li>');

        } else {

            //#region 初始設定

            verified.required(FormId, 'userName', message.required('使用者名字')); //使用者名字為必填

            $('input:button').each(function () {
                var id = $(this).attr('id');
                switch (id) {
                    case 'SearchUser':
                        $('#' + id).on('click', function() { Search(); });
                        break;
                    case 'fileSubmit':
                        $("#" + id).on('click', function () { fileSubmitFunction() });
                        break;
                    case 'btnTransfer':
                        $("#" + id).click(transfer);
                        break;
                }
            })

            $('input[name=ExcelType]').on('change', function () {
                clearJqgrid();      
            });

            //#endregion

            //#region 資料上傳(Excel 資料寫入 local sql)
            function transfer() {
                $.ajax({
                    type: "POST",
                    url: url.transfer,
                    data: JSON.stringify({
                        type: FileType
                    }),
                    contentType: 'application/json'
                })
                .done(function (result) {
                    customerUtility.alertAuto(result);
                })
            }
            //#endregion 資料上傳(Excel 資料寫入 local sql)

            //#region fileSubmitFunction (把檔案上傳到指定資料夾)
            function fileSubmitFunction() {
                clearJqgrid();
                var dataString;
                var action = $("#form0").attr("action");
                if ($("#form0").attr("enctype") == "multipart/form-data") {
                    dataString = new FormData();
                    dataString.append("UploadedFile", $("#file").get(0).files[0]);
                    dataString.append("type", FileType);
                }
                else {
                    // regular form, do your own thing if you need it
                }

                var type = $('input[name=ExcelType]:checked').val();
                if(type == 'BookNo')
                    action = url.bookNo;
                //clearJqgrid();
                $.ajax({
                    type: "POST",
                    url: action,
                    data: dataString,
                    dataType: "json",
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        if (result.RETURN_FLAG) {
                            if(type == 'BookNo')
                            {
                                BookNoGird();
                            }
                            else
                            {
                                EstateGird();
                            }                         
                            $('#btnTransfer').prop('disabled', false);
                        }
                        else {
                            customerUtility.alert(result.DESCRIPTION, 'w');
                        }
                    },
                    error: function (result) {
                        customerUtility.alert('格式錯誤', 'e');
                    }
                });
            }
            //#endregion fileSubmitFunction
        }

        //#region 查詢畫面查詢
        function Search() {
            $('#'+ FormId).validate().resetForm();
            if ($('#' + FormId).valid()) {
                $.ajax({
                    type: 'POST',
                    data: JSON.stringify({
                        userName: $('#userName').val()
                    }),
                    url: url.searchUserId,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.addoption('User_Info',result.Datas);
                    }
                });
            }

        }
        //#endregion

        function clearJqgrid() {
            $('#jqgridDiv').children().remove();
        }

        //#region 查詢表單
        function BookNoGird() {
            var colNameArray =  @Html.Raw(Json.Encode(ViewBag.jqgridBookNOColNames));
            var colModelArray = @Html.Raw(Json.Encode(ViewBag.jqgridBookNoColModel));
            jqgridCustom.createJqgridByCache(
                'jqgridDiv',
                'jqgridList',
                'jqgridPeger',
                url.getExcelData,
                {
                    type: 'BookNo'
                },
                colNameArray,
                colModelArray,
                '上傳資料',
                jqgridCustom.getPage('jqgridDiv'),
                null,
                true
                );
        }

        //#endregion
        //#region 查詢表單
        function EstateGird() {
            var colNameArray =  @Html.Raw(Json.Encode(ViewBag.jqgridEstateColNames));
            var colModelArray = @Html.Raw(Json.Encode(ViewBag.jqgridEstateColModel));
            jqgridCustom.createJqgridByCache(
                'jqgridDiv',
                'jqgridList',
                'jqgridPeger',
                url.getExcelData,
                {
                    type: 'Estate'
                },
                colNameArray,
                colModelArray,
                '上傳資料',
                jqgridCustom.getPage('jqgridDiv'),
                null,
                true
                );
        }

        //#endregion
    });
</script>


