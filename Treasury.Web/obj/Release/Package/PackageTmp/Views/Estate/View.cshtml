@using Treasury.Web.Enum;
@using Treasury.WebUtility;
<div class="row">
    <div style="padding-bottom:5px;">
        <input type="button" id="ESTATEInsert" value="新增存入明細" class="btn btn-primary"/>
    </div>
    <div id="ESTATEjqgridDiv1" class="col-sm-24" style="padding-bottom:5px;">

    </div>
    <div id="ESTATEjqgridDiv2"  class="col-sm-24">

    </div>
    <div style="text-align:center;padding-top:5px;display:none;"  class="ESTATEAct">
        <input type="button" id="ESTATEApply" value="申請覆核"  class="btn btn-primary" />
        <input type="button" id="ESTATECancel" value="取消申請"  class="btn btn-primary" />
        <input type="button" id="ESTATEBack" value="回到功能選擇"  class="btn btn-primary" />
    </div>
    <div id="BillInsertDialog" style="display:none;">
        <form id="ESTATEForm">
            <table>
                <tr>
                    <td >
                        <label>存入資料 : </label>
                    </td>
                    <td colspan="3">

                    </td>
                </tr>
                <tr>
                    <td >
                        <label>冊號 : </label>
                    </td>
                    <td>

                    </td>
                    <td>
                        <label>大樓名稱 : </label>
                    </td>
                    <td>
                      
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>坐落 : </label>
                    </td>
                    <td>
                        <input type="text" class="ESTATEInsertType" id="tESTATE_Check_No_B" name="tESTATE_Check_No_B"/>
                    </td>
                    <td>
                        <label>備註 : </label>
                    </td>
                    <td>
                        <input type="text" class="ESTATEInsertType" id="tESTATE_Check_No_E" name="tESTATE_Check_No_E" />
                    </td>
                </tr>
                <tr>
                    <td colspan="4">
                        <input type="hidden" id="tAplyNo" />
                        <input type="hidden" id="tDataSeq" />
                        <input type="hidden" id="tItemId" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="button" id="ESTATEInsertTemp" value="新增" class="btn btn-primary" style="display:none"/>
                        <input type="button" id="ESTATEUpdateTemp" value="修改" class="btn btn-primary" style="display:none"/>
                        <input type="button" id="ESTATEDeleteTemp" value="刪除" class="btn btn-primary" style="display:none"/>
                    </td>
                    <td colspan="2" style="text-align:right;">
                        <input type="button" id="ESTATECancelTemp" value="取消" class="btn btn-primary" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id="BillTakeOutDialog" style="display:none">
        <form id="ESTATETakeOutForm">
            <table>
                <tr>
                    <td>
                        <label>發票行庫 : </label>
                    </td>
                    <td>
                        <label id="lESTATE_Issuing_Bank"></label>
                    </td>
                    <td>
                        <label>類型 : </label>
                    </td>
                    <td>
                        <label id="lESTATE_Check_Type"></label>
                    </td>
                    <td style="width:70px">
                        <label>字軌 : </label>
                    </td>
                    <td>
                        <label id="lESTATE_Check_No_Track"></label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>票號(起) : </label>
                    </td>
                    <td>
                        <label id="lESTATE_Check_No_B"></label>
                    </td>
                    <td>
                        <label>票號(迄) : </label>
                    </td>
                    <td>
                        <label id="lESTATE_Check_No_E"></label>
                    </td>
                    <td colspan="2">
                        <input type="hidden" id="hItemId" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>取出票號(迄) : </label>
                    </td>
                    <td>
                        <input type="text" id="tTakeOutE" name="tTakeOutE"/>
                    </td>
                    <td>
                        <label>取出總張數 : </label>
                    </td>
                    <td>
                        <input type="text" id="tTakeOutTotalNum" name="tTakeOutTotalNum" />
                    </td>
                    <td colspan="2">
                        <input type="hidden" id="hESTATE_total" />
                        <input type="hidden" id="hReMainTotalNum">
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <input type="button" id="ESTATETakeOutTemp" value="取出" class="btn btn-primary" />
                    </td>
                    <td colspan="3" style="text-align:right;">
                        <input type="button" id="ESTATETakeOutCancelTemp" value="取消" class="btn btn-primary" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<script>
    $(function () {
        //#region 參數設定
        var ESTATEFormId = 'ESTATEForm'; //formId
        var ESTATE_AplyNoId = 'tAplyNo'; //申請單號Id
        var ESTATE_DataSeqId = 'tDataSeq'; //明細流水號Id
        var ESTATE_ItemId = 'tItemId'; //物品編號Id
        var ESTATE_Check_TypeId = 'dESTATE_Check_Type'; //支票類型Id
        var ESTATE_Issuing_BankId = 'tESTATE_Issuing_Bank'; //行庫Id
        var ESTATE_Check_No_TrackId = 'tESTATE_Check_No_Track'; //字軌Id
        var ESTATE_Check_No_BId = 'tESTATE_Check_No_B'; //票號(起)Id
        var ESTATE_Check_No_EId = 'tESTATE_Check_No_E'; //票號(迄)Id
        var ESTATETakeOutFormId = 'ESTATETakeOutForm'; //TakeOutformId
        var ESTATE_totalId = 'ESTATE_total'; //總張數Id
        var ESTATE_Take_OutId = 'tTakeOutE'; //取出票號(迄)Id
        var ESTATE_Take_Out_TotalId = 'tTakeOutTotalNum'; //取出總張數
        var ESTATE_Act_Type = 'True' == '@ViewBag.dActType'; //覆核狀態      
        var type = $('input[name=cProjectType]:checked').val();
        if (!ESTATE_Act_Type) { //不是覆核狀態 (為使用單號查詢資料)
            $('.ESTATEAct').hide();
            type = '@ViewBag.dAccess';
            $('.aplyNoDetail').show();
            var TARdata = @Html.Raw(Json.Encode(ViewBag.TAR));
            //$('#TAVMvAplyNo').text(TARdata.vAplyNo);
            //$('#TAVMvItem').text(TARdata.vItem)
            //$('#TAVMvAplyUnit').text(TARdata.vAplyUnit);
            //$('#TAVMvAplyUid').text(TARdata.vAplyUid);
            //$('#TAVMvChargeUnit').text(TARdata.vAplyUnit);
            //$('#TAVMvAccessType').text(TARdata.vAccessType);
            //$('#TAVMvExpectedAccessDate').text(TARdata.vExpectedAccessDate);
            //$('#TAVMvCreateDt').text(TARdata.vCreateDt);
            //$('#TAVMvCreateUnit').text(TARdata.vCreateUnit);
            //$('#TAVMvCreateUid').text(TARdata.vCreateUid);
            //$('#TAVMvAccessReason').val(TARdata.vAccessReason);
        }
        else { //是覆核狀態 (為存入 or 取出 動作)
            $('.ESTATEAct').show();
        }
        var typeFlag = (type == '@Ref.AccessProjectTradeType.P.ToString()'); //存入為 True 取出 為 False
        if (typeFlag && ESTATE_Act_Type) {
            $('#ESTATEInsert').show();
        }
        else
        {
            $('#ESTATEInsert').hide();
        }
        //#endregion

        //#region url設定
        var ESTATEurl = {};
        ESTATEurl.Insert = '@Url.Action("InsertView", "Bill")';
        ESTATEurl.getData = '@Url.Action("GetCacheData", "Bill")';
        ESTATEurl.InsertTempData = '@Url.Action("InsertTempData", "Bill")';
        ESTATEurl.UpdateTempData = '@Url.Action("UpdateTempData", "Bill")';
        ESTATEurl.DeleteTempData = '@Url.Action("DeleteTempData", "Bill")';
        ESTATEurl.ResetTempData = '@Url.Action("ResetTempData", "Bill")';
        ESTATEurl.TakeOutData = '@Url.Action("TakeOutData", "Bill")';
        ESTATEurl.ApplyTempData = '@Url.Action("ApplyTempData", "Bill")';
        ESTATEurl.RepeatData = '@Url.Action("RepeatData", "Bill")';
        //#endregion

        //#region 初始動作
        ESTATETempGrid();
        ESTATEDayGrid();
        setESTATEVerified();
        //#endregion

        //#region 註冊verified
        function setESTATEVerified() {
            verified.english(ESTATEFormId, ESTATE_Check_No_TrackId); //字軌僅能輸入英文
            verified.required(ESTATEFormId, ESTATE_Check_No_TrackId, message.required('字軌')); //字軌為必填
            verified.maxlength(ESTATEFormId, ESTATE_Check_No_TrackId, 4); //字軌最大長度(4)
            verified.positiveInt(ESTATEFormId, ESTATE_Check_No_BId); //票號(起) 僅能輸入數字(正)
            verified.required(ESTATEFormId, ESTATE_Check_No_BId, message.required('票號(起)')); //票號(起)為必填
            verified.maxlength(ESTATEFormId, ESTATE_Check_No_BId, 8); //票號(起)最大長度(8)
            verified.positiveInt(ESTATEFormId, ESTATE_Check_No_EId); //票號(迄) 僅能輸入數字(正)
            verified.required(ESTATEFormId, ESTATE_Check_No_EId, message.required('票號(迄)')); //票號(迄)為必填
            verified.maxlength(ESTATEFormId, ESTATE_Check_No_EId, 8); //票號(迄)最大長度(8)
            verified.positiveInt(ESTATETakeOutFormId, ESTATE_Take_OutId); //取出票號(迄) 僅能輸入數字(正)
            verified.maxlength(ESTATETakeOutFormId, ESTATE_Take_OutId, 8); //取出票號(迄)最大長度(8)
            verified.required(ESTATETakeOutFormId, ESTATE_Take_OutId, message.required('取出票號(迄)'));
            verified.positiveInt(ESTATETakeOutFormId, ESTATE_Take_Out_TotalId); //取出總張數 僅能輸入數字(正)
            verified.required(ESTATETakeOutFormId, ESTATE_Take_Out_TotalId, message.required('總張數'));
        }
        //#endregion

        //#region 註冊事件
        $('input:button').each(function () {
            var id = $(this).attr('id');          
            switch (id) {
                case 'ESTATEInsert':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATEInsertFun(); });
                    break;
                case 'ESTATEApply':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATEApplyFun(); });
                    break;
                case 'ESTATECancel':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATECancelFun(); });
                    break;
                case 'ESTATEBack':
                case 'ESTATECancelTemp':
                case 'ESTATETakeOutCancelTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { customerUtility.closeDialog(this); });
                    break;
                case 'ESTATEInsertTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATEInsertTempFun(); });
                    break;
                case 'ESTATEUpdateTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATEUpdateTempFun(); });
                    break;
                case 'ESTATEDeleteTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATEDeleteTempFun(); });
                    break;
                case 'ESTATETakeOutTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { ESTATETakeOutTempFun(); });
                    break;
            }
        });
        $('#' + ESTATE_Take_OutId).off('blur', function () { });
        $('#' + ESTATE_Take_OutId).on('blur', function () {
            if ($('#' + ESTATE_Take_OutId).val().length <= 8)
            {
                var _ESTATE_Take_Out = parseInt($('#tTakeOutE').val());
                var _lESTATE_Check_No_E = parseInt($('#lESTATE_Check_No_E').text());
                var _lESTATE_Check_No_B = parseInt($('#lESTATE_Check_No_B').text());
                if (!isNaN(_ESTATE_Take_Out) && _lESTATE_Check_No_E >= _ESTATE_Take_Out && _ESTATE_Take_Out >= _lESTATE_Check_No_B)
                {
                    $('#' + ESTATE_Take_Out_TotalId).val((_ESTATE_Take_Out - _lESTATE_Check_No_B + 1));
                }
                if (!isNaN(_ESTATE_Take_Out))
                    $('#' + ESTATE_Take_OutId).val(created.padLeft(_ESTATE_Take_Out, 8, '0'));
            }
        });
        $('#' + ESTATE_Take_Out_TotalId).off('blur', function () { });
        $('#' + ESTATE_Take_Out_TotalId).on('blur', function () {
            var _ESTATE_Take_O_Total = parseInt($('#' + ESTATE_Take_Out_TotalId).val());
            var _total = parseInt($('#hESTATE_total').val());
            if (!isNaN(_ESTATE_Take_O_Total) && _total >= _ESTATE_Take_O_Total) {                
                $('#' + ESTATE_Take_OutId).val(created.padLeft((parseInt($('#lESTATE_Check_No_B').text()) + _ESTATE_Take_O_Total - 1), 8, '0'));
            }
        });


        //計算總張數
        $('#' + ESTATE_Check_No_BId + ',#' + ESTATE_Check_No_EId).off('blur', function () { });
        $('#' + ESTATE_Check_No_BId + ',#' + ESTATE_Check_No_EId).on('blur', function () {
            setESTATE_total();
        });

        function setESTATE_total()
        {
            if ($('#' + ESTATE_Check_No_BId).val().length <= 8 && $('#' + ESTATE_Check_No_EId).val().length <= 8) {
                var _Check_No_B = parseInt($('#' + ESTATE_Check_No_BId).val());
                var _Check_No_E = parseInt($('#' + ESTATE_Check_No_EId).val());
                if (!isNaN(_Check_No_B) && !isNaN(_Check_No_E) && _Check_No_E >= _Check_No_B) {
                    $('#' + ESTATE_totalId).html(_Check_No_E - _Check_No_B + 1);
                }
                else {
                    $('#' + ESTATE_totalId).html('');
                }
                if (!isNaN(_Check_No_B))
                    $('#' + ESTATE_Check_No_BId).val(created.padLeft(_Check_No_B, 8, '0'));
                if (!isNaN(_Check_No_E))
                    $('#' + ESTATE_Check_No_EId).val(created.padLeft(_Check_No_E, 8, '0'));
            }
            else {
                $('#' + ESTATE_totalId).html('');
            }
        }
        //#endregion

        function ESTATEApplyFun() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: ESTATEurl.ApplyTempData,
                contentType: 'application/json',
            }).done(function (result) {
                customerUtility.alertAuto(result);
                if (result.RETURN_FLAG) {
                    customerUtility.closeDialog($('#ESTATEApply'));
                }
            })
        }

        function ESTATECancelFun() {
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    AccessType: type
                }),
                dataType: "json",
                url: ESTATEurl.ResetTempData,
                contentType: 'application/json',
            }).done(function (result) {
                ResetInsertDialog();
                ESTATETempGrid();
                ESTATEDayGrid();
            })
        }

        function formatterTakeOut(cellvalue, options, rdata) {
            let str = '';
            str += '<div class="btn-group">';
            str += '<a title="取出" class="btn actionTakeout" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="ESTATE' + options.gid + 'TakeOut' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-pencil-square-o fa-lg"></i></a>';
            str += '<a title="重設" class="btn actionRepeat" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="ESTATE' + options.gid + 'Repeat' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-repeat fa-lg"></i></a>';
            str += '</div>';
            return str;
        }

        function ESTATEformatterCheckType(cellvalue, options, rdata)
        {
            var value = '';
            switch (cellvalue)
            {
                case '01':
                    value = '01 有膠';
                    break;
                case '02':
                    value = '02 無膠';
                    break;
                case null:
                    value = '';
                    break;
                default:
                    value = cellvalue;
                    break;
            }
            return value;
        }

        function ESTATEunformatterCheckType(cellvalue, options, rdata) {
            return cellvalue;
        }

        function ESTATETempGrid() {
            if (typeFlag) {
                var colNameArray = ['項次', '動作', '發票行庫', '類型', '字軌',
                    '支票號碼(起)', '支票號碼(迄)', '總張數',
                    '物品單號', '申請單號', '明細流水號'];
                var colModelArray = [
                     { name: "vRowNum", index: "vRowNum", width: 40, sortable: false, align: 'right' }
                ];
                if (ESTATE_Act_Type) {
                    colModelArray.push({ name: "act", index: "act", width: 90, sortable: false });
                    colModelArray.push({ name: "vIssuingBank", index: "vIssuingBank", width: 120, sortable: false });
                }
                else {
                    colModelArray.push( { name: "act", index: "act", width: 0, sortable: false, hidden: true });
                    colModelArray.push({ name: "vIssuingBank", index: "vIssuingBank", width: 210, sortable: false });
                }
                colModelArray.push({ name: "vCheckType", index: "vCheckType", width: 80, sortable: false, formatter: ESTATEformatterCheckType, unformat: ESTATEunformatterCheckType });
                colModelArray.push({ name: "vCheckNoTrack", index: "vCheckNoTrack", width: 60, sortable: false });
                colModelArray.push({ name: "vCheckNoB", index: "vCheckNoB", width: 120, sortable: false, align: 'center' });
                colModelArray.push({ name: "vCheckNoE", index: "vCheckNoE", width: 120, sortable: false, align: 'center' });
                colModelArray.push({ name: "vCheckTotalNum", index: "vCheckTotalNum", width: 200, sortable: false, align: 'right' });
                colModelArray.push({ name: "vItemId", index: "vItemId", hidden: true });
                colModelArray.push({ name: "vAplyNo", index: "vAplyNo", hidden: true });
                colModelArray.push({ name: "vDataSeq", index: "vDataSeq", hidden: true });
                jqgridCustom.createJqgridByCache(
                    'ESTATEjqgridDiv1',
                    'ESTATETempList',
                    'ESTATETempPeger',
                    ESTATEurl.getData,
                    {
                        type: 'Temp'
                    },
                    colNameArray,
                    colModelArray,
                    '存入明細資料',
                    jqgridCustom.getPage('ESTATEjqgridDiv1'),
                    ESTATETempCompleteFun
                    );
            }
            else {
                var colNameArray = ['項次', '取出', '發票行庫', '類型',
                    '字軌', '票號(起)', '票號(迄)', '取出票號(迄)', '取出總張數',
                    '總張數', '剩餘總張數', '物品單號'];
                var colModelArray = [{ name: "vRowNum", index: "vRowNum", width: 40, sortable: false, align: 'right' }];
                if (ESTATE_Act_Type) {
                    colModelArray.push({ name: "act", index: "act", width: 90, sortable: false, formatter: formatterTakeOut, align: 'center' });
                    colModelArray.push({ name: "vIssuingBank", index: "vIssuingBank", width: 120, sortable: false });
                }
                else {
                    colModelArray.push({ name: "act", index: "act", width: 0, sortable: false, formatter: formatterTakeOut, align: 'center', hidden: true });
                    colModelArray.push({ name: "vIssuingBank", index: "vIssuingBank", width: 210, sortable: false });
                }
                colModelArray.push({ name: "vCheckType", index: "vCheckType", width: 80, sortable: false, formatter: ESTATEformatterCheckType, unformat: ESTATEunformatterCheckType });
                colModelArray.push({ name: "vCheckNoTrack", index: "vCheckNoTrack", width: 60, sortable: false });
                colModelArray.push({ name: "vCheckNoB", index: "vCheckNoB", width: 120, sortable: false, align: 'center' });
                colModelArray.push({ name: "vCheckNoE", index: "vCheckNoE", width: 120, sortable: false, align: 'center' });
                colModelArray.push({ name: "vTakeOutE", index: "vTakeOutE", width: 120, sortable: false, align: 'center' });
                colModelArray.push({ name: "vTakeOutTotalNum", index: "vTakeOutTotalNum", width: 80, sortable: false, align: 'right' });
                colModelArray.push({ name: "vCheckTotalNum", index: "vCheckTotalNum", hidden: true });
                colModelArray.push({ name: "vReMainTotalNum", index: "vReMainTotalNum", hidden: true });
                colModelArray.push({ name: "vItemId", index: "vItemId", hidden: true });
                jqgridCustom.createJqgridByCache(
                    'ESTATEjqgridDiv1',
                    'ESTATETempList',
                    'ESTATETempPeger',
                    ESTATEurl.getData,
                    {
                        type: 'Temp'
                    },
                    colNameArray,
                    colModelArray,
                    '取出明細資料',
                    jqgridCustom.getPage('ESTATEjqgridDiv1'),
                    ESTATETempTakeOutFun
                    );
            }
        }

        function ESTATEDayGrid() {
            if(typeFlag){
                var colNameArray = ['項次', '庫存狀態', '發票行庫', '類型',
                    '總張數', '剩餘總張數', '字軌', '支票號碼(起)', '支票號碼(迄)',
                    '物品單號', '申請單號', '明細流水號'];
                var colModelArray = [
                    { name: "vRowNum", index: "vRowNum", width: 40, sortable: false, align: 'right' },
                    { name: "vStatus", index: "vStatus", width: 90, sortable: false, align: 'center' },
                    { name: "vIssuingBank", index: "vIssuingBank", width: 120, sortable: false },
                    { name: "vCheckType", index: "vCheckType", width: 80, sortable: false, formatter: ESTATEformatterCheckType, unformat: ESTATEunformatterCheckType },
                    { name: "vCheckTotalNum", index: "vCheckTotalNum", width: 120, sortable: false, align: 'right' },
                    { name: "vReMainTotalNum", index: "vReMainTotalNum", width: 80, sortable: false, align: 'right' },
                    { name: "vCheckNoTrack", index: "vCheckNoTrack", width: 60, sortable: false },
                    { name: "vCheckNoB", index: "vCheckNoB", width: 120, sortable: false, align: 'center' },
                    { name: "vCheckNoE", index: "vCheckNoE", width: 120, sortable: false, align: 'center' },
                    { name: "vItemId", index: "vItemId", hidden: true },
                    { name: "vAplyNo", index: "vAplyNo", hidden: true },
                    { name: "vDataSeq", index: "vDataSeq", hidden: true },
                ];
                jqgridCustom.createJqgridByCache(
                    'ESTATEjqgridDiv2',
                    'ESTATEDayList',
                    'ESTATEDayPeger',
                    ESTATEurl.getData,
                    {
                        type: 'Day'
                    },
                    colNameArray,
                    colModelArray,
                    '當日庫存明細資料',
                    jqgridCustom.getPage('ESTATEjqgridDiv2')
                    );
            }
            else{
                var colNameArray = ['項次', '庫存狀態', '發票行庫', '類型',
                    '總張數', '剩餘總張數', '字軌', '支票號碼(起)', '支票號碼(迄)',
                    '物品單號'];
                var colModelArray = [
                    { name: "vRowNum", index: "vRowNum", width: 40, sortable: false, align: 'right' },
                    { name: "vStatus", index: "vStatus", width: 90, sortable: false, align: 'center' },
                    { name: "vIssuingBank", index: "vIssuingBank", width: 120, sortable: false },
                    { name: "vCheckType", index: "vCheckType", width: 80, sortable: false, formatter: ESTATEformatterCheckType, unformat: ESTATEunformatterCheckType },
                    { name: "vCheckTotalNum", index: "vCheckTotalNum", width: 120, sortable: false, align: 'right' },
                    { name: "vReMainTotalNum", index: "vReMainTotalNum", width: 80, sortable: false, align: 'right' },
                    { name: "vCheckNoTrack", index: "vCheckNoTrack", width: 60, sortable: false },
                    { name: "vCheckNoB", index: "vCheckNoB", width: 120, sortable: false, align: 'center' },
                    { name: "vCheckNoE", index: "vCheckNoE", width: 120, sortable: false, align: 'center' },
                    { name: "vItemId", index: "vItemId", hidden: true },
                ];
                jqgridCustom.createJqgridByCache(
                    'ESTATEjqgridDiv2',
                    'ESTATEDayList',
                    'ESTATEDayPeger',
                    ESTATEurl.getData,
                    {
                        type: 'Day'
                    },
                    colNameArray,
                    colModelArray,
                    '當日庫存明細資料',
                    jqgridCustom.getPage('ESTATEjqgridDiv2')
                    );
            }

        }

        function ESTATETempTakeOutFun(listId) {
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                $(this).find('td').find('a.actionTakeout').each(function () {
                    $(this).off('click');
                    $(this).on('click',function(){
                        dialogTakeOutOpen(i+1);
                    });
                });
                $(this).find('td').find('a.actionRepeat').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        repeat(i + 1);
                    });
                });
            });
        }

        function repeat(rowid) {
            var listId = 'ESTATETempList';
            var data = $("#" + listId).getRowData(rowid);
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: BillViewModel(
                        data.vItemId)
                }),
                dataType: "json",
                url: ESTATEurl.RepeatData,
                contentType: 'application/json',
            }).done(function (result) {
                customerUtility.alertAuto(result);
                if (result.RETURN_FLAG) {
                    ESTATETempGrid();
                    ESTATEDayGrid();
                }
            });
        }

        function dialogTakeOutOpen(rowid) {
            $('#' + ESTATETakeOutFormId).validate().resetForm();
            var dialogId = 'BillTakeOutDialog';
            var listId = 'ESTATETempList';
            var data = $("#" + listId).getRowData(rowid);
            $('#lESTATE_Issuing_Bank').text('');
            $('#lESTATE_Issuing_Bank').text(data.vIssuingBank);
            $('#lESTATE_Check_Type').text('');
            $('#lESTATE_Check_Type').text(data.vCheckType);
            $('#lESTATE_Check_No_Track').text('');
            $('#lESTATE_Check_No_Track').text(data.vCheckNoTrack);
            $('#lESTATE_Check_No_B').text('');
            $('#lESTATE_Check_No_B').text(data.vCheckNoB);
            $('#lESTATE_Check_No_E').text('');
            $('#lESTATE_Check_No_E').text(data.vCheckNoE);
            $('#hItemId').val('');
            $('#hItemId').val(data.vItemId);
            $('#hESTATE_total').val('');
            $('#hESTATE_total').val(data.vCheckTotalNum);
            $('#hReMainTotalNum').val('');
            $('#hReMainTotalNum').val(data.vReMainTotalNum);
            $('#tTakeOutE').val('');
            $('#tTakeOutE').val(data.vTakeOutE);
            $('#tTakeOutTotalNum').val('');
            $('#tTakeOutTotalNum').val(data.vTakeOutTotalNum);
            $('#' + dialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: '取出空白票券',
                width: 'auto',
                autoOpen: false,
                resizable: false,
                closeText: '取消',
            });
            $('#' + dialogId).dialog('open');
        }

        function ESTATETakeOutTempFun()
        {
            if ($('#' + ESTATETakeOutFormId).valid()) {
                var _ESTATE_Take_OutE = parseInt($('#tTakeOutE').val());
                var _lESTATE_Check_No_E = parseInt($('#lESTATE_Check_No_E').text());
                var _lESTATE_Check_No_B = parseInt($('#lESTATE_Check_No_B').text());
                var _ESTATE_total = parseInt($('#hESTATE_total').val());
                var _ESTATE_Take_Out_Total = parseInt($('#' + ESTATE_Take_Out_TotalId).val());
                var _Check_No_B = parseInt($('#' + ESTATE_Check_No_BId).val());
                var _Check_No_E = parseInt($('#' + ESTATE_Check_No_EId).val());
 
                if (_ESTATE_Take_OutE > _lESTATE_Check_No_E) {
                    customerUtility.alert('取出票號(迄)不可大於票號(迄)!', 'w');
                    return false;
                }
                if (_lESTATE_Check_No_B > _ESTATE_Take_OutE) {
                    customerUtility.alert('取出票號(迄)不可小於票號(起)!', 'w');
                    return false;
                }
                if (_ESTATE_Take_Out_Total >  _ESTATE_total){
                    customerUtility.alert('取出總張數不可大於總張數(' + _ESTATE_total + ')!', 'w');
                    return false;
                }
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: BillViewModel(
                            $('#hItemId').val(),
                            null,
                            null,
                            null,
                            null,
                            null,
                            null,
                            null,
                            null,
                            $('#tTakeOutE').val(),
                            $('#tTakeOutTotalNum').val(),
                            $('#hReMainTotalNum').val())
                    }),
                    dataType: "json",
                    url: ESTATEurl.TakeOutData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#ESTATETakeOutTemp'));
                        ESTATETempGrid();
                        ESTATEDayGrid();
                    }
                });
            }
        }

        function ESTATETempCompleteFun(listId){
            jqgridCustom.randerAction(listId, 'ESTATETemp', tempActFun);
        }

        var tempActFun = {};
        tempActFun.Edit = function(i)
        {
            dialogOpen('@Ref.ActionType.Edit.ToString()', i);
        }
        tempActFun.Dele = function(i)
        {
            dialogOpen('@Ref.ActionType.Dele.ToString()', i);
        }
        tempActFun.View = function(i)
        {
            dialogOpen('@Ref.ActionType.View.ToString()', i);
        }

        //#region function
        function ESTATEInsertFun() {

            dialogOpen('@Ref.ActionType.Add.ToString()', null);
        }

        function dialogOpen(type, rowid)
        {
            $('#' + ESTATEFormId).validate().resetForm();
            var dialogId = 'BillInsertDialog';
            var listId = 'ESTATETempList';
            var ESTATEInsertClass = 'ESTATEInsertType';
            var title = '';
            $('#ESTATEInsertTemp,#ESTATEUpdateTemp,#ESTATEDeleteTemp').hide();
            if (type == '@Ref.ActionType.Add.ToString()')
            {
                ResetInsertDialog();
                $('#ESTATEInsertTemp').show();
                title = '@Ref.ActionType.Add.GetDescription()';
                $('.' + ESTATEInsertClass).prop('disabled', false);
            }
            else if (type == '@Ref.ActionType.Dele.ToString()')
            {
                dialogSetData(listId, rowid);
                $('#ESTATEDeleteTemp').show();
                title = '@Ref.ActionType.Dele.GetDescription()';
                $('.' + ESTATEInsertClass).prop('disabled', true);
            }
            else if (type == '@Ref.ActionType.Edit.ToString()')
            {
                dialogSetData(listId, rowid);
                $('#ESTATEUpdateTemp').show();
                title = '@Ref.ActionType.Edit.GetDescription()';
                $('.' + ESTATEInsertClass).prop('disabled', false);
            }
            else if (type == '@Ref.ActionType.View.ToString()')
            {
                dialogSetData(listId, rowid);
                title = '@Ref.ActionType.View.GetDescription()';
                $('.' + ESTATEInsertClass).prop('disabled', true);
            }
            $('#' + dialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: title + '空白票券',
                width: 'auto',
                autoOpen: false,
                resizable: false,
                closeText: '取消',
            });
            $('#' + dialogId).dialog('open');
        }

        function ResetInsertDialog() {
            if ($('#' + ESTATE_Check_TypeId + ' option').length > 0)
            {
                $('#' + ESTATE_Check_TypeId).val($($('#' + ESTATE_Check_TypeId + ' option')[0]).val())               
            }
            if ($('#sESTATE_Issuing_Bank option').length > 0) {
                $('#sESTATE_Issuing_Bank').val($($('#sESTATE_Issuing_Bank option')[0]).val())
            }          
            $('#' + ESTATE_AplyNoId).val('');
            $('#' + ESTATE_DataSeqId).val('');
            $('#' + ESTATE_ItemId).val('');
            $('#' + ESTATE_Issuing_BankId).val('');
            $('#' + ESTATE_Check_No_TrackId).val('');
            $('#' + ESTATE_Check_No_BId).val('');
            $('#' + ESTATE_Check_No_EId).val('');
            $('#' + ESTATE_totalId).html('');
        }

        function dialogSetData(listId, rowid) {
            listId = listId || '';
            rowid = rowid || 0;
            ResetInsertDialog();
            if (rowid > 0) {
                var data = $("#" + listId).getRowData(rowid);
                //set value
                $('#' + ESTATE_AplyNoId).val(data.vAplyNo);
                $('#' + ESTATE_DataSeqId).val(data.vDataSeq);
                $('#' + ESTATE_ItemId).val(data.vItemId);
                $('#' + ESTATE_Check_TypeId).val(data.vCheckType.split(' ')[0]);
                $('#' + ESTATE_Issuing_BankId).val(data.vIssuingBank);
                $('#' + ESTATE_Check_No_TrackId).val(data.vCheckNoTrack);
                $('#' + ESTATE_Check_No_BId).val(data.vCheckNoB);
                $('#' + ESTATE_Check_No_EId).val(data.vCheckNoE);
                $('#' + ESTATE_totalId).html(data.vCheckTotalNum);
            }
        }

        //新增暫存空白票據明細
        function ESTATEInsertTempFun() {
            if ($('#' + ESTATEFormId).valid())
            {
                var _Check_No_B = parseInt($('#' + ESTATE_Check_No_BId).val());
                var _Check_No_E = parseInt($('#' + ESTATE_Check_No_EId).val());
                if(_Check_No_B > _Check_No_E)
                {
                    customerUtility.alert('迄號不可小於起號!', 'w');
                    return false;
                }
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: BillViewModel(
                            created.uuid(),
                            $('#' + ESTATE_AplyNoId).val(),
                            $('#' + ESTATE_DataSeqId).val(),
                            $('#' + ESTATE_Issuing_BankId).val(),
                            $('#' + ESTATE_Check_TypeId).val(),
                            $('#' + ESTATE_Check_No_TrackId).val(),
                            $('#' + ESTATE_Check_No_BId).val(),
                            $('#' + ESTATE_Check_No_EId).val(),
                            $('#' + ESTATE_totalId).html())
                    }),
                    dataType: "json",
                    url: ESTATEurl.InsertTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG)
                    {
                        customerUtility.closeDialog($('#ESTATEInsertTemp'));
                        ESTATETempGrid();
                        ESTATEDayGrid();
                    }
                })
            }
        }

        function ESTATEUpdateTempFun()
        {
            if ($('#' + ESTATEFormId).valid()) {
                var _Check_No_B = parseInt($('#' + ESTATE_Check_No_BId).val());
                var _Check_No_E = parseInt($('#' + ESTATE_Check_No_EId).val());
                if (_Check_No_B > _Check_No_E) {
                    customerUtility.alert('迄號不可小於起號!', 'w');
                    return false;
                }
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: BillViewModel(
                            $('#' + ESTATE_ItemId).val(),
                            $('#' + ESTATE_AplyNoId).val(),
                            $('#' + ESTATE_DataSeqId).val(),
                            $('#' + ESTATE_Issuing_BankId).val(),
                            $('#' + ESTATE_Check_TypeId).val(),
                            $('#' + ESTATE_Check_No_TrackId).val(),
                            $('#' + ESTATE_Check_No_BId).val(),
                            $('#' + ESTATE_Check_No_EId).val(),
                            $('#' + ESTATE_totalId).html())
                    }),
                    dataType: "json",
                    url: ESTATEurl.UpdateTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#ESTATEUpdateTemp'));
                        ESTATETempGrid();
                        ESTATEDayGrid();
                    }
                })
            }
        }

        function ESTATEDeleteTempFun() {
            if ($('#' + ESTATEFormId).valid()) {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: BillViewModel(
                            $('#' + ESTATE_ItemId).val())
                    }),
                    dataType: "json",
                    url: ESTATEurl.DeleteTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#ESTATEDeleteTemp'));
                        ESTATETempGrid();
                        ESTATEDayGrid();
                    }
                })
            }
        }

        function BillViewModel(
            vItemId,
            vAplyNo,
            vDataSeq,
            vIssuingBank,
            vCheckType,
            vCheckNoTrack,
            vCheckNoB,
            vCheckNoE,
            vCheckTotalNum,
            vTakeOutE,
            vTakeOutTotalNum,
            vReMainTotalNum
            ) {
            var obj = {};
            obj['vItemId'] = vItemId;
            obj['vAplyNo'] = vAplyNo;
            obj['vDataSeq'] = vDataSeq;
            obj['vIssuingBank'] = vIssuingBank;
            obj['vCheckType'] = vCheckType;
            obj['vCheckNoTrack'] = vCheckNoTrack;
            obj['vCheckNoB'] = vCheckNoB;
            obj['vCheckNoE'] = vCheckNoE;
            obj['vCheckTotalNum'] = vCheckTotalNum;
            obj['vTakeOutE'] = vTakeOutE;
            obj['vTakeOutTotalNum'] = vTakeOutTotalNum;
            obj['vReMainTotalNum'] = vReMainTotalNum;
            return obj;
        }


        //#endregion

        function getPage(id)
        {
            return $('#' + id).find('.ui-pg-input').val();
        }
    });
</script>