@using Treasury.Web.Enum;
@using Treasury.WebUtility;
<div class="row">
    <div style="padding-bottom:5px;">
        <input type="button" id="MarginpInsert" value="新增存入明細" class="btn btn-primary" style="display:none" />
    </div>
    <div id="MarginpjqgridDiv" class="jqd" style="padding-bottom:5px;">


    </div>
    <div style="text-align:center;display:none;" class="Marginp_Act">
        <input type="button" id="MarginpApply" value="申請覆核" class="btn btn-primary" />
        <input type="button" id="MarginpCancel" value="取消申請" class="btn btn-primary" />
        <input type="button" id="MarginpBack" value="回上一頁" class="btn btn-primary" />
    </div>

    <div id="MarginpDialog" style="display:none">
        <form id="MarginpDialogForm">
            <table>
                <tr>
                    <td>
                        <label>類別 : </label>
                    </td>
                    <td>
                        @Html.DropDownList("dMarginp_Take_Of_Type", (SelectList)ViewBag.MarginpType, new { @class = "MarginpInsertType", @style = "width:207px" })
                        @*<input type="text" id="tMarginp_Take_Of_Type" name="tMarginp_Take_Of_Type" class="MarginpInsertType" maxlength="10" />*@
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>交易對象 : </label>
                    </td>
                    <td>
                        <input type="text" id="tMarginp_Trad_Partners" name="tMarginp_Trad_Partners" class="MarginpInsertType" maxlength="30" />
                    </td>
                </tr>
                <tr style="display:none">
                    <td>
                        <label>歸檔編號 : </label>
                    </td>
                    <td>
                        <input type="text" id="tMarginp_Item_ID" name="tMarginp_Item_ID" class="MarginpInsertType" maxlength="30" />
                        @*<input type="hidden" id="hMarginp_ITEM_ID" name="hMarginp_ITEM_ID" class="MarginpInsertType"/>*@
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>金額 : </label>
                    </td>
                    <td>
                        <input type="text" id="tMarginp_Amount" name="tMarginp_Amount" class="MarginpInsertType" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>物品名稱 : </label>
                    </td>
                    <td>
                       @Html.DropDownList("dMarginp_Item", (SelectList)ViewBag.MarginpItem, new { @class = "MarginpInsertType", @style = "width:207px" })
                       @*<select id="tMarginp_Item" name="tMarginp_Item" class="MarginpInsertType" maxlength="10" />*@
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>物品發行人 : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Item_Issuer" name="tMarginp_Item_Issuer" class="MarginpInsertType" maxlength="10" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>質押標的號碼 : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Pledge_Item_No" name="tMarginp_Pledge_Item_No" class="MarginpInsertType" maxlength="16" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>有效期間(起) : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Effective_Date_B" name="tMarginp_Effective_Date_B" class="MarginpInsertType" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input type="hidden" id="tMarginp_Effective_Date_B_2" name="tMarginp_Effective_Date_B_2" class="MarginpInsertType" />
                        </td>
                    </tr>      
                    <tr>
                        <td>
                            <label>有效期間(迄) : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Effective_Date_E" name="tMarginp_Effective_Date_E" class="MarginpInsertType" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input type="hidden" id="tMarginp_Effective_Date_E_2" name="tMarginp_Effective_Date_E_2" class="MarginpInsertType" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>說明 : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Description" name="tMarginp_Description" class="MarginpInsertType" maxlength="20" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>備註 : </label>
                        </td>
                        <td>
                            <textarea id="tMarginp_Memo" name="tMarginp_Memo" class="MarginpInsertType" style="width:207px;" maxlength="30" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>冊號 : </label>
                        </td>
                        <td>
                            <input type="text" id="tMarginp_Book_No" name="tMarginp_Book_No" class="MarginpInsertType" maxlength="2" />
                        </td>
                    </tr>
                    @*<tr>
                        <td colspan="2">
                            <input type="hidden" id="hMarginp_ITEM_ID" />
                        </td>
                    </tr>*@
                    <tr>
                        <td>
                            <input type="button" id="MarginpInsertTemp" value="新增" class="btn btn-primary" />
                            <input type="button" id="MarginpUpdateTemp" value="修改" class="btn btn-primary" />
                            <input type="button" id="MarginpDeleteTemp" value="刪除" class="btn btn-primary" />
                        </td>
                        <td style="text-align:right;">
                            <input type="button" id="MarginpCancelTemp" value="取消" class="btn btn-primary" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <script>
        $(function () {
            //#region url設定                     
            var Marginpurl = {};
            Marginpurl.getData = '@Url.Action("GetCacheData", "Marginp")';
            Marginpurl.InsertTempData = '@Url.Action("InsertTempData", "Marginp")';
            Marginpurl.UpdateTempData = '@Url.Action("UpdateTempData", "Marginp")';
            Marginpurl.DeleteTempData = '@Url.Action("DeleteTempData", "Marginp")';
            Marginpurl.ResetTempData = '@Url.Action("ResetTempData", "Marginp")';
            Marginpurl.TakeOutData = '@Url.Action("TakeOutData", "Marginp")';
            Marginpurl.ApplyTempData = '@Url.Action("ApplyTempData", "Marginp")';

            Marginpurl.GetMarginpItem = '@Url.Action("GetMarginpItem", "Marginp")';
            //#endregion

            //#region 參數設定

            //庫存資料
            var MarginpDialogId = 'MarginpDialog'; //dialogId
            var MarginpDialogFormId = 'MarginpDialogForm'; //dialogFormId
            var MarginpConfirmFlag = false; //離開時的提醒訊息
            var Marginp_Take_Of_Type = 'dMarginp_Take_Of_Type'; //類別Id(dropdownlist)
            var Marginp_Trad_Partners = 'tMarginp_Trad_Partners'; //交易對象Id(text)
            var Marginp_Item_ID = 'tMarginp_Item_ID'; //歸檔編號Id(hidden)
            var Marginp_Amount = 'tMarginp_Amount'; //金額Id(text)
            var Marginp_Item = 'dMarginp_Item'; //物品名稱(dropdownlsit)
            var Marginp_Item_Issuer = 'tMarginp_Item_Issuer'; //物品發行人Id(text)
            var Marginp_Pledge_Item_No = 'tMarginp_Pledge_Item_No'; //質押標的號碼Id(text)
            var Marginp_Effective_Date_B = 'tMarginp_Effective_Date_B'; //有效期間(起)Id(text)
            var Marginp_Effective_Date_B_2 = 'tMarginp_Effective_Date_B_2'; //有效期間(起)西元年Id(hidden)
            var Marginp_Effective_Date_E = 'tMarginp_Effective_Date_E'; //有效期間(迄)Id(text)
            var Marginp_Effective_Date_E_2 = 'tMarginp_Effective_Date_E_2'; //有效期間(迄)西元年Id(hidden)
            var Marginp_Description = 'tMarginp_Description'; //說明Id(text)
            var Marginp_Memo = 'tMarginp_Memo'; //備註Id(textarea)
            var Marginp_Book_No = 'tMarginp_Book_No'; //冊號Id(text)
            var Marginp_Expected_Date_1 = 'Marginp_Expected_Date_1'; //有效期間(起)日期西元年(hidden)
            var Marginp_Expected_Date_2 = 'Marginp_Expected_Date_2'; //有效期間(迄)日期西元年(hidden)
            //var Marginp_Item_IdHlId = 'hMarginp_ITEM_ID'; //物品編號Id(hidden)

            var Marginp_Act_Type = 'True' == '@ViewBag.dActType'; //覆核狀態
            var type = $('input[name=cProjectType]:checked').val(); //存入 or 取出
            var Marginp_Aply_No_Flag = $('#TAR_AplyNo').val() != ''; //有單號(true)為查詢畫面之修改,(false)為新增
            if (Marginp_Aply_No_Flag) {
                $('#MarginpCancel').hide(); //已經申請故無法取消申請
                type = '@ViewBag.dAccess';
            }

            if (!Marginp_Act_Type) { //不是覆核狀態 (為使用單號查詢資料)
                $('.Marginp_Act').hide();
                type = '@ViewBag.dAccess';
            }
            else { //是覆核狀態 (為存入 or 取出 動作)
                $('.Marginp_Act').show();
            }
            var typeFlag = (type == '@Ref.AccessProjectTradeType.P.ToString()'); //存入為 True 取出 為 False
            if (typeFlag && Marginp_Act_Type) {
                $('#MarginpInsert').show();
            }
            //#endregion

            function clearJqgrid(gridDivId) {
                $('#' + gridDivId).children().remove();
            }

            //#region 初始動作
            MarginpTempGrid();
            setMarginpVerified();
            //#endregion
            //created.createDatepicker(Marginp_Effective_Date_B_2, '');
            //created.createDatepicker(Marginp_Effective_Date_E_2, '');
            created.createDatepickerRange(Marginp_Effective_Date_B, Marginp_Effective_Date_E);
            $('#' + Marginp_Effective_Date_B).datepicker('option', 'onSelect', function () {
                var _date = $('#' + Marginp_Effective_Date_B).val();
                //有效期間(迄) 	支票：有效期間(起)+1年
                if ($('#dMarginp_Item').val() == '1' && verified.isDate(_date)) {
                    $('#' + Marginp_Effective_Date_E).datepicker("option", "minDate", _date);
                    _date = Number(_date.split('/')[0]) + 1 + '/' + _date.split('/')[1] + '/' + _date.split('/')[2];
                    $('#' + Marginp_Effective_Date_E).val(_date);
                }
                //有效期間(迄) 	本票：有效期間(起)+3年
                else if ($('#dMarginp_Item').val() == '2' && verified.isDate(_date))
                {
                    $('#' + Marginp_Effective_Date_E).datepicker("option", "minDate", _date);
                    _date = Number(_date.split('/')[0]) + 3 + '/' + _date.split('/')[1] + '/' + _date.split('/')[2];
                    $('#' + Marginp_Effective_Date_E).val(_date);
                }
                else if (verified.isDate(_date))
                {
                    $('#' + Marginp_Effective_Date_E).datepicker("option", "minDate", _date);
                }
            })
            //#region 註冊verified
            function setMarginpVerified() {
                //verified.datepicker(MarginpDialogFormId, Marginp_Effective_Date_B_2, $('#' + Marginp_Effective_Date_B_2).val());
                //verified.datepicker(MarginpDialogFormId, Marginp_Effective_Date_E_2, $('#' + Marginp_Effective_Date_E_2).val());
                verified.required(MarginpDialogFormId, Marginp_Take_Of_Type, message.required('類別')); //類別為必填
                verified.required(MarginpDialogFormId, Marginp_Trad_Partners, message.required('交易對象')); //交易對象為必填
                verified.required(MarginpDialogFormId, Marginp_Amount, message.required('金額')); //金額為必填
                verified.price(MarginpDialogFormId, Marginp_Amount); //金額驗證
                verified.required(MarginpDialogFormId, Marginp_Item, message.required('物品名稱')); //物品名稱為必填
                verified.required(MarginpDialogFormId, Marginp_Item_Issuer, message.required('物品發行人')); //物品發行人為必填
                verified.required(MarginpDialogFormId, Marginp_Pledge_Item_No, message.required('質押標的號碼')); //質押標的號碼為必填
                verified.number(MarginpDialogFormId, Marginp_Book_No); //冊號為數字              
            }
            //#endregion

            //#region 註冊事件
            $('input:button').each(function () {
                var id = $(this).attr('id');
                switch (id) {
                    case 'MarginpInsert':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () { MarginpInsertFun(); });
                        break;
                    case 'MarginpApply':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () { MarginpApplyFun(); });
                        break;
                    case 'MarginpCancel':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () {
                            if (MarginpConfirmFlag && !confirm('@Ref.MessageType.application_Audit_Confirm.GetDescription()')) {
                                return false;
                            }
                            MarginpCancelFun();
                        });
                        break;
                    case 'MarginpBack':
                    case 'MarginpCancelTemp':
                        $('#' + id).off('click');
                        $('#' + id).on('click',
                        function () {
                            if (id == 'MarginpBack' &&
                                MarginpConfirmFlag &&
                                !confirm('@Ref.MessageType.application_Audit_Confirm.GetDescription()')) {
                                return false;
                            }
                            customerUtility.closeDialog(this);
                        });
                        break;
                    case 'MarginpInsertTemp':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () { MarginpInsertTempFun(); });
                        break;
                    case 'MarginpUpdateTemp':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () { MarginpUpdateTempFun(); });
                        break;
                    case 'MarginpDeleteTemp':
                        $('#' + id).off('click');
                        $('#' + id).on('click', function () { MarginpDeleteTempFun(); });
                        break;
                }
            });

            $('#dMarginp_Take_Of_Type').on('change', function () {
                GetMarginpItem($(this).val())
            });

            function GetMarginpItem(MARGIN_ITEM) {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        MARGIN_ITEM: MARGIN_ITEM
                    }),
                    dataType: "json",
                    url: Marginpurl.GetMarginpItem,
                    contentType: 'application/json'
                }).done(function (result) {
                    customerUtility.addoption('dMarginp_Item', result);
                })

            }

            function MarginpReset() {
                $('#' + Marginp_LocatedTId).val('');
                $('#' + Marginp_MemoTId).val('');
            }

            function MarginpApplyFun() {
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: Marginpurl.ApplyTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#MarginpApply'));
                    }
                })
            }

            function MarginpCancelFun() {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        AccessType: type
                    }),
                    dataType: "json",
                    url: Marginpurl.ResetTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    ResetInsertDialog();
                    MarginpTempGrid();
                    MarginpConfirmFlag = true;
                })
            }

            function formatterTakeOut(cellvalue, options, rdata) {
            var str = "<div class='checkbox checkbox-info' title=' ' style='padding-top: 0px; margin-top: 0px; margin-bottom: 0px;'><input type='checkbox' id='" + options.gid + options.colModel.index + options.rowId + "' ' tage='" + options.colModel.index + "' name='" +
                    options.gid + options.colModel.index + options.rowId + "' title =' ' " + (cellvalue == true ? 'checked' : ' ') + " class='cbox Marginptakeouts customerCheck'></div>";
            return str;
        }

            function formatterMarginp_Take_Of_Type(cellvalue, options, rdata) {
            switch (cellvalue) {
                @{
                    foreach (var item in ((SelectList)ViewBag.MarginpType))
                    {
                    <text>
                    case '@item.Value':
                        return '@item.Text';
                    </text>
                    }
                }
                default:
                    return '';
            }
        }

            function UnformatterMarginp_Take_Of_Type(cellvalue, options, rdata) {
            switch (cellvalue) {
                @{
                    foreach (var item in ((SelectList)ViewBag.MarginpType))
                    {
                        <text>
                        case '@item.Text':
                        return '@item.Value';
                        </text>
                    }
                }
                default:
        return '';
        }
        }

            function formatterMarginp_Item(cellvalue, options, rdata) {
            switch (cellvalue) {
                @{
                    foreach (var item in ((SelectList)ViewBag.MarginpItem))
                    {
                        <text>
                        case '@item.Value':
                              return '@item.Text';
                        </text>
                    }
                }
                default:
                   return '';
            }
            return '';
        }

            function UnformatterMarginp_Item(cellvalue, options, rdata) {
            switch (cellvalue) {
               @{
                    foreach (var item in ((SelectList)ViewBag.MarginpItem))
                    {
                        <text>
                        case '@item.Text':
                        return '@item.Value';
                        </text>
                    }
                }
                default:
            return '';
            }
        return '';
        }

        function MarginpTempGrid() {

            if (typeFlag) { //存入
                var colNameArray = ['動作', '類別', '交易對象', '金額', '物品名稱', '物品發行人', '質押標的號碼', '有效期間(起)', '有效期間(迄)', '說明', '備註', '冊號', '有效期間(起)日期西元年', '有效期間(迄)日期西元年','item_id'];
                var colModelArray = [];
                colModelArray.push({ name: "act", index: "act", width: 90, sortable: false });
                colModelArray.push({ name: "vMarginp_Take_Of_Type", index: "vMarginp_Take_Of_Type", width: 100, sortable: false, formatter: formatterMarginp_Take_Of_Type, unformat: UnformatterMarginp_Take_Of_Type });
                colModelArray.push({ name: "vMarginp_Trad_Partners", index: "vMarginp_Trad_Partners", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Amount", index: "vMarginp_Amount", width: 100, sortable: false, formatter: customerUtility.addCommas, unformat: customerUtility.removeCommas });
                colModelArray.push({ name: "vMarginp_Item", index: "vMarginp_Item", width: 100, sortable: false, formatter: formatterMarginp_Item, unformat: UnformatterMarginp_Item});
                colModelArray.push({ name: "vMarginp_Item_Issuer", index: "vMarginp_Item_Issuer", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Pledge_Item_No", index: "vMarginp_Pledge_Item_No", width: 110, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_B_2", index: "vMarginp_Effective_Date_B_2", width: 110, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_E_2", index: "vMarginp_Effective_Date_E_2", width: 110, sortable: false });
                colModelArray.push({ name: "vDescription", index: "vDescription", width: 100, sortable: false });
                colModelArray.push({ name: "vMemo", index: "vMemo", width: 150, sortable: false });
                colModelArray.push({ name: "vMarginp_Book_No", index: "vMarginp_Book_No", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_B", index: "vMarginp_Effective_Date_B", hidden: true });
                colModelArray.push({ name: "vMarginp_Effective_Date_E", index: "vMarginp_Effective_Date_E", hidden: true });
                colModelArray.push({ name: "vItemId", index: "vItemId", sortable: false, hidden: true });
                jqgridCustom.createJqgridByCache(
                    'MarginpjqgridDiv',
                    'MarginpTempList',
                    'MarginpTempPeger',
                    Marginpurl.getData,
                    {

                    },
                    colNameArray,
                    colModelArray,
                    '存入明細資料',
                    jqgridCustom.getPage('MarginpjqgridDiv'),
                    MarginpTempCompleteFun,
                    true
                    );
            }
            else { //取出
                var colNameArray = ['取出', '動作', '類別', '交易對象', '金額', '物品名稱', '物品發行人', '質押標的號碼', '有效期間(起)', '有效期間(迄)', '說明', '備註', '冊號', '有效期間(起)日期西元年', '有效期間(迄)日期西元年', 'item_id'];

                var colModelArray = [];

                if (!Marginp_Act_Type) {
                    colModelArray.push({ name: "vtakeoutFlag", index: "vtakeoutFlag", sortable: false, align: 'center', formatter: formatterTakeOut, hidden: true });
                    colModelArray.push({ name: "act", index: "act", width: 90, sortable: false });
                }
                else {
                    colModelArray.push({ name: "vtakeoutFlag", index: "vtakeoutFlag", width: 45, sortable: false, align: 'center', formatter: formatterTakeOut });
                    colModelArray.push({ name: "act", index: "act", width: 45, sortable: false });
                }
                colModelArray.push({ name: "vMarginp_Take_Of_Type", index: "vMarginp_Take_Of_Type", width: 100, sortable: false, formatter: formatterMarginp_Take_Of_Type, unformat: UnformatterMarginp_Take_Of_Type });
                colModelArray.push({ name: "vMarginp_Trad_Partners", index: "vMarginp_Trad_Partners", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Amount", index: "vMarginp_Amount", width: 100, sortable: false, formatter: customerUtility.addCommas, unformat: customerUtility.removeCommas });
                colModelArray.push({ name: "vMarginp_Item", index: "vMarginp_Item", width: 100, sortable: false, formatter: formatterMarginp_Item, unformat: UnformatterMarginp_Item });
                colModelArray.push({ name: "vMarginp_Item_Issuer", index: "vMarginp_Item_Issuer", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Pledge_Item_No", index: "vMarginp_Pledge_Item_No", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_B_2", index: "vMarginp_Effective_Date_B_2", width: 100, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_E_2", index: "vMarginp_Effective_Date_E_2", width: 100, sortable: false });
                colModelArray.push({ name: "vDescription", index: "vDescription", width: 100, sortable: false });
                colModelArray.push({ name: "vMemo", index: "vMemo", width: 270, sortable: false });
                colModelArray.push({ name: "vMarginp_Book_No", index: "vMarginp_Book_No", width: 150, sortable: false });
                colModelArray.push({ name: "vMarginp_Effective_Date_B", index: "vMarginp_Effective_Date_B", hidden: true });
                colModelArray.push({ name: "vMarginp_Effective_Date_E", index: "vMarginp_Effective_Date_E", hidden: true });
                colModelArray.push({ name: "vItemId", index: "vItemId", width: 100, sortable: false , hidden:true});
                jqgridCustom.createJqgridByCache(
                    'MarginpjqgridDiv',
                    'MarginpTempList',
                    'MarginpTempPeger',
                    Marginpurl.getData,
                    {
                    },
                    colNameArray,
                    colModelArray,
                    '取出明細資料',
                    jqgridCustom.getPage('MarginpjqgridDiv'),
                    MarginpTempTakeOutFun,
                    true
                    );
            }
        }

        function MarginpTempTakeOutFun(listId) {
            jqgridCustom.randerAction(listId, 'MarginpTemp', tempActFun);
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                $(this).find('.actionEditIcon').hide();
                $(this).find('.actionDeleIcon').hide();
                $(this).find('td').find('.Marginptakeouts').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        takeout(i + 1, $(this).prop('checked'));
                        

                    });
                });
            });
        }

        function takeout(rowid, flag) {
            var listId = 'MarginpTempList';
            var data = $("#" + listId).getRowData(rowid);
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: MarginpViewModel(data.vItemId),
                    takeoutFlag: flag
                }),
                dataType: "json",
                url: Marginpurl.TakeOutData,
                contentType: 'application/json',
            }).done(function (result) {
                if (result.RETURN_FLAG) {
                    MarginpTempGrid();
                    if (Marginp_Aply_No_Flag) //從查詢畫面進來的
                    {
                        MarginpConfirmFlag = true;
                    }
                    else //新增存入畫面
                    {
                        MarginpConfirmFlag = result.Datas;
                    }
                }
            });
        }

        function MarginpTempCompleteFun(listId) {
            jqgridCustom.randerAction(listId, 'MarginpTemp', tempActFun);
            if (!Marginp_Act_Type) { //申請狀態
                $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                    $(this).find('.actionEditIcon').hide();
                    $(this).find('.actionDeleIcon').hide();
                });
            }
        }

        var tempActFun = {};
        tempActFun.Edit = function (i) {
            dialogOpen('@Ref.ActionType.Edit.ToString()', i);
        }
        tempActFun.Dele = function (i) {
            dialogOpen('@Ref.ActionType.Dele.ToString()', i);
        }
        tempActFun.View = function (i) {
            dialogOpen('@Ref.ActionType.View.ToString()', i);
        }

        //#region function
        function MarginpInsertFun() {

            dialogOpen('@Ref.ActionType.Add.ToString()', null);
            
        }

        function dialogOpen(type, rowid) {
            $('#' + MarginpDialogFormId).validate().resetForm();
            var dialogId = 'MarginpDialog';
            var listId = 'MarginpTempList';
            var MarginpInsertClass = 'MarginpInsertType';
            var title = customerUtility.getDialogType(type);;
            $('#' + dialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: title + '存入保證金',
                width: 'auto',
                autoOpen: false,
                resizable: false,
                closeText: '取消',
                close: function (event, ui) {
                    customerUtility.closeDialog(this);
                }
            });
            $('#MarginpInsertTemp,#MarginpUpdateTemp,#MarginpDeleteTemp').hide();
            if (type == '@Ref.ActionType.Add.ToString()') {
                ResetInsertDialog();
                $('#MarginpInsertTemp').show();
                $('#' + Marginp_Effective_Date_B).next().prop('disabled', false);
                $('#' + Marginp_Effective_Date_E).next().prop('disabled', false);
                $('.' + MarginpInsertClass).prop('disabled', false);
                if ('@ViewBag.CustodianFlag' != "True") {
                    $('#' + Marginp_Memo).prop('disabled', true);
                }               
            }
            else if (type == '@Ref.ActionType.Dele.ToString()') {
                dialogSetData(listId, rowid);
                $('#' + Marginp_Effective_Date_B).next().prop('disabled', true);
                $('#' + Marginp_Effective_Date_E).next().prop('disabled', true);
                $('#MarginpDeleteTemp').show();
                $('.' + MarginpInsertClass).prop('disabled', true);
            }
            else if (type == '@Ref.ActionType.Edit.ToString()') {
                dialogSetData(listId, rowid);
                $('#' + Marginp_Effective_Date_B).next().prop('disabled', false);
                $('#' + Marginp_Effective_Date_E).next().prop('disabled', false);
                $('#MarginpUpdateTemp').show();
                $('.' + MarginpInsertClass).prop('disabled', false);
                if ('@ViewBag.CustodianFlag' != "True") {
                    $('#' + Marginp_Memo).prop('disabled', true);
                }
            }
            else if (type == '@Ref.ActionType.View.ToString()') {
                dialogSetData(listId, rowid);
                $('#' + Marginp_Effective_Date_B).next().prop('disabled', true);
                $('#' + Marginp_Effective_Date_E).next().prop('disabled', true);
                $('.' + MarginpInsertClass).prop('disabled', true);
            }
            $('#' + dialogId).dialog('open');
        }

            function ResetInsertDialog() {
            created.clearDatepickerRangeValue(Marginp_Effective_Date_B, Marginp_Effective_Date_E);
            if ($('#' + Marginp_Take_Of_Type + ' option').length > 0) {
                $('#' + Marginp_Take_Of_Type).val($($('#' + Marginp_Take_Of_Type + ' option')[0]).val()).change()
            }
            //$('#' + Marginp_Take_Of_Type).val('');
            $('#' + Marginp_Trad_Partners).val('');
            $('#' + Marginp_Amount).val('');
            $('#' + Marginp_Item_ID).val('');
            if ($('#' + Marginp_Item + ' option').length > 0) {
                $('#' + Marginp_Item).val($($('#' + Marginp_Item + ' option')[0]).val())
            }
           // $('#' + Marginp_Item_Name).val('');
            $('#' + Marginp_Item_Issuer).val('');
            $('#' + Marginp_Pledge_Item_No).val('');
            $('#' + Marginp_Effective_Date_B).val('');
            $('#' + Marginp_Effective_Date_B_2).val('');
            $('#' + Marginp_Effective_Date_E).val('');
            $('#' + Marginp_Effective_Date_E_2).val('');
            $('#' + Marginp_Description).val('');
            $('#' + Marginp_Memo).val('');
            $('#' + Marginp_Book_No).val('');
            $('#' + Marginp_Expected_Date_1).val('');
            $('#' + Marginp_Expected_Date_2).val('');

            //$('#' + Marginp_Item_IdHlId).val('');
        }

        function dialogSetData(listId, rowid) {
            listId = listId || '';
            rowid = rowid || 0;
            ResetInsertDialog();
            if (rowid > 0) {
                var data = $("#" + listId).getRowData(rowid);
                //set value
                setTimeout(
                function () {
                    $.when(
                          $('#' + Marginp_Take_Of_Type).val(data.vMarginp_Take_Of_Type).change()
                        )
                    .done(function () {
                        if ($('#' + Marginp_Item + ' option').length > 0) {
                            $('#' + Marginp_Item).val(data.vMarginp_Item);
                        }
                    })
                }, 100);
                //$('#' + Marginp_Take_Of_Type).val(data.vMarginp_Take_Of_Type);
                $('#' + Marginp_Trad_Partners).val(data.vMarginp_Trad_Partners);
                $('#' + Marginp_Amount).val(data.vMarginp_Amount);
                $('#' + Marginp_Item_ID).val(data.vItemId);
                //$('#' + Marginp_Item).val(data.vMarginp_Item);
                $('#' + Marginp_Item_Issuer).val(data.vMarginp_Item_Issuer);
                $('#' + Marginp_Pledge_Item_No).val(data.vMarginp_Pledge_Item_No);
                $('#' + Marginp_Effective_Date_B).val(data.vMarginp_Effective_Date_B);
                $('#' + Marginp_Effective_Date_B).datepicker("option", 'maxDate', data.vMarginp_Effective_Date_E);
                $('#' + Marginp_Effective_Date_B_2).val(data.vMarginp_Effective_Date_B_2);
                $('#' + Marginp_Effective_Date_E).datepicker("option", 'minDate', data.vMarginp_Effective_Date_B);
                $('#' + Marginp_Effective_Date_E).val(data.vMarginp_Effective_Date_E);
                $('#' + Marginp_Effective_Date_E_2).val(data.vMarginp_Effective_Date_E_2);
                $('#' + Marginp_Description).val(data.vDescription);
                $('#' + Marginp_Memo).val(data.vMemo);
                $('#' + Marginp_Book_No).val(data.vMarginp_Book_No);
                //$('#' + Marginp_Item_IdHlId).val(data.vItemId);
            }
        }



        //新增暫存存入保證金明細
        function MarginpInsertTempFun() {
            if ($('#' + Marginp_Effective_Date_B).val().trim() != '' && !verified.isDate($('#' + Marginp_Effective_Date_B).val().trim())) {
                customerUtility.alert('有效期間(起)格式不為yyyy/MM/dd', 'w');
                return false;
            }
            if ($('#' + Marginp_Effective_Date_E).val().trim() != '' && !verified.isDate($('#' + Marginp_Effective_Date_E).val().trim())) {
                customerUtility.alert('有效期間(迄)格式不為yyyy/MM/dd', 'w');
                return false;
            }
            if ($('#' + MarginpDialogFormId).valid()) {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: MarginpViewModel(
                            created.uuid(),
                            $('#' + Marginp_Take_Of_Type).val().trim(),
                            $('#' + Marginp_Trad_Partners).val().trim(),
                            $('#' + Marginp_Amount).val().trim(),
                            $('#' + Marginp_Item).val().trim(),
                            $('#' + Marginp_Item_Issuer).val().trim(),
                            $('#' + Marginp_Pledge_Item_No).val().trim(),
                            $('#' + Marginp_Effective_Date_B).val(),
                            $('#' + Marginp_Effective_Date_B_2).val().trim(),
                            $('#' + Marginp_Effective_Date_E).val(),
                            $('#' + Marginp_Effective_Date_E_2).val().trim(),
                            $('#' + Marginp_Description).val().trim(),
                            $('#' + Marginp_Memo).val().trim(),
                            $('#' + Marginp_Book_No).val().trim())

                    }),
                    dataType: "json",
                    url: Marginpurl.InsertTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#MarginpInsertTemp'));
                        MarginpTempGrid();
                        MarginpConfirmFlag = true;
                    }
                })
            }
        }

        function MarginpUpdateTempFun() {
            if ($('#' + Marginp_Effective_Date_B).val().trim() != '' && !verified.isDate($('#' + Marginp_Effective_Date_B).val().trim())) {
                customerUtility.alert('有效期間(起)格式不為yyyy/MM/dd', 'w');
                return false;
            }
            if ($('#' + Marginp_Effective_Date_E).val().trim() != '' && !verified.isDate($('#' + Marginp_Effective_Date_E).val().trim())) {
                customerUtility.alert('有效期間(迄)格式不為yyyy/MM/dd', 'w');
                return false;
            }
            if ($('#' + MarginpDialogFormId).valid()) {
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: MarginpViewModel(
                            $('#' + Marginp_Item_ID).val().trim(),
                            $('#' + Marginp_Take_Of_Type).val().trim(),
                            $('#' + Marginp_Trad_Partners).val().trim(),
                            $('#' + Marginp_Amount).val().trim(),
                            $('#' + Marginp_Item).val().trim(),
                            $('#' + Marginp_Item_Issuer).val().trim(),
                            $('#' + Marginp_Pledge_Item_No).val().trim(),
                            $('#' + Marginp_Effective_Date_B).val(),
                            $('#' + Marginp_Effective_Date_B_2).val().trim(),
                            $('#' + Marginp_Effective_Date_E).val(),
                            $('#' + Marginp_Effective_Date_E_2).val().trim(),
                            $('#' + Marginp_Description).val().trim(),
                            $('#' + Marginp_Memo).val().trim(),
                            $('#' + Marginp_Book_No).val().trim())
                    }),
                    dataType: "json",
                    url: Marginpurl.UpdateTempData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#MarginpUpdateTemp'));
                        MarginpTempGrid();
                        MarginpConfirmFlag = true;
                    }
                })
            }
        }

        function MarginpDeleteTempFun() {
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    model: MarginpViewModel(
                         $('#' + Marginp_Item_ID).val().trim())
                }),
                dataType: "json",
                url: Marginpurl.DeleteTempData,
                contentType: 'application/json',
            }).done(function (result) {
                customerUtility.alertAuto(result);
                if (result.RETURN_FLAG) {
                    customerUtility.closeDialog($('#MarginpDeleteTemp'));
                    MarginpTempGrid();
                    if (Marginp_Aply_No_Flag)
                    {
                        MarginpConfirmFlag = true;
                    }
                    else
                    {
                        MarginpConfirmFlag = result.Datas;
                    }
                }
            })
        }

        function MarginpViewModel(
            vItemId,
            vMarginp_Take_Of_Type,
            vMarginp_Trad_Partners,
            vMarginp_Amount,
            vMarginp_Item,
            vMarginp_Item_Issuer,
            vMarginp_Pledge_Item_No,
            vMarginp_Effective_Date_B,
            vMarginp_Effective_Date_B_2,
            vMarginp_Effective_Date_E,
            vMarginp_Effective_Date_E_2,
            vDescription,
            vMemo,
            vMarginp_Book_No
            ) {
            var obj = {};
            obj['vItemId'] = vItemId;
            obj['vMarginp_Take_Of_Type'] = vMarginp_Take_Of_Type;
            obj['vMarginp_Trad_Partners'] = vMarginp_Trad_Partners;
            obj['vMarginp_Amount'] = vMarginp_Amount;
            obj['vMarginp_Item'] = vMarginp_Item;
            obj['vMarginp_Item_Issuer'] = vMarginp_Item_Issuer;
            obj['vMarginp_Pledge_Item_No'] = vMarginp_Pledge_Item_No;
            obj['vMarginp_Effective_Date_B'] = vMarginp_Effective_Date_B;
            obj['vMarginp_Effective_Date_B_2'] = vMarginp_Effective_Date_B_2;
            obj['vMarginp_Effective_Date_E'] = vMarginp_Effective_Date_E;
            obj['vMarginp_Effective_Date_E_2'] = vMarginp_Effective_Date_E_2;
            obj['vDescription'] = vDescription;
            obj['vMemo'] = vMemo;
            obj['vMarginp_Book_No'] = vMarginp_Book_No;
            return obj;
        }

        //#endregion
    });
</script>