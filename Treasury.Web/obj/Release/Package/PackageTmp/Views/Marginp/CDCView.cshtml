@using Treasury.Web.Enum;
@using Treasury.WebUtility;
<div>
    <div id="CDCMarginpjqgridDiv" class="jqd" style="padding-bottom:5px;">

    </div>
    <div style="text-align:center;display:none;" class="CDCMarginp_Act">
        <input type="button" id="CDCMarginpApply" value="申請覆核" class="btn btn-primary" />
        <input type="button" id="CDCMarginpBack" value="回上一頁" class="btn btn-primary" />
    </div>
    <div id="CDCMarginpDialog" style="display:none;">
        <form id="CDCMarginpDialogForm">
            <table>
                <tr>
                    <td>
                        <label>入庫日期 : </label>
                    </td>
                    <td>
                        <label id="vPUT_DATE" name="vPUT_DATE"></label>
                    </td>
                </tr>
                <tr class="GetClass">
                    <td>
                        <label>取出日期 : </label>
                    </td>
                    <td>
                        <label id="vGet_Date" name="vGet_Date"></label>
                    </td>
                </tr>
                <tr class="GetClass">
                    <td>
                        <label>取出申請人 : </label>
                    </td>
                    <td>
                        <label id="vGet_Uid_Name" name="vGet_Uid_Name"></label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>冊號 : </label>
                    </td>
                    <td>
                        @*<label id="vBook_No" name="vBook_No"></label>*@
                        <input type="text" class="CDCMarginpUpdateType" id="vBook_No" name="vBook_No" />
                        <span class="red" style="padding-left:20px" id="sBook_No"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>存入申請人 : </label>
                    </td>
                    <td>
                        <label id="vAPLY_UID_Name" name="vAPLY_UID_Name"></label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>權責單位 : </label>
                    </td>
                    <td>
                        <label id="vCHARGE_Name" name="vCHARGE_Name"></label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>類別 : </label>
                    </td>
                    <td>
                        @Html.DropDownList("dMargin_Take_Of_Type", (SelectList)ViewBag.dMargin_Take_Of_Type, new { disabled = "disabled" @*@class = "CDCMarginpUpdateType"*@ })
                        <span class="red" style="padding-left:20px" id="sCDCMargin_Take_Of_Type"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>交易對象 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCTrad_Partners" name="tCDCTrad_Partners" maxlength="30" />
                        <span class="red" style="padding-left:20px" id="sCDCTrad_Partners"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>歸檔編號 : </label>
                    </td>
                    <td>
                        <label id="vlItem_Id"></label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>金額 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCAmount" name="tCDCAmount" />
                        <span class="red" style="padding-left:20px" id="sCDCAmount"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>物品名稱 : </label>
                    </td>
                    <td>
                        @Html.DropDownList("dMargin_Item", (SelectList)ViewBag.dMargin_Item, new { @class = "CDCMarginpUpdateType" })
                        <span class="red" style="padding-left:20px" id="sCDCMargin_Item"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>物品發行人 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCMargin_Item_Issuer" name="tCDCMargin_Item_Issuer" maxlength="10" />
                        <span class="red" style="padding-left:20px" id="sCDCMargin_Item_Issuer"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>質押標的號碼 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCPledge_Item_No" name="tCDCPledge_Item_No" maxlength="16" />
                        <span class="red" style="padding-left:20px" id="sCDCPledge_Item_No"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>有效期間(起) : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCEffective_Date_B" name="tCDCEffective_Date_B" />
                        <span class="red" style="padding-left:20px" id="sCDCEffective_Date_B"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>有效期間(迄) : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCEffective_Date_E" name="tCDCEffective_Date_E" />
                        <span class="red" style="padding-left:20px" id="sCDCEffective_Date_E"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>說明 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCDescription" name="tCDCDescription" maxlength="100" />
                        <span class="red" style="padding-left:20px" id="sCDCDescription"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>備註 : </label>
                    </td>
                    <td>
                        <input type="text" class="CDCMarginpUpdateType" id="tCDCMemo" name="tCDCMemo" maxlength="200" />
                        <span class="red" style="padding-left:20px" id="sCDCMemo"></span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="hidden" id="hItem_Id" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><span class="red">* 紅色的字代表修改後的參數</span></td>
                </tr>
                <tr>
                    <td colspan="2"><span class="red">* @Ref.MessageType.null_Input.GetDescription()</span></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="button" id="CDCMarginpUpdateTemp" value="修改" class="btn btn-primary" />
                    </td>
                    <td colspan="2" style="text-align:right;">
                        <input type="button" id="CDCMarginpCancelTemp" value="取消" class="btn btn-primary" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<script>
    $(function () {
        //#region url設定
        var CDCMarginpUrl = {};
        CDCMarginpUrl.getData = '@Url.Action("GetCDCCacheData", "Marginp")';
        CDCMarginpUrl.UpdateDbData = '@Url.Action("UpdateDbData", "Marginp")';
        CDCMarginpUrl.ApplyDbData = '@Url.Action("ApplyDbData", "Marginp")';
        CDCMarginpUrl.RepeatDbData = '@Url.Action("RepeatDbData", "Marginp")';
        CDCMarginpUrl.GetMarginpItem = '@Url.Action("GetMarginpItem", "Marginp")';
        //#endregion url設定

        //#region 參數設定
        var CDCMarginpDialogId = 'CDCMarginpDialog'; //dialogId
        var CDCMarginpFormId = 'CDCMarginpDialogForm'; //formId
        var vPut_DateId = 'vPUT_DATE'; //入庫日期Id(label)
        var vGet_DateId = 'vGet_Date';//取出日期Id
        var vGet_Uid_NameId = 'vGet_Uid_Name';//取出申請人Id
        var vBook_NoId = 'vBook_No'; //冊號Id(text)
        var sBook_NoId = 'sBook_No'; //冊號Id(span)
        var vAply_Uid_NameId = 'vAPLY_UID_Name'; //存入申請人Id(label)
        var vCharge_NameId = 'vCHARGE_Name' //權責單位Id(label)
        var dMargin_Take_Of_TypeId = 'dMargin_Take_Of_Type'; //類別Id(dropdownlist)
        var sCDCMargin_Take_Of_TypeId = 'sCDCMargin_Take_Of_Type'; //類別Id(span)
        var tCDCTrad_PartnersId = 'tCDCTrad_Partners'; //交易對象Id(text)
        var sCDCTrad_PartnersId = 'sCDCTrad_Partners'; //交易對象Id(span)
        var vlItem_Id = 'vlItem_Id'; //歸檔編號Id(label)
        var tCDCAmountId = 'tCDCAmount'; //金額Id(text)
        var sCDCAmountId = 'sCDCAmount'; //金額Id(span)
        var dMargin_ItemId = 'dMargin_Item'; //物品名稱Id(text)
        var sCDCMargin_ItemId = 'sCDCMargin_Item'; //物品名稱Id(span)
        var tCDCMargin_Item_IssuerId = 'tCDCMargin_Item_Issuer'; //物品發行人Id(text)
        var sCDCMargin_Item_IssuerId = 'sCDCMargin_Item_Issuer'; //物品發行人Id(span)
        var tCDCPledge_Item_NoId = 'tCDCPledge_Item_No'; //質押標的號碼Id(text)
        var sCDCPledge_Item_NoId = 'sCDCPledge_Item_No'; //質押標的號碼Id(span)
        var tCDCEffective_Date_BId = 'tCDCEffective_Date_B'; //有效期間(起)Id(text)
        var sCDCEffective_Date_BId = 'sCDCEffective_Date_B'; //有效期間(起)Id(span)
        var tCDCEffective_Date_EId = 'tCDCEffective_Date_E'; //有效期間(迄)Id(text)
        var sCDCEffective_Date_EId = 'sCDCEffective_Date_E'; //有效期間(迄)Id(span)
        var tCDCDescriptionId = 'tCDCDescription'; //說明Id(text)
        var sCDCDescriptionId = 'sCDCDescription'; //說明Id(span)
        var tCDCMemoId = 'tCDCMemo'; //備註Id(text)
        var sCDCMemoId = 'sCDCMemo'; //備註Id(span)
        var hCDCItem_Id = 'hItem_Id'; //物品單號(hidden)

        var GetFlag = $('#treasuryIO').val() == "N"; //取出案例

        var CDCMarginp_Act_Type = 'CDCIndex' == '@ViewBag.type';
        if (CDCMarginp_Act_Type)
            $('.CDCMarginp_Act').show(); //申請異動主畫面進來

        var CDCMarginp_ApplyFlag = 'Y' == '@ViewBag.IO';
        if (!CDCMarginp_ApplyFlag)
            $('#CDCMarginpApply').hide();

        var CDCMarginpConfirmFlag = false; //離開時提醒訊息

        //#endregion 參數設定
        
        //#region 初始動作
        CDCMarginpDbGrid();
        setCDCMarginpVerified();
        //#endregion 初始動作
        created.createDatepickerRange(tCDCEffective_Date_BId, tCDCEffective_Date_EId);

        //#region 註冊verified
        function setCDCMarginpVerified() {
            verified.required(CDCMarginpFormId, dMargin_Take_Of_TypeId, message.required('類別')); //類別為必填
            verified.required(CDCMarginpFormId, tCDCTrad_PartnersId, message.required('交易對象')); //交易對象為必填
            verified.required(CDCMarginpFormId, tCDCAmountId, message.required('金額')); //金額為必填
            verified.required(CDCMarginpFormId, vBook_NoId, message.required('冊號')); //冊號為必填
            verified.number(CDCMarginpFormId, vBook_NoId); // 僅能輸入數字(正)
            verified.price(CDCMarginpFormId, tCDCAmountId); //金額驗證
            verified.required(CDCMarginpFormId, dMargin_ItemId, message.required('物品名稱')); //物品名稱為必填
            verified.required(CDCMarginpFormId, tCDCMargin_Item_IssuerId, message.required('物品發行人')); //物品發行人為必填
            verified.required(CDCMarginpFormId, tCDCPledge_Item_NoId, message.required('質押標的號碼')); //質押標的號碼為必填
            verified.required(CDCMarginpFormId, tCDCEffective_Date_BId, message.required('有效期間(起)')); //有效期間(起)為必填
            verified.required(CDCMarginpFormId, tCDCEffective_Date_EId, message.required('有效期間(迄)')); //有效期間(迄)為必填
        }
        //#endregion 註冊verified

        //#region 註冊事件
        //按鈕
        $('input:button').each(function () {
            var id = $(this).attr('id');
            switch (id) {
                case 'CDCMarginpApply':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { CDCMarginpApplyFun(); });
                    break;
                case 'CDCMarginpBack':
                case 'CDCMarginpCancelTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click',
                        function () {
                            if (id == 'CDCMarginpBack' &&
                                CDCMarginpConfirmFlag &&
                                !confirm('@Ref.MessageType.application_Audit_Confirm.GetDescription()')) {
                                return false;
                            }
                            customerUtility.closeDialog(this);
                        });
                    break;
                case 'CDCMarginpUpdateTemp':
                    $('#' + id).off('click');
                    $('#' + id).on('click', function () { CDCMarginpUpdateTempFun(); });
                    break;
            }
        });
        $('#dMargin_Take_Of_Type').on('change', function () {
            GetMarginpItem($(this).val())
        });

        function GetMarginpItem(MARGIN_ITEM) {
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    MARGIN_ITEM: MARGIN_ITEM
                }),
                dataType: "json",
                url: CDCMarginpUrl.GetMarginpItem,
                contentType: 'application/json'
            }).done(function (result) {
                customerUtility.addoption('dMargin_Item', result);
            })

        }

        //申請覆核
        function CDCMarginpApplyFun() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: CDCMarginpUrl.ApplyDbData,
                contentType: 'application/json',
            }).done(function (result) {
                customerUtility.alertAuto(result);
                if (result.RETURN_FLAG) {
                    customerUtility.closeDialog($('#CDCMarginpApply'));
                }
            })
        }
        //#endregion 註冊事件

        //#region 初始設定

        //#endregion 初始設定

        //#region function

        function unformatterCheckItem(cellvalue, options, rdata) {
            return cellvalue;
        }

        function formatterTakeOut(cellvalue, options, rdata) {
            var str = "<div class='checkbox checkbox-info' title=' ' style='padding-top: 0px; margin-top: 0px; margin-bottom: 0px;'><input type='checkbox' id='" + options.gid + options.colModel.index + options.rowId + "' ' tage='" + options.colModel.index + "' name='" +
                    options.gid + options.colModel.index + options.rowId + "' title =' ' " + (cellvalue == true ? 'checked' : ' ') + " class='cbox MarginpTakeOuts customerCheck'></div>";
            return str;
        }

        function formattervStatus(cellvalue, options, rdata) {
            switch (rdata.vStatus) {
                @{
                    foreach (var item in ((List<SelectOption>)ViewBag.Sataus))
                    {
                <text>
                case '@item.Value':
                    return '@item.Text';
                    </text>
                    }
        }
                default:
                    return '';
            }
        }

        function formattervMargin_Take_Of_Type(cellvalue, options, rdata) {
            if (rdata.vMargin_Take_Of_Type_AFT != null) {
                switch (rdata.vMargin_Take_Of_Type_AFT) {
                    @{
                         foreach (var item in ((SelectList)ViewBag.dMargin_Take_Of_Type))
                         {
                             <text>
                    case '@item.Value':
                        return '<span class="red">' + '@item.Text' + '</span>';
                        </text>
                         }
                     }
                }
            } else {
                switch (rdata.vMargin_Take_Of_Type) {
                    @{
                        foreach (var item in ((SelectList)ViewBag.dMargin_Take_Of_Type))
                        {
                            <text>
                    case '@item.Value':
                        return '@item.Text';
                        </text>
                        }
                    }
                }
            }
            return '';
        }

        function unformattervMargin_Take_Of_Type(cellvalue, options, rdata) {
            return rdata.vMargin_Take_Of_Type;
        }

        function formattervTrad_Partners(cellvalue, options, rdata) {
            if (rdata.vTrad_Partners_AFT == null)
                return rdata.vTrad_Partners || '';
            else if (rdata.vTrad_Partners_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vTrad_Partners_AFT + '</span>';
        }

        function formattervAmount(cellvalue, options, rdata) {
            if (rdata.vAmount_AFT != null)
                return '<span class="red">' + customerUtility.addCommas(rdata.vAmount_AFT) + '</span>';
            else
                return customerUtility.addCommas(rdata.vAmount) || '';
        }

        function formattervMargin_Item(cellvalue, options, rdata) {
            if (rdata.vMargin_Item_AFT != null) {
                switch (rdata.vMargin_Item_AFT) {
                    @{
                         foreach (var item in ((SelectList)ViewBag.dMargin_Item))
                         {
                             <text>
                    case '@item.Value':
                        return '<span class="red">' + '@item.Text' + '</span>';
                        </text>
                         }
                     }
                }
            } else {
                switch (rdata.vMargin_Item) {
                    @{
                        foreach (var item in ((SelectList)ViewBag.dMargin_Item))
                        {
                            <text>
                    case '@item.Value':
                        return '@item.Text';
                        </text>
                        }
                    }
                }
            }
            return '';
        }

        function unformattervMargin_Item(cellvalue, options, rdata) {
            return rdata.vMargin_Item;
        }

        function formattervMargin_Item_Issuer(cellvalue, options, rdata) {
            if (rdata.vMargin_Item_Issuer_AFT == null)
                return rdata.vMargin_Item_Issuer || '';
            else if (rdata.vMargin_Item_Issuer_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vMargin_Item_Issuer_AFT + '</span>';
        }

        function formattervPledge_Item_No(cellvalue, options, rdata) {
            if (rdata.vPledge_Item_No_AFT == null)
                return rdata.vPledge_Item_No || '';
            else if (rdata.vPledge_Item_No_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vPledge_Item_No_AFT + '</span>';
        }

        function formattervEffective_Date_B(cellvalue, options, rdata) {
            if (rdata.vEffective_Date_B_AFT == null || rdata.vEffective_Date_B_AFT == '')
                return rdata.vEffective_Date_B || '';
            else
                return '<span class="red">' + rdata.vEffective_Date_B_AFT + '</span>';
        }

        function formattervEffective_Date_E(cellvalue, options, rdata) {
            if (rdata.vEffective_Date_E_AFT == null || rdata.vEffective_Date_E_AFT == '')
                return rdata.vEffective_Date_E || '';
            else
                return '<span class="red">' + rdata.vEffective_Date_E_AFT + '</span>';
        }

        function formattervDescription(cellvalue, options, rdata) {
            if (rdata.vDescription_AFT == null)
                return rdata.vDescription || '';
            else if (rdata.vDescription_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vDescription_AFT + '</span>';
        }

        function formattervMemo(cellvalue, options, rdata) {
            if (rdata.vMemo_AFT == null)
                return rdata.vMemo || '';
            else if (rdata.vMemo_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vMemo_AFT + '</span>';
        }

        function formattervBook_No(cellvalue, options, rdata) {
            if (rdata.vBook_No_AFT == null)
                return rdata.vBook_No || '';
            else if (rdata.vBook_No_AFT.toUpperCase() == 'NULL')
                return '';
            else
                return '<span class="red">' + rdata.vBook_No_AFT + '</span>';
        }

        function formattervCharge_Name(cellvalue, options, rdata) {
            if (rdata.vCharge_Name_AFT != null) {
                return customerUtility.errorSpan(rdata.vCharge_Name_AFT);
            }
            else {
                return rdata.vCharge_Name;
            }
        }

        function formatterAct(cellvalue, options, rdata) {
            var str = '';
            str += '<div class="btn-group">';
            str += '<a title="修改" class="btn actionEditIcon" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="CDCMarginp' + options.gid + 'Update' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-pencil-square-o fa-lg"></i></a>';
            str += '<a title="檢視" class="btn actionViewIcon" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="CDCMarginp' + options.gid + 'Search' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-search fa-lg"></i></a>';
            str += '<a title="重設" class="btn actionRepeatIcon" style="padding-right:4px;padding-left:4px;padding-bottom:0px;padding-top:0px;" href="#" id="CDCMarginp' + options.gid + 'Repeat' + options.rowId + '" return:false;="">';
            str += '<i class="fa fa-repeat fa-lg"></i></a>';
            str += '</div>';
            return str;
        }

        function CDCMarginpDbGrid() {
            var colNameArray = ['動作', '狀態', '入庫日期'];
            if (GetFlag) {
                colNameArray = colNameArray.concat(['取出日期', '取出申請人']);
            }
            colNameArray = colNameArray.concat(['冊號', '存入申請人', '權責單位',
                '類別', '交易對象', '歸檔編號', '金額', '物品名稱', '物品發行人', '質押標的號碼', '有效期間(起)', '有效期間(迄)', '說明', '備註',
                '類別異動前', '交易對象異動前', '金額異動前', '物品名稱異動前', '物品發行人異動前', '質押標的號碼異動前', '有效期間(起)異動前', '有效期間(迄)異動前', '說明異動前', '備註異動前', '冊號異動前', '權責單位異動前',
                '類別異動後', '交易對象異動後', '金額異動後', '物品名稱異動後', '物品發行人異動後', '質押標的號碼異動後', '有效期間(起)異動後', '有效期間(迄)異動後', '說明異動後', '備註異動後', '冊號異動後', '權責單位異動後',
                '物品單號', '狀態Id']);
            var colModelArray = [];
            colModelArray.push({ name: "act", index: "act", width: 90, sortable: false, formatter: formatterAct });
            colModelArray.push({ name: "vStatusShow", index: "vStatusShow", width: 90, formatter: formattervStatus, align: 'center' });
            colModelArray.push({ name: "vPut_Date", index: "vPut_Date", width: 100, sortable: false, align: 'center' });
            if (GetFlag) {
                colModelArray.push({ name: "vGet_Date", index: "vGet_Date", width: 90, align: 'center', sortable: false });
                colModelArray.push({ name: "vGet_Uid_Name", index: "vGet_Uid_Name", width: 100, align: 'center', sortable: false });
            }
            colModelArray.push({ name: "vBook_No_Show", index: "vBook_No_Show", width: 60, align: 'center', sortable: false, formatter: formattervBook_No });
            colModelArray.push({ name: "vAply_Uid_Name", index: "vAply_Uid_Name", width: 80, sortable: false, align: 'center' });
            colModelArray.push({ name: "vCharge_Name_Show", index: "vCharge_Name_Show", width: 200, sortable: false, align: 'center', formatter: formattervCharge_Name });

            colModelArray.push({ name: "vMargin_Take_Of_Type_Show", index: "vMargin_Take_Of_Type_Show", width: 70, align: 'center', sortable: false, formatter: formattervMargin_Take_Of_Type, unformatter: unformattervMargin_Take_Of_Type });
            colModelArray.push({ name: "vTrad_Partners_Show", index: "vTrad_Partners_Show", width: 100, align: 'center', sortable: false, formatter: formattervTrad_Partners });
            colModelArray.push({ name: "vlItem_Id", index: "vlItem_Id", width: 100, align: 'center', sortable: false });
            colModelArray.push({ name: "vAmount_Show", index: "vAmount_Show", width: 90, align: 'right', sortable: false, formatter: formattervAmount });
            colModelArray.push({ name: "vMargin_Item_Show", index: "vMargin_Item_Show", align: 'center', width: 120, sortable: false, formatter: formattervMargin_Item, unformatter: unformattervMargin_Item });
            colModelArray.push({ name: "vMargin_Item_Issuer_Show", index: "vMargin_Item_Issuer_Show", align: 'center', width: 100, sortable: false, formatter: formattervMargin_Item_Issuer });
            colModelArray.push({ name: "vPledge_Item_No_Show", index: "vPledge_Item_No_Show", width: 100, align: 'center', sortable: false, formatter: formattervPledge_Item_No });
            colModelArray.push({ name: "vEffective_Date_B_Show", index: "vEffective_Date_B_Show", width: 100, align: 'center', sortable: false, formatter: formattervEffective_Date_B });
            colModelArray.push({ name: "vEffective_Date_E_Show", index: "vEffective_Date_E_Show", width: 100, align: 'center', sortable: false, formatter: formattervEffective_Date_E });
            colModelArray.push({ name: "vDescription_Show", index: "vDescription_Show", width: 100, align: 'center', sortable: false, formatter: formattervDescription });
            colModelArray.push({ name: "vMemo_Show", index: "vMemo_Show", width: 100, align: 'center', sortable: false, formatter: formattervMemo });

            colModelArray.push({ name: "vMargin_Take_Of_Type", index: "vMargin_Take_Of_Type", hidden: true });
            colModelArray.push({ name: "vTrad_Partners", index: "vTrad_Partners", hidden: true });
            colModelArray.push({ name: "vAmount", index: "vAmount", hidden: true });
            colModelArray.push({ name: "vMargin_Item", index: "vMargin_Item", hidden: true });
            colModelArray.push({ name: "vMargin_Item_Issuer", index: "vMargin_Item_Issuer", hidden: true });
            colModelArray.push({ name: "vPledge_Item_No", index: "vPledge_Item_No", hidden: true });
            colModelArray.push({ name: "vEffective_Date_B", index: "vEffective_Date_B", hidden: true });
            colModelArray.push({ name: "vEffective_Date_E", index: "vEffective_Date_E", hidden: true });
            colModelArray.push({ name: "vDescription", index: "vDescription", hidden: true });
            colModelArray.push({ name: "vMemo", index: "vMemo", hidden: true });
            colModelArray.push({ name: "vBook_No", index: "vBook_No", hidden: true });
            colModelArray.push({ name: "vCharge_Name", index: "vCharge_Name", hidden: true });

            colModelArray.push({ name: "vMargin_Take_Of_Type_AFT", index: "vMargin_Take_Of_Type_AFT", hidden: true });
            colModelArray.push({ name: "vTrad_Partners_AFT", index: "vTrad_Partners_AFT", hidden: true });
            colModelArray.push({ name: "vAmount_AFT", index: "vAmount_AFT", hidden: true });
            colModelArray.push({ name: "vMargin_Item_AFT", index: "vMargin_Item_AFT", hidden: true });
            colModelArray.push({ name: "vMargin_Item_Issuer_AFT", index: "vMargin_Item_Issuer_AFT", hidden: true });
            colModelArray.push({ name: "vPledge_Item_No_AFT", index: "vPledge_Item_No_AFT", hidden: true });
            colModelArray.push({ name: "vEffective_Date_B_AFT", index: "vEffective_Date_B_AFT", hidden: true });
            colModelArray.push({ name: "vEffective_Date_E_AFT", index: "vEffective_Date_E_AFT", hidden: true });
            colModelArray.push({ name: "vDescription_AFT", index: "vDescription_AFT", hidden: true });
            colModelArray.push({ name: "vMemo_AFT", index: "vMemo_AFT", hidden: true });
            colModelArray.push({ name: "vBook_No_AFT", index: "vBook_No_AFT", hidden: true });
            colModelArray.push({ name: "vCharge_Name_AFT", index: "vCharge_Name_AFT", hidden: true });

            colModelArray.push({ name: "vItem_Id", index: "vItem_Id", hidden: true });
            colModelArray.push({ name: "vStatus", index: "vStatus", hidden: true });
            jqgridCustom.createJqgridByCache(
                'CDCMarginpjqgridDiv',
                'CDCMarginpTempList',
                'CDCMarginpTempPeger',
                CDCMarginpUrl.getData,
                {

                },
                colNameArray,
                colModelArray,
                '查詢資料',
                jqgridCustom.getPage('CDCMarginpjqgridDiv'),
                CDCMarginpTempCompleteFun,
                true
                );
        }

        function CDCMarginpTempCompleteFun(listId) {
            $('#' + listId + ' > tbody > tr:gt(0) ').each(function (i, j) {
                var tr = $(this);
                tr.find('td').find('a.actionEditIcon').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        dialogOpen('@Ref.ActionType.Edit.ToString()', i + 1);
                    });
                });
                tr.find('td').find('a.actionViewIcon').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        dialogOpen('@Ref.ActionType.View.ToString()', i + 1);
                    });
                });
                tr.find('td').find('a.actionRepeatIcon').each(function () {
                    $(this).off('click');
                    $(this).on('click', function () {
                        CDCMarginpRepeat(listId, i + 1);
                    });
                });
                var status = tr.find($.validator.format('td[aria-describedby$={0}_vStatus]', listId)).text();
                if (status != '1') {
                    $(this).find('.actionEditIcon').hide();
                    $(this).find('.actionRepeatIcon').hide();
                }
            });
        }

        function CDCMarginpRepeat(listId, rowid) {
            var itemId = $("#" + listId).getRowData(rowid).vItem_Id;
            $.ajax({
                type: "POST",
                data: JSON.stringify({
                    itemId: itemId
                }),
                dataType: "json",
                url: CDCMarginpUrl.RepeatDbData,
                contentType: 'application/json',
            }).done(function (result) {
                if (result.RETURN_FLAG) {
                    CDCMarginpDbGrid();
                    CDCMarginpConfirmFlag = result.Datas;
                }
                else {

                }
            })
        }

        //#region dialog
        function dialogOpen(type, rowid) {
            $('#' + CDCMarginpDialogId).validate().resetForm();
            var listId = 'CDCMarginpTempList';
            var MarginpUpdateClass = 'CDCMarginpUpdateType';
            var title = customerUtility.getDialogType(type);;
            $('#' + CDCMarginpDialogId).dialog({
                position: { my: "top+30%", at: "center top", of: window },
                title: title + '存入保證金',
                width: 'auto',
                autoOpen: false,
                resizable: false,
                closeText: '取消',
                close: function (event, ui) {
                    customerUtility.closeDialog(this);
                }
            });       
            $('#CDCMarginpUpdateTemp').hide();
            $('.GetClass').hide();
            if (type == '@Ref.ActionType.Add.ToString()') {
            }
            else if (type == '@Ref.ActionType.Dele.ToString()') {
            }
            else if (type == '@Ref.ActionType.Edit.ToString()') {      
                $('.' + MarginpUpdateClass).prop('disabled', false);
                dialogSetData(listId, rowid);
                $('#CDCMarginpUpdateTemp').show();
                $('#' + tCDCEffective_Date_BId).next().prop('disabled', false);
                $('#' + tCDCEffective_Date_EId).next().prop('disabled', true);
            }
            else if (type == '@Ref.ActionType.View.ToString()') {
                if (GetFlag) {
                    $('.GetClass').show();
                }
                dialogSetData(listId, rowid);
                $('.' + MarginpUpdateClass).prop('disabled', true);
                $('#' + tCDCEffective_Date_BId).next().prop('disabled', true);
                $('#' + tCDCEffective_Date_EId).next().prop('disabled', true);
            }
            $('#' + CDCMarginpDialogId).dialog('open');
        }

        function ResetDialog() {
            created.clearDatepickerRangeValue(tCDCEffective_Date_BId, tCDCEffective_Date_EId);
            $('#' + vPut_DateId).text('');
            $('#' + vGet_DateId).text('');
            $('#' + vGet_Uid_NameId).text('');
            $('#' + vBook_NoId).text('');
            $('#' + sBook_NoId).val('');
            $('#' + vAply_Uid_NameId).text('');
            $('#' + vCharge_NameId).text('');
            if ($('#' + dMargin_Take_Of_TypeId + ' option').length > 0) {
                $('#' + dMargin_Take_Of_TypeId).val($($('#' + dMargin_Take_Of_TypeId + ' option')[0]).val()).change()
            }
            if ($('#' + sCDCMargin_Take_Of_TypeId + ' option').length > 0) {
                $('#' + sCDCMargin_Take_Of_TypeId).text($($('#' + sCDCMargin_Take_Of_TypeId + ' option')[0]).text()).change()
            }
            $('#' + tCDCTrad_PartnersId).val('');
            $('#' + sCDCTrad_PartnersId).text('');
            $('#' + vlItem_Id).text('');
            $('#' + tCDCAmountId).val('');
            $('#' + sCDCAmountId).text('');
            $('#' + dMargin_ItemId).val('');
            $('#' + sCDCMargin_ItemId).text('');
            $('#' + tCDCMargin_Item_IssuerId).val('');
            $('#' + sCDCMargin_Item_IssuerId).text('');
            $('#' + tCDCPledge_Item_NoId).val('');
            $('#' + sCDCPledge_Item_NoId).text('');
            $('#' + tCDCEffective_Date_BId).val('');
            $('#' + sCDCEffective_Date_BId).text('');
            $('#' + tCDCEffective_Date_EId).val('');
            $('#' + sCDCEffective_Date_EId).text('');
            $('#' + tCDCDescriptionId).val('');
            $('#' + sCDCDescriptionId).text('');
            $('#' + tCDCMemoId).val('');
            $('#' + sCDCMemoId).text('');
            $('#' + hCDCItem_Id).val('');
        }

        function dialogSetData(listId, rowid) {
            listId = listId || '';
            rowid = rowid || 0;
            ResetDialog();
            if (rowid > 0) {
                var data = $("#" + listId).getRowData(rowid);
           
                //set value
                $('#' + vPut_DateId).text(data.vPut_Date);
                if (GetFlag) {
                    $('#' + vGet_DateId).text(data.vGet_Date);
                    $('#' + vGet_Uid_NameId).text(data.vGet_Uid_Name);
                }
                $('#' + vBook_NoId).val(data.vBook_No);
                $('#' + sBook_NoId).text(data.vBook_No_AFT);
                $('#' + vAply_Uid_NameId).text(data.vAply_Uid_Name);
                $('#' + vCharge_NameId).text(data.vCharge_Name);
                $.when($('#' + dMargin_Take_Of_TypeId).val(data.vMargin_Take_Of_Type.split('-')[0]).change())
                .done(function (MARGIN_ITEM) { setTimeout(function () { $('#' + dMargin_ItemId).val(data.vMargin_Item) }, 1000) })
                $('#' + sCDCMargin_Take_Of_TypeId).text(data.vMargin_Take_Of_Type_AFT);
                $('#' + tCDCTrad_PartnersId).val(data.vTrad_Partners);
                $('#' + sCDCTrad_PartnersId).text(data.vTrad_Partners_AFT);
                $('#' + vlItem_Id).text(data.vlItem_Id);
                $('#' + tCDCAmountId).val(data.vAmount);
                $('#' + sCDCAmountId).text(data.vAmount_AFT);
                $('#' + sCDCMargin_ItemId).text(data.vMargin_Item_AFT);
                $('#' + tCDCMargin_Item_IssuerId).val(data.vMargin_Item_Issuer);
                $('#' + sCDCMargin_Item_IssuerId).text(data.vMargin_Item_Issuer_AFT);
                $('#' + tCDCPledge_Item_NoId).val(data.vPledge_Item_No);
                $('#' + sCDCPledge_Item_NoId).text(data.vPledge_Item_No_AFT);
                $('#' + tCDCEffective_Date_BId).val(data.vEffective_Date_B);
                $('#' + sCDCEffective_Date_BId).text(data.vEffective_Date_B_AFT);
                var _date = $('#' + tCDCEffective_Date_BId).val();
                
                //有效期間(迄) 	支票：有效期間(起)+1年
                if (data.vMargin_Item == '1' && verified.isDate(_date)) {
                    _date = Number(_date.split('/')[0]) + 1 + '/' + _date.split('/')[1] + '/' + _date.split('/')[2];
                    $('#' + tCDCEffective_Date_EId).val(_date);
                    $('#' + tCDCEffective_Date_EId).prop('disabled', true);
                }
                else if (data.vMargin_Item == '2' && verified.isDate(_date)) {
                    _date = Number(_date.split('/')[0]) + 3 + '/' + _date.split('/')[1] + '/' + _date.split('/')[2];
                    $('#' + tCDCEffective_Date_EId).val(_date);
                    $('#' + tCDCEffective_Date_EId).prop('disabled', true);
                }
                else {
                    $('#' + tCDCEffective_Date_EId).val(data.vEffective_Date_E);
                }
                $('#' + sCDCEffective_Date_EId).text(data.vEffective_Date_E_AFT);
                $('#' + tCDCDescriptionId).val(data.vDescription);
                $('#' + sCDCDescriptionId).text(data.vDescription_AFT);
                $('#' + tCDCMemoId).val(data.vMemo);
                $('#' + sCDCMemoId).text(data.vMemo_AFT);
                $('#' + hCDCItem_Id).val(data.vItem_Id);
            }
        }

        //修改存入保證金暫存資料
        function CDCMarginpUpdateTempFun() {
            if ($('#' + CDCMarginpFormId).valid()) {
                if ($('#' + tCDCTrad_PartnersId).val().trim().toUpperCase() == 'NULL')
                {
                    customerUtility.alert('交易對象不可為空值', 'w');
                    return
                }
                else if ($('#' + tCDCMargin_Item_IssuerId).val().trim().toUpperCase() == 'NULL')
                {
                    customerUtility.alert('物品發行人不可為空值', 'w');
                    return
                }
                else if ($('#' + tCDCPledge_Item_NoId).val().trim().toUpperCase() == 'NULL')
                {
                    customerUtility.alert('質押標的號碼不可為空值', 'w');
                    return
                }
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({
                        model: CDCMarginpViewModel(
                            $('#' + hCDCItem_Id).val(),
                            $('#' + dMargin_Take_Of_TypeId).val().trim(),
                            $('#' + tCDCTrad_PartnersId).val().trim(),
                            $('#' + tCDCAmountId).val().trim(),
                            $('#' + dMargin_ItemId).val().trim(),
                            $('#' + tCDCMargin_Item_IssuerId).val().trim(),
                            $('#' + tCDCPledge_Item_NoId).val().trim(),
                            $('#' + tCDCEffective_Date_BId).val().trim(),
                            $('#' + tCDCEffective_Date_EId).val().trim(),
                            $('#' + tCDCDescriptionId).val().trim(),
                            $('#' + tCDCMemoId).val().trim(),
                            $('#' + vBook_NoId).val().trim()),

                    }),
                    dataType: "json",
                    url: CDCMarginpUrl.UpdateDbData,
                    contentType: 'application/json',
                }).done(function (result) {
                    customerUtility.alertAuto(result);
                    if (result.RETURN_FLAG) {
                        customerUtility.closeDialog($('#CDCMarginpUpdateTemp'));
                        CDCMarginpDbGrid();
                        CDCMarginpConfirmFlag = result.Datas;
                    }
                })
            }
        }

        //#endregion dialog

        //#region jqgrid

        //#endregion jqgrid

        function CDCMarginpViewModel(
            vItem_Id,
            vMargin_Take_Of_Type,
            vTrad_Partners,
            vAmount,
            vMargin_Item,
            vMargin_Item_Issuer,
            vPledge_Item_No,
            vEffective_Date_B,
            vEffective_Date_E,
            vDescription,
            vMemo,
            vBook_No
            ) {
            var obj = {};
            obj['vItem_Id'] = vItem_Id;
            obj['vMargin_Take_Of_Type'] = vMargin_Take_Of_Type;
            obj['vTrad_Partners'] = vTrad_Partners;
            obj['vAmount'] = vAmount;
            obj['vMargin_Item'] = vMargin_Item;
            obj['vMargin_Item_Issuer'] = vMargin_Item_Issuer;
            obj['vPledge_Item_No'] = vPledge_Item_No;
            obj['vEffective_Date_B'] = vEffective_Date_B;
            obj['vEffective_Date_E'] = vEffective_Date_E;
            obj['vDescription'] = vDescription;
            obj['vMemo'] = vMemo;
            obj['vBook_No'] = vBook_No;
            return obj;
        }
        //#endregion function
    });
</script>